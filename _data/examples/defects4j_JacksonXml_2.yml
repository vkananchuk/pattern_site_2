---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: XmlTokenStream
        children: []
        pos: 704
        length: 14
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: public final static int XML_START_ELEMENT = 1;
          children: []
          pos: 762
          length: 46
        - type: field_declaration
          fields:
            text: public final static int XML_END_ELEMENT = 2;
          children: []
          pos: 813
          length: 44
        - type: field_declaration
          fields:
            text: public final static int XML_ATTRIBUTE_NAME = 3;
          children: []
          pos: 862
          length: 47
        - type: field_declaration
          fields:
            text: public final static int XML_ATTRIBUTE_VALUE = 4;
          children: []
          pos: 914
          length: 48
        - type: field_declaration
          fields:
            text: public final static int XML_TEXT = 5;
          children: []
          pos: 967
          length: 37
        - type: field_declaration
          fields:
            text: public final static int XML_END = 6;
          children: []
          pos: 1009
          length: 36
        - type: field_declaration
          fields:
            text: private final static int REPLAY_START_DUP = 1;
          children: []
          pos: 1085
          length: 46
        - type: field_declaration
          fields:
            text: private final static int REPLAY_END = 2;
          children: []
          pos: 1136
          length: 40
        - type: field_declaration
          fields:
            text: private final static int REPLAY_START_DELAYED = 3;
          children: []
          pos: 1181
          length: 50
        - type: field_declaration
          fields:
            text: final protected XMLStreamReader2 _xmlReader;
          children: []
          pos: 1430
          length: 44
        - type: field_declaration
          fields:
            text: final protected Object _sourceReference;
          children: []
          pos: 1480
          length: 40
        - type: field_declaration
          fields:
            text: protected int _currentState;
          children: []
          pos: 1719
          length: 28
        - type: field_declaration
          fields:
            text: protected int _attributeCount;
          children: []
          pos: 1753
          length: 30
        - type: field_declaration
          fields:
            text: protected boolean _mixedText;
          children: []
          pos: 1885
          length: 29
        - type: field_declaration
          fields:
            text: protected int _nextAttributeIndex = 0;
          children: []
          pos: 2096
          length: 38
        - type: field_declaration
          fields:
            text: protected String _localName;
          children: []
          pos: 2140
          length: 28
        - type: field_declaration
          fields:
            text: protected String _namespaceURI;
          children: []
          pos: 2174
          length: 31
        - type: field_declaration
          fields:
            text: protected String _textValue;
          children: []
          pos: 2211
          length: 28
        - type: field_declaration
          fields:
            text: protected int _repeatElement;
          children: []
          pos: 2550
          length: 29
        - type: field_declaration
          fields:
            text: protected ElementWrapper _currentWrapper;
          children: []
          pos: 2653
          length: 41
        - type: field_declaration
          fields:
            text: protected String _nextLocalName;
          children: []
          pos: 2886
          length: 32
        - type: field_declaration
          fields:
            text: protected String _nextNamespaceURI;
          children: []
          pos: 2923
          length: 35
        - type: constructor_declaration
          fields:
            text: |-
              public XmlTokenStream(XMLStreamReader xmlReader, Object sourceRef)
                  {
                      _sourceReference = sourceRef;
                      // Let's ensure we point to START_ELEMENT...
                      if (xmlReader.getEventType() != XMLStreamConstants.START_ELEMENT) {
                          throw new IllegalArgumentException("Invalid XMLStreamReader passed: should be pointing to START_ELEMENT ("
                                  +XMLStreamConstants.START_ELEMENT+"), instead got "+xmlReader.getEventType());
                      }
                      _xmlReader = Stax2ReaderAdapter.wrapIfNecessary(xmlReader);
                      _currentState = XML_START_ELEMENT;
                      _localName = _xmlReader.getLocalName();
                      _namespaceURI = _xmlReader.getNamespaceURI();
                      _attributeCount = _xmlReader.getAttributeCount();
                  }
          children: []
          pos: 3154
          length: 744
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getXmlReader
              children: []
              pos: 3928
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 3904
              length: 73
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _xmlReader;
                children: []
                pos: 3953
                length: 18
              pos: 3943
              length: 34
          children: []
          pos: 3904
          length: 73
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: next
              children: []
              pos: 5155
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5144
              length: 318
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _repeatElement
                            children: []
                            pos: 5200
                            length: 14
                          right:
                            type: decimal_integer_literal
                            fields:
                              text: '0'
                            children: []
                            pos: 5218
                            length: 1
                        children: []
                        pos: 5200
                        length: 19
                    children: []
                    pos: 5199
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return (_currentState = _handleRepeatElement());
                    children: []
                    pos: 5235
                    length: 48
                  pos: 5221
                  length: 72
                pos: 5196
                length: 97
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _next();
                      children: []
                      pos: 5320
                      length: 15
                    pos: 5306
                    length: 39
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (XMLStreamException e) {
                                      StaxUtil.throwXmlAsIOException(e);
                                      return -1;
                                  }
                      children: []
                      pos: 5346
                      length: 110
                    pos: 5302
                    length: 154
                children: []
                pos: 5302
                length: 154
              pos: 5186
              length: 276
          children: []
          pos: 5144
          length: 318
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: skipEndElement
              children: []
              pos: 5484
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5472
              length: 219
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: int type = next();
                children: []
                pos: 5534
                length: 18
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: type
                            children: []
                            pos: 5565
                            length: 4
                          right:
                            type: identifier
                            fields:
                              text: XML_END_ELEMENT
                            children: []
                            pos: 5573
                            length: 15
                        children: []
                        pos: 5565
                        length: 23
                    children: []
                    pos: 5564
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: throw_statement
                    fields:
                      text: throw new IOException("Expected END_ELEMENT, got event
                        of type "+type);
                    children: []
                    pos: 5604
                    length: 71
                  pos: 5590
                  length: 95
                pos: 5561
                length: 124
              pos: 5524
              length: 167
          children: []
          pos: 5472
          length: 219
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getCurrentToken
              children: []
              pos: 5708
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5697
              length: 54
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _currentState;
                children: []
                pos: 5728
                length: 21
              pos: 5726
              length: 25
          children: []
          pos: 5697
          length: 54
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getText
              children: []
              pos: 5771
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5757
              length: 46
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _textValue;
                children: []
                pos: 5783
                length: 18
              pos: 5781
              length: 22
          children: []
          pos: 5757
          length: 46
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getLocalName
              children: []
              pos: 5822
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5808
              length: 51
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _localName;
                children: []
                pos: 5839
                length: 18
              pos: 5837
              length: 22
          children: []
          pos: 5808
          length: 51
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getNamespaceURI
              children: []
              pos: 5878
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5864
              length: 57
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _namespaceURI;
                children: []
                pos: 5898
                length: 21
              pos: 5896
              length: 25
          children: []
          pos: 5864
          length: 57
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: hasAttributes
              children: []
              pos: 5941
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5926
              length: 116
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return (_currentState == XML_START_ELEMENT) && (_attributeCount
                    > 0);
                children: []
                pos: 5967
                length: 69
              pos: 5957
              length: 85
          children: []
          pos: 5926
          length: 116
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: closeCompletely
              children: []
              pos: 6064
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6052
              length: 214
            body:
              type: block
              fields: {}
              children:
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: _xmlReader.closeCompletely();
                      children: []
                      pos: 6133
                      length: 29
                    pos: 6119
                    length: 53
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (XMLStreamException e) {
                                      StaxUtil.throwXmlAsIOException(e);
                                  }
                      children: []
                      pos: 6173
                      length: 87
                    pos: 6115
                    length: 145
                children: []
                pos: 6115
                length: 145
              pos: 6105
              length: 161
          children: []
          pos: 6052
          length: 214
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: close
              children: []
              pos: 6284
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6272
              length: 194
            body:
              type: block
              fields: {}
              children:
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: _xmlReader.close();
                      children: []
                      pos: 6343
                      length: 19
                    pos: 6329
                    length: 43
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (XMLStreamException e) {
                                      StaxUtil.throwXmlAsIOException(e);
                                  }
                      children: []
                      pos: 6373
                      length: 87
                    pos: 6325
                    length: 135
                children: []
                pos: 6325
                length: 135
              pos: 6315
              length: 151
          children: []
          pos: 6272
          length: 194
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getCurrentLocation
              children: []
              pos: 6492
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6472
              length: 132
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _extractLocation(_xmlReader.getLocationInfo().getCurrentLocation());
                children: []
                pos: 6523
                length: 75
              pos: 6513
              length: 91
          children: []
          pos: 6472
          length: 132
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getTokenLocation
              children: []
              pos: 6629
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6609
              length: 128
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _extractLocation(_xmlReader.getLocationInfo().getStartLocation());
                children: []
                pos: 6658
                length: 73
              pos: 6648
              length: 89
          children: []
          pos: 6609
          length: 128
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: repeatStartElement
              children: []
              pos: 7154
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 7139
              length: 788
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentState
                            children: []
                            pos: 7341
                            length: 13
                          right:
                            type: identifier
                            fields:
                              text: XML_START_ELEMENT
                            children: []
                            pos: 7358
                            length: 17
                        children: []
                        pos: 7341
                        length: 34
                    children: []
                    pos: 7340
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: throw_statement
                    fields:
                      text: |-
                        throw new IllegalStateException("Current state not XML_START_ELEMENT ("
                                            +XML_START_ELEMENT+") but "+_currentState);
                    children: []
                    pos: 7391
                    length: 135
                  pos: 7377
                  length: 159
                pos: 7337
                length: 199
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentWrapper
                            children: []
                            pos: 7601
                            length: 15
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 7620
                            length: 4
                        children: []
                        pos: 7601
                        length: 23
                    children: []
                    pos: 7600
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _currentWrapper = ElementWrapper.matchingWrapper(_currentWrapper,
                        _localName, _namespaceURI);
                    children: []
                    pos: 7640
                    length: 93
                  pos: 7626
                  length: 117
                pos: 7597
                length: 281
              - type: expression_statement
                fields:
                  text: _repeatElement = REPLAY_START_DUP;
                children: []
                pos: 7887
                length: 34
              pos: 7179
              length: 748
          children: []
          pos: 7139
          length: 788
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: skipAttributes
              children: []
              pos: 8113
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 8098
              length: 830
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentState
                            children: []
                            pos: 8148
                            length: 13
                          right:
                            type: identifier
                            fields:
                              text: XML_ATTRIBUTE_NAME
                            children: []
                            pos: 8165
                            length: 18
                        children: []
                        pos: 8148
                        length: 35
                    children: []
                    pos: 8147
                    length: 37
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _attributeCount = 0;
                    children: []
                    pos: 8199
                    length: 20
                  - type: expression_statement
                    fields:
                      text: _currentState = XML_START_ELEMENT;
                    children: []
                    pos: 8232
                    length: 34
                  pos: 8185
                  length: 91
                pos: 8144
                length: 778
              pos: 8134
              length: 794
          children: []
          pos: 8098
          length: 830
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: convertToString
              children: []
              pos: 8951
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 8934
              length: 1317
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: _currentState
                                children: []
                                pos: 9087
                                length: 13
                              right:
                                type: identifier
                                fields:
                                  text: XML_ATTRIBUTE_NAME
                                children: []
                                pos: 9104
                                length: 18
                            children: []
                            pos: 9087
                            length: 35
                          right:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: _nextAttributeIndex
                                children: []
                                pos: 9126
                                length: 19
                              right:
                                type: decimal_integer_literal
                                fields:
                                  text: '0'
                                children: []
                                pos: 9149
                                length: 1
                            children: []
                            pos: 9126
                            length: 24
                        children: []
                        pos: 9087
                        length: 63
                    children: []
                    pos: 9086
                    length: 65
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return null;
                    children: []
                    pos: 9166
                    length: 12
                  pos: 9152
                  length: 36
                pos: 9083
                length: 105
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: String text = _collectUntilTag();
                      children: []
                      pos: 9215
                      length: 33
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: equals
                              fields:
                                left:
                                  type: method_invocation
                                  fields:
                                    text: _xmlReader.getEventType()
                                  children: []
                                  pos: 9407
                                  length: 25
                                right:
                                  type: field_access
                                  fields:
                                    text: XMLStreamReader.END_ELEMENT
                                  children: []
                                  pos: 9436
                                  length: 27
                              children: []
                              pos: 9407
                              length: 56
                          children: []
                          pos: 9406
                          length: 58
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: equals
                                  fields:
                                    left:
                                      type: identifier
                                      fields:
                                        text: text
                                      children: []
                                      pos: 9487
                                      length: 4
                                    right:
                                      type: null_literal
                                      fields: {}
                                      children: []
                                      pos: 9495
                                      length: 4
                                  children: []
                                  pos: 9487
                                  length: 12
                              children: []
                              pos: 9486
                              length: 14
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: expression_statement
                              fields:
                                text: text = "";
                              children: []
                              pos: 9523
                              length: 10
                            pos: 9501
                            length: 50
                          pos: 9483
                          length: 68
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: not_equals
                                  fields:
                                    left:
                                      type: identifier
                                      fields:
                                        text: _currentWrapper
                                      children: []
                                      pos: 9572
                                      length: 15
                                    right:
                                      type: null_literal
                                      fields: {}
                                      children: []
                                      pos: 9591
                                      length: 4
                                  children: []
                                  pos: 9572
                                  length: 23
                              children: []
                              pos: 9571
                              length: 25
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: expression_statement
                              fields:
                                text: _currentWrapper = _currentWrapper.getParent();
                              children: []
                              pos: 9619
                              length: 46
                            pos: 9597
                            length: 86
                          pos: 9568
                          length: 115
                        - type: expression_statement
                          fields:
                            text: _localName = _xmlReader.getLocalName();
                          children: []
                          pos: 9791
                          length: 39
                        - type: expression_statement
                          fields:
                            text: _namespaceURI = _xmlReader.getNamespaceURI();
                          children: []
                          pos: 9847
                          length: 45
                        - type: expression_statement
                          fields:
                            text: _attributeCount = 0;
                          children: []
                          pos: 9909
                          length: 20
                        - type: expression_statement
                          fields:
                            text: _currentState = XML_TEXT;
                          children: []
                          pos: 9946
                          length: 25
                        - type: expression_statement
                          fields:
                            text: _textValue = text;
                          children: []
                          pos: 9988
                          length: 18
                        - type: return_statement
                          fields:
                            text: return text;
                          children: []
                          pos: 10023
                          length: 12
                        pos: 9465
                        length: 584
                      pos: 9403
                      length: 646
                    pos: 9201
                    length: 858
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (XMLStreamException e) {
                                      StaxUtil.throwXmlAsIOException(e);
                                  }
                      children: []
                      pos: 10060
                      length: 87
                    pos: 9197
                    length: 950
                children: []
                pos: 9197
                length: 950
              - type: return_statement
                fields:
                  text: return null;
                children: []
                pos: 10233
                length: 12
              pos: 8992
              length: 1259
          children: []
          pos: 8934
          length: 1317
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _next
              children: []
              pos: 10476
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 10458
              length: 2513
            body:
              type: block
              fields: {}
              children:
              - type: switch_expression
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: _currentState
                        children: []
                        pos: 10532
                        length: 13
                    children: []
                    pos: 10531
                    length: 15
                  body:
                    type: switch_block
                    fields:
                      text: |-
                        {
                                case XML_ATTRIBUTE_VALUE:
                                    ++_nextAttributeIndex;
                                    // fall through
                                case XML_START_ELEMENT: // attributes to return?
                                    if (_nextAttributeIndex < _attributeCount) {
                                        _localName = _xmlReader.getAttributeLocalName(_nextAttributeIndex);
                                        _namespaceURI = _xmlReader.getAttributeNamespace(_nextAttributeIndex);
                                        _textValue = _xmlReader.getAttributeValue(_nextAttributeIndex);
                                        return (_currentState = XML_ATTRIBUTE_NAME);
                                    }
                                    // otherwise need to find START/END_ELEMENT or text
                                    String text = _collectUntilTag();
                                    final boolean startElementNext = _xmlReader.getEventType() == XMLStreamReader.START_ELEMENT;
                                    // If we have no/all-whitespace text followed by START_ELEMENT, ignore text
                                    if (startElementNext) {
                                        if (text == null || _allWs(text)) {
                                            _mixedText = false;
                                            return _initStartElement();
                                        }
                                        _mixedText = true;
                                        _textValue = text;
                                        return (_currentState = XML_TEXT);
                                    }
                                    // For END_ELEMENT we will return text, if any
                                    if (text != null) {
                                        _mixedText = false;
                                        _textValue = text;
                                        return (_currentState = XML_TEXT);
                                    }
                                    _mixedText = false;
                                    return _handleEndElement();

                                case XML_ATTRIBUTE_NAME:
                                    // if we just returned name, will need to just send value next
                                    return (_currentState = XML_ATTRIBUTE_VALUE);
                                case XML_TEXT:
                                    // mixed text with other elements
                                    if (_mixedText){
                                        _mixedText = false;
                                        return _initStartElement();
                                    }
                                    // text followed by END_ELEMENT
                                    return _handleEndElement();
                                case XML_END:
                                    return XML_END;
                        //            throw new IllegalStateException("No more XML tokens available (end of input)");
                                }
                    children: []
                    pos: 10547
                    length: 2066
                children: []
                pos: 10524
                length: 2089
              - type: switch_expression
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: _skipUntilTag()
                        children: []
                        pos: 12696
                        length: 15
                    children: []
                    pos: 12695
                    length: 17
                  body:
                    type: switch_block
                    fields:
                      text: |-
                        {
                                case XMLStreamConstants.END_DOCUMENT:
                                    return (_currentState = XML_END);
                                case XMLStreamConstants.END_ELEMENT:
                                    return _handleEndElement();
                                }
                    children: []
                    pos: 12713
                    length: 188
                children: []
                pos: 12688
                length: 213
              - type: return_statement
                fields:
                  text: return _initStartElement();
                children: []
                pos: 12938
                length: 27
              pos: 10514
              length: 2457
          children: []
          pos: 10458
          length: 2513
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _collectUntilTag
              children: []
              pos: 13002
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 12981
              length: 886
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: String text = null;
                children: []
                pos: 13061
                length: 19
              - type: while_statement
                fields:
                  text: |-
                    while (true) {
                                switch (_xmlReader.next()) {
                                case XMLStreamConstants.START_ELEMENT:
                                case XMLStreamConstants.END_ELEMENT:
                                case XMLStreamConstants.END_DOCUMENT:
                                    return text;
                                    // note: SPACE is ignorable (and seldom seen), not to be included
                                case XMLStreamConstants.CHARACTERS:
                                case XMLStreamConstants.CDATA:
                                    if (text == null) {
                                        text = _xmlReader.getText();
                                    } else { // can be optimized in future, if need be:
                                        text += _xmlReader.getText();
                                    }
                                    break;
                                default:
                                    // any other type (proc instr, comment etc) is just ignored
                                }
                            }
                children: []
                pos: 13089
                length: 772
              pos: 13051
              length: 816
          children: []
          pos: 12981
          length: 886
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _skipUntilTag
              children: []
              pos: 13891
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 13873
              length: 577
            body:
              type: block
              fields: {}
              children:
              - type: while_statement
                fields:
                  text: |-
                    while (_xmlReader.hasNext()) {
                                int type;
                                switch (type = _xmlReader.next()) {
                                case XMLStreamConstants.START_ELEMENT:
                                case XMLStreamConstants.END_ELEMENT:
                                case XMLStreamConstants.END_DOCUMENT:
                                    return type;
                                default:
                                    // any other type (proc instr, comment etc) is just ignored
                                }
                            }
                children: []
                pos: 13947
                length: 400
              - type: throw_statement
                fields:
                  text: throw new IllegalStateException("Expected to find a tag, instead
                    reached end of input");
                children: []
                pos: 14356
                length: 88
              pos: 13937
              length: 513
          children: []
          pos: 13873
          length: 577
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _initStartElement
              children: []
              pos: 14681
              length: 17
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 14663
              length: 1486
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: final String ns = _xmlReader.getNamespaceURI();
                children: []
                pos: 14741
                length: 47
              - type: local_variable_declaration
                fields:
                  text: final String localName = _xmlReader.getLocalName();
                children: []
                pos: 14797
                length: 51
              - type: expression_statement
                fields:
                  text: _attributeCount = _xmlReader.getAttributeCount();
                children: []
                pos: 14857
                length: 49
              - type: expression_statement
                fields:
                  text: _nextAttributeIndex = 0;
                children: []
                pos: 14915
                length: 24
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentWrapper
                            children: []
                            pos: 15179
                            length: 15
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 15198
                            length: 4
                        children: []
                        pos: 15179
                        length: 23
                    children: []
                    pos: 15178
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: _currentWrapper.matchesWrapper(localName, ns)
                            children: []
                            pos: 15222
                            length: 45
                        children: []
                        pos: 15221
                        length: 47
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: _currentWrapper = _currentWrapper.intermediateWrapper();
                        children: []
                        pos: 15287
                        length: 56
                      pos: 15269
                      length: 88
                    pos: 15218
                    length: 803
                  pos: 15204
                  length: 827
                pos: 15175
                length: 856
              - type: expression_statement
                fields:
                  text: _localName = localName;
                children: []
                pos: 16040
                length: 23
              - type: expression_statement
                fields:
                  text: _namespaceURI = ns;
                children: []
                pos: 16072
                length: 19
              - type: return_statement
                fields:
                  text: return (_currentState = XML_START_ELEMENT);
                children: []
                pos: 16100
                length: 43
              pos: 14731
              length: 1418
          children: []
          pos: 14663
          length: 1486
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _handleRepeatElement
              children: []
              pos: 16313
              length: 20
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 16299
              length: 1474
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: int type = _repeatElement;
                children: []
                pos: 16370
                length: 26
              - type: expression_statement
                fields:
                  text: _repeatElement = 0;
                children: []
                pos: 16405
                length: 19
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: type
                            children: []
                            pos: 16437
                            length: 4
                          right:
                            type: identifier
                            fields:
                              text: REPLAY_START_DUP
                            children: []
                            pos: 16445
                            length: 16
                        children: []
                        pos: 16437
                        length: 24
                    children: []
                    pos: 16436
                    length: 26
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _currentWrapper = _currentWrapper.intermediateWrapper();
                    children: []
                    pos: 16671
                    length: 56
                  - type: return_statement
                    fields:
                      text: return XML_START_ELEMENT;
                    children: []
                    pos: 16740
                    length: 25
                  pos: 16463
                  length: 312
                pos: 16433
                length: 342
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: type
                            children: []
                            pos: 16788
                            length: 4
                          right:
                            type: identifier
                            fields:
                              text: REPLAY_END
                            children: []
                            pos: 16796
                            length: 10
                        children: []
                        pos: 16788
                        length: 18
                    children: []
                    pos: 16787
                    length: 20
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _localName = _xmlReader.getLocalName();
                    children: []
                    pos: 16924
                    length: 39
                  - type: expression_statement
                    fields:
                      text: _namespaceURI = _xmlReader.getNamespaceURI();
                    children: []
                    pos: 16976
                    length: 45
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: _currentWrapper
                                children: []
                                pos: 17038
                                length: 15
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 17057
                                length: 4
                            children: []
                            pos: 17038
                            length: 23
                        children: []
                        pos: 17037
                        length: 25
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: _currentWrapper = _currentWrapper.getParent();
                        children: []
                        pos: 17081
                        length: 46
                      pos: 17063
                      length: 78
                    pos: 17034
                    length: 107
                  - type: return_statement
                    fields:
                      text: return XML_END_ELEMENT;
                    children: []
                    pos: 17154
                    length: 23
                  pos: 16808
                  length: 379
                pos: 16784
                length: 403
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: type
                            children: []
                            pos: 17200
                            length: 4
                          right:
                            type: identifier
                            fields:
                              text: REPLAY_START_DELAYED
                            children: []
                            pos: 17208
                            length: 20
                        children: []
                        pos: 17200
                        length: 28
                    children: []
                    pos: 17199
                    length: 30
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: _currentWrapper
                                children: []
                                pos: 17248
                                length: 15
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 17267
                                length: 4
                            children: []
                            pos: 17248
                            length: 23
                        children: []
                        pos: 17247
                        length: 25
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: _currentWrapper = _currentWrapper.intermediateWrapper();
                        children: []
                        pos: 17291
                        length: 56
                      pos: 17273
                      length: 88
                    pos: 17244
                    length: 117
                  - type: expression_statement
                    fields:
                      text: _localName = _nextLocalName;
                    children: []
                    pos: 17374
                    length: 28
                  - type: expression_statement
                    fields:
                      text: _namespaceURI = _nextNamespaceURI;
                    children: []
                    pos: 17415
                    length: 34
                  - type: expression_statement
                    fields:
                      text: _nextLocalName = null;
                    children: []
                    pos: 17462
                    length: 22
                  - type: expression_statement
                    fields:
                      text: _nextNamespaceURI = null;
                    children: []
                    pos: 17497
                    length: 25
                  - type: return_statement
                    fields:
                      text: return XML_START_ELEMENT;
                    children: []
                    pos: 17653
                    length: 25
                  pos: 17230
                  length: 458
                pos: 17196
                length: 492
              - type: throw_statement
                fields:
                  text: 'throw new IllegalStateException("Unrecognized type to repeat:
                    "+type);'
                children: []
                pos: 17697
                length: 70
              pos: 16360
              length: 1413
          children: []
          pos: 16299
          length: 1474
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _handleEndElement
              children: []
              pos: 17801
              length: 17
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 17783
              length: 708
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentWrapper
                            children: []
                            pos: 17839
                            length: 15
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 17858
                            length: 4
                        children: []
                        pos: 17839
                        length: 23
                    children: []
                    pos: 17838
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: ElementWrapper w = _currentWrapper;
                    children: []
                    pos: 17878
                    length: 35
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: w.isMatching()
                            children: []
                            pos: 18014
                            length: 14
                        children: []
                        pos: 18013
                        length: 16
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: _repeatElement = REPLAY_END;
                        children: []
                        pos: 18048
                        length: 28
                      - type: expression_statement
                        fields:
                          text: _localName = w.getWrapperLocalName();
                        children: []
                        pos: 18093
                        length: 37
                      - type: expression_statement
                        fields:
                          text: _namespaceURI = w.getWrapperNamespace();
                        children: []
                        pos: 18147
                        length: 40
                      - type: expression_statement
                        fields:
                          text: _currentWrapper = _currentWrapper.getParent();
                        children: []
                        pos: 18204
                        length: 46
                      pos: 18030
                      length: 311
                    pos: 18010
                    length: 415
                  pos: 17864
                  length: 571
                pos: 17835
                length: 600
              - type: return_statement
                fields:
                  text: return (_currentState = XML_END_ELEMENT);
                children: []
                pos: 18444
                length: 41
              pos: 17825
              length: 666
          children: []
          pos: 17783
          length: 708
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _extractLocation
              children: []
              pos: 18522
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: XMLStreamLocation2 location
                children: []
                pos: 18539
                length: 27
              pos: 18501
              length: 413
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: location
                            children: []
                            pos: 18586
                            length: 8
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 18598
                            length: 4
                        children: []
                        pos: 18586
                        length: 16
                    children: []
                    pos: 18585
                    length: 18
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return new JsonLocation(_sourceReference, -1, -1, -1);
                    children: []
                    pos: 18660
                    length: 54
                  pos: 18604
                  length: 120
                pos: 18582
                length: 142
              - type: return_statement
                fields:
                  text: |-
                    return new JsonLocation(_sourceReference,
                                    location.getCharacterOffset(),
                                    location.getLineNumber(),
                                    location.getColumnNumber());
                children: []
                pos: 18733
                length: 175
              pos: 18572
              length: 342
          children: []
          pos: 18501
          length: 413
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _allWs
              children: []
              pos: 18939
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String str
                children: []
                pos: 18946
                length: 10
              pos: 18921
              length: 313
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: 'final int len = (str == null) ? 0 : str.length();'
                children: []
                pos: 18972
                length: 49
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: greater_than
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: len
                            children: []
                            pos: 19034
                            length: 3
                          right:
                            type: decimal_integer_literal
                            fields:
                              text: '0'
                            children: []
                            pos: 19040
                            length: 1
                        children: []
                        pos: 19034
                        length: 7
                    children: []
                    pos: 19033
                    length: 9
                children:
                - type: block
                  fields: {}
                  children:
                  - type: for_statement
                    fields:
                      text: |-
                        for (int i = 0; i < len; ++i) {
                                        if (str.charAt(i) > ' ') {
                                            return false;
                                        }
                                    }
                    children: []
                    pos: 19057
                    length: 140
                  pos: 19043
                  length: 164
                pos: 19030
                length: 177
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 19216
                length: 12
              pos: 18962
              length: 272
          children: []
          pos: 18921
          length: 313
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: toString
              children: []
              pos: 19293
              length: 8
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 19265
              length: 683
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: StringBuilder sb = new StringBuilder();
                children: []
                pos: 19318
                length: 39
              - type: expression_statement
                fields:
                  text: sb.append("(Token stream:");
                children: []
                pos: 19366
                length: 28
              - type: expression_statement
                fields:
                  text: sb.append(" state=").append(_currentState);
                children: []
                pos: 19403
                length: 43
              - type: expression_statement
                fields:
                  text: sb.append(" attr#=").append(_attributeCount);
                children: []
                pos: 19455
                length: 45
              - type: expression_statement
                fields:
                  text: sb.append(" nextAttr#=").append(_nextAttributeIndex);
                children: []
                pos: 19509
                length: 53
              - type: expression_statement
                fields:
                  text: sb.append(" name=").append(_localName);
                children: []
                pos: 19571
                length: 39
              - type: expression_statement
                fields:
                  text: sb.append(" text=").append(_textValue);
                children: []
                pos: 19619
                length: 39
              - type: expression_statement
                fields:
                  text: sb.append(" repeat?=").append(_repeatElement);
                children: []
                pos: 19667
                length: 46
              - type: expression_statement
                fields:
                  text: sb.append(" wrapper=[").append(_currentWrapper);
                children: []
                pos: 19722
                length: 48
              - type: expression_statement
                fields:
                  text: sb.append("] repeatElement=").append(_repeatElement);
                children: []
                pos: 19779
                length: 53
              - type: expression_statement
                fields:
                  text: sb.append(" nextName=").append(_nextLocalName);
                children: []
                pos: 19841
                length: 47
              - type: expression_statement
                fields:
                  text: sb.append(")");
                children: []
                pos: 19897
                length: 15
              - type: return_statement
                fields:
                  text: return sb.toString();
                children: []
                pos: 19921
                length: 21
              pos: 19308
              length: 640
          children: []
          pos: 19265
          length: 683
        pos: 691
        length: 19259
    children: []
    pos: 691
    length: 19259
  pos: 0
  length: 19951
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: XmlTokenStream
        children: []
        pos: 704
        length: 14
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: public final static int XML_START_ELEMENT = 1;
          children: []
          pos: 762
          length: 46
        - type: field_declaration
          fields:
            text: public final static int XML_END_ELEMENT = 2;
          children: []
          pos: 813
          length: 44
        - type: field_declaration
          fields:
            text: public final static int XML_ATTRIBUTE_NAME = 3;
          children: []
          pos: 862
          length: 47
        - type: field_declaration
          fields:
            text: public final static int XML_ATTRIBUTE_VALUE = 4;
          children: []
          pos: 914
          length: 48
        - type: field_declaration
          fields:
            text: public final static int XML_TEXT = 5;
          children: []
          pos: 967
          length: 37
        - type: field_declaration
          fields:
            text: public final static int XML_END = 6;
          children: []
          pos: 1009
          length: 36
        - type: field_declaration
          fields:
            text: private final static int REPLAY_START_DUP = 1;
          children: []
          pos: 1085
          length: 46
        - type: field_declaration
          fields:
            text: private final static int REPLAY_END = 2;
          children: []
          pos: 1136
          length: 40
        - type: field_declaration
          fields:
            text: private final static int REPLAY_START_DELAYED = 3;
          children: []
          pos: 1181
          length: 50
        - type: field_declaration
          fields:
            text: final protected XMLStreamReader2 _xmlReader;
          children: []
          pos: 1430
          length: 44
        - type: field_declaration
          fields:
            text: final protected Object _sourceReference;
          children: []
          pos: 1480
          length: 40
        - type: field_declaration
          fields:
            text: protected int _currentState;
          children: []
          pos: 1719
          length: 28
        - type: field_declaration
          fields:
            text: protected int _attributeCount;
          children: []
          pos: 1753
          length: 30
        - type: field_declaration
          fields:
            text: protected int _nextAttributeIndex = 0;
          children: []
          pos: 2062
          length: 38
        - type: field_declaration
          fields:
            text: protected String _localName;
          children: []
          pos: 2106
          length: 28
        - type: field_declaration
          fields:
            text: protected String _namespaceURI;
          children: []
          pos: 2140
          length: 31
        - type: field_declaration
          fields:
            text: protected String _textValue;
          children: []
          pos: 2177
          length: 28
        - type: field_declaration
          fields:
            text: protected int _repeatElement;
          children: []
          pos: 2516
          length: 29
        - type: field_declaration
          fields:
            text: protected ElementWrapper _currentWrapper;
          children: []
          pos: 2619
          length: 41
        - type: field_declaration
          fields:
            text: protected String _nextLocalName;
          children: []
          pos: 2852
          length: 32
        - type: field_declaration
          fields:
            text: protected String _nextNamespaceURI;
          children: []
          pos: 2889
          length: 35
        - type: constructor_declaration
          fields:
            text: |-
              public XmlTokenStream(XMLStreamReader xmlReader, Object sourceRef)
                  {
                      _sourceReference = sourceRef;
                      // Let's ensure we point to START_ELEMENT...
                      if (xmlReader.getEventType() != XMLStreamConstants.START_ELEMENT) {
                          throw new IllegalArgumentException("Invalid XMLStreamReader passed: should be pointing to START_ELEMENT ("
                                  +XMLStreamConstants.START_ELEMENT+"), instead got "+xmlReader.getEventType());
                      }
                      _xmlReader = Stax2ReaderAdapter.wrapIfNecessary(xmlReader);
                      _currentState = XML_START_ELEMENT;
                      _localName = _xmlReader.getLocalName();
                      _namespaceURI = _xmlReader.getNamespaceURI();
                      _attributeCount = _xmlReader.getAttributeCount();
                  }
          children: []
          pos: 3120
          length: 744
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getXmlReader
              children: []
              pos: 3894
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 3870
              length: 73
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _xmlReader;
                children: []
                pos: 3919
                length: 18
              pos: 3909
              length: 34
          children: []
          pos: 3870
          length: 73
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: next
              children: []
              pos: 5121
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5110
              length: 318
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _repeatElement
                            children: []
                            pos: 5166
                            length: 14
                          right:
                            type: decimal_integer_literal
                            fields:
                              text: '0'
                            children: []
                            pos: 5184
                            length: 1
                        children: []
                        pos: 5166
                        length: 19
                    children: []
                    pos: 5165
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return (_currentState = _handleRepeatElement());
                    children: []
                    pos: 5201
                    length: 48
                  pos: 5187
                  length: 72
                pos: 5162
                length: 97
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _next();
                      children: []
                      pos: 5286
                      length: 15
                    pos: 5272
                    length: 39
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (XMLStreamException e) {
                                      StaxUtil.throwXmlAsIOException(e);
                                      return -1;
                                  }
                      children: []
                      pos: 5312
                      length: 110
                    pos: 5268
                    length: 154
                children: []
                pos: 5268
                length: 154
              pos: 5152
              length: 276
          children: []
          pos: 5110
          length: 318
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: skipEndElement
              children: []
              pos: 5450
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5438
              length: 219
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: int type = next();
                children: []
                pos: 5500
                length: 18
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: type
                            children: []
                            pos: 5531
                            length: 4
                          right:
                            type: identifier
                            fields:
                              text: XML_END_ELEMENT
                            children: []
                            pos: 5539
                            length: 15
                        children: []
                        pos: 5531
                        length: 23
                    children: []
                    pos: 5530
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: throw_statement
                    fields:
                      text: throw new IOException("Expected END_ELEMENT, got event
                        of type "+type);
                    children: []
                    pos: 5570
                    length: 71
                  pos: 5556
                  length: 95
                pos: 5527
                length: 124
              pos: 5490
              length: 167
          children: []
          pos: 5438
          length: 219
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getCurrentToken
              children: []
              pos: 5674
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5663
              length: 54
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _currentState;
                children: []
                pos: 5694
                length: 21
              pos: 5692
              length: 25
          children: []
          pos: 5663
          length: 54
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getText
              children: []
              pos: 5737
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5723
              length: 46
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _textValue;
                children: []
                pos: 5749
                length: 18
              pos: 5747
              length: 22
          children: []
          pos: 5723
          length: 46
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getLocalName
              children: []
              pos: 5788
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5774
              length: 51
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _localName;
                children: []
                pos: 5805
                length: 18
              pos: 5803
              length: 22
          children: []
          pos: 5774
          length: 51
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getNamespaceURI
              children: []
              pos: 5844
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5830
              length: 57
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _namespaceURI;
                children: []
                pos: 5864
                length: 21
              pos: 5862
              length: 25
          children: []
          pos: 5830
          length: 57
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: hasAttributes
              children: []
              pos: 5907
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5892
              length: 116
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return (_currentState == XML_START_ELEMENT) && (_attributeCount
                    > 0);
                children: []
                pos: 5933
                length: 69
              pos: 5923
              length: 85
          children: []
          pos: 5892
          length: 116
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: closeCompletely
              children: []
              pos: 6030
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6018
              length: 214
            body:
              type: block
              fields: {}
              children:
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: _xmlReader.closeCompletely();
                      children: []
                      pos: 6099
                      length: 29
                    pos: 6085
                    length: 53
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (XMLStreamException e) {
                                      StaxUtil.throwXmlAsIOException(e);
                                  }
                      children: []
                      pos: 6139
                      length: 87
                    pos: 6081
                    length: 145
                children: []
                pos: 6081
                length: 145
              pos: 6071
              length: 161
          children: []
          pos: 6018
          length: 214
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: close
              children: []
              pos: 6250
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6238
              length: 194
            body:
              type: block
              fields: {}
              children:
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: _xmlReader.close();
                      children: []
                      pos: 6309
                      length: 19
                    pos: 6295
                    length: 43
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (XMLStreamException e) {
                                      StaxUtil.throwXmlAsIOException(e);
                                  }
                      children: []
                      pos: 6339
                      length: 87
                    pos: 6291
                    length: 135
                children: []
                pos: 6291
                length: 135
              pos: 6281
              length: 151
          children: []
          pos: 6238
          length: 194
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getCurrentLocation
              children: []
              pos: 6458
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6438
              length: 132
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _extractLocation(_xmlReader.getLocationInfo().getCurrentLocation());
                children: []
                pos: 6489
                length: 75
              pos: 6479
              length: 91
          children: []
          pos: 6438
          length: 132
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getTokenLocation
              children: []
              pos: 6595
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6575
              length: 128
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _extractLocation(_xmlReader.getLocationInfo().getStartLocation());
                children: []
                pos: 6624
                length: 73
              pos: 6614
              length: 89
          children: []
          pos: 6575
          length: 128
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: repeatStartElement
              children: []
              pos: 7120
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 7105
              length: 788
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentState
                            children: []
                            pos: 7307
                            length: 13
                          right:
                            type: identifier
                            fields:
                              text: XML_START_ELEMENT
                            children: []
                            pos: 7324
                            length: 17
                        children: []
                        pos: 7307
                        length: 34
                    children: []
                    pos: 7306
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: throw_statement
                    fields:
                      text: |-
                        throw new IllegalStateException("Current state not XML_START_ELEMENT ("
                                            +XML_START_ELEMENT+") but "+_currentState);
                    children: []
                    pos: 7357
                    length: 135
                  pos: 7343
                  length: 159
                pos: 7303
                length: 199
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentWrapper
                            children: []
                            pos: 7567
                            length: 15
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 7586
                            length: 4
                        children: []
                        pos: 7567
                        length: 23
                    children: []
                    pos: 7566
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _currentWrapper = ElementWrapper.matchingWrapper(_currentWrapper,
                        _localName, _namespaceURI);
                    children: []
                    pos: 7606
                    length: 93
                  pos: 7592
                  length: 117
                pos: 7563
                length: 281
              - type: expression_statement
                fields:
                  text: _repeatElement = REPLAY_START_DUP;
                children: []
                pos: 7853
                length: 34
              pos: 7145
              length: 748
          children: []
          pos: 7105
          length: 788
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: skipAttributes
              children: []
              pos: 8079
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 8064
              length: 830
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentState
                            children: []
                            pos: 8114
                            length: 13
                          right:
                            type: identifier
                            fields:
                              text: XML_ATTRIBUTE_NAME
                            children: []
                            pos: 8131
                            length: 18
                        children: []
                        pos: 8114
                        length: 35
                    children: []
                    pos: 8113
                    length: 37
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _attributeCount = 0;
                    children: []
                    pos: 8165
                    length: 20
                  - type: expression_statement
                    fields:
                      text: _currentState = XML_START_ELEMENT;
                    children: []
                    pos: 8198
                    length: 34
                  pos: 8151
                  length: 91
                pos: 8110
                length: 778
              pos: 8100
              length: 794
          children: []
          pos: 8064
          length: 830
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: convertToString
              children: []
              pos: 8917
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 8900
              length: 1317
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: _currentState
                                children: []
                                pos: 9053
                                length: 13
                              right:
                                type: identifier
                                fields:
                                  text: XML_ATTRIBUTE_NAME
                                children: []
                                pos: 9070
                                length: 18
                            children: []
                            pos: 9053
                            length: 35
                          right:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: _nextAttributeIndex
                                children: []
                                pos: 9092
                                length: 19
                              right:
                                type: decimal_integer_literal
                                fields:
                                  text: '0'
                                children: []
                                pos: 9115
                                length: 1
                            children: []
                            pos: 9092
                            length: 24
                        children: []
                        pos: 9053
                        length: 63
                    children: []
                    pos: 9052
                    length: 65
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return null;
                    children: []
                    pos: 9132
                    length: 12
                  pos: 9118
                  length: 36
                pos: 9049
                length: 105
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: String text = _collectUntilTag();
                      children: []
                      pos: 9181
                      length: 33
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: equals
                              fields:
                                left:
                                  type: method_invocation
                                  fields:
                                    text: _xmlReader.getEventType()
                                  children: []
                                  pos: 9373
                                  length: 25
                                right:
                                  type: field_access
                                  fields:
                                    text: XMLStreamReader.END_ELEMENT
                                  children: []
                                  pos: 9402
                                  length: 27
                              children: []
                              pos: 9373
                              length: 56
                          children: []
                          pos: 9372
                          length: 58
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: equals
                                  fields:
                                    left:
                                      type: identifier
                                      fields:
                                        text: text
                                      children: []
                                      pos: 9453
                                      length: 4
                                    right:
                                      type: null_literal
                                      fields: {}
                                      children: []
                                      pos: 9461
                                      length: 4
                                  children: []
                                  pos: 9453
                                  length: 12
                              children: []
                              pos: 9452
                              length: 14
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: expression_statement
                              fields:
                                text: text = "";
                              children: []
                              pos: 9489
                              length: 10
                            pos: 9467
                            length: 50
                          pos: 9449
                          length: 68
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: not_equals
                                  fields:
                                    left:
                                      type: identifier
                                      fields:
                                        text: _currentWrapper
                                      children: []
                                      pos: 9538
                                      length: 15
                                    right:
                                      type: null_literal
                                      fields: {}
                                      children: []
                                      pos: 9557
                                      length: 4
                                  children: []
                                  pos: 9538
                                  length: 23
                              children: []
                              pos: 9537
                              length: 25
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: expression_statement
                              fields:
                                text: _currentWrapper = _currentWrapper.getParent();
                              children: []
                              pos: 9585
                              length: 46
                            pos: 9563
                            length: 86
                          pos: 9534
                          length: 115
                        - type: expression_statement
                          fields:
                            text: _localName = _xmlReader.getLocalName();
                          children: []
                          pos: 9757
                          length: 39
                        - type: expression_statement
                          fields:
                            text: _namespaceURI = _xmlReader.getNamespaceURI();
                          children: []
                          pos: 9813
                          length: 45
                        - type: expression_statement
                          fields:
                            text: _attributeCount = 0;
                          children: []
                          pos: 9875
                          length: 20
                        - type: expression_statement
                          fields:
                            text: _currentState = XML_TEXT;
                          children: []
                          pos: 9912
                          length: 25
                        - type: expression_statement
                          fields:
                            text: _textValue = text;
                          children: []
                          pos: 9954
                          length: 18
                        - type: return_statement
                          fields:
                            text: return text;
                          children: []
                          pos: 9989
                          length: 12
                        pos: 9431
                        length: 584
                      pos: 9369
                      length: 646
                    pos: 9167
                    length: 858
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (XMLStreamException e) {
                                      StaxUtil.throwXmlAsIOException(e);
                                  }
                      children: []
                      pos: 10026
                      length: 87
                    pos: 9163
                    length: 950
                children: []
                pos: 9163
                length: 950
              - type: return_statement
                fields:
                  text: return null;
                children: []
                pos: 10199
                length: 12
              pos: 8958
              length: 1259
          children: []
          pos: 8900
          length: 1317
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _next
              children: []
              pos: 10442
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 10424
              length: 2028
            body:
              type: block
              fields: {}
              children:
              - type: switch_expression
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: _currentState
                        children: []
                        pos: 10498
                        length: 13
                    children: []
                    pos: 10497
                    length: 15
                  body:
                    type: switch_block
                    fields:
                      text: |-
                        {
                                case XML_ATTRIBUTE_VALUE:
                                    ++_nextAttributeIndex;
                                    // fall through
                                case XML_START_ELEMENT: // attributes to return?
                                    if (_nextAttributeIndex < _attributeCount) {
                                        _localName = _xmlReader.getAttributeLocalName(_nextAttributeIndex);
                                        _namespaceURI = _xmlReader.getAttributeNamespace(_nextAttributeIndex);
                                        _textValue = _xmlReader.getAttributeValue(_nextAttributeIndex);
                                        return (_currentState = XML_ATTRIBUTE_NAME);
                                    }
                                    // otherwise need to find START/END_ELEMENT or text
                                    String text = _collectUntilTag();
                                    // If we have no/all-whitespace text followed by START_ELEMENT, ignore text
                                    if (_xmlReader.getEventType() == XMLStreamReader.START_ELEMENT) {
                                            return _initStartElement();
                                    }
                                    // For END_ELEMENT we will return text, if any
                                    if (text != null) {
                                        _textValue = text;
                                        return (_currentState = XML_TEXT);
                                    }
                                    return _handleEndElement();

                                case XML_ATTRIBUTE_NAME:
                                    // if we just returned name, will need to just send value next
                                    return (_currentState = XML_ATTRIBUTE_VALUE);
                                case XML_TEXT:
                                    // mixed text with other elements
                                    // text followed by END_ELEMENT
                                    return _handleEndElement();
                                case XML_END:
                                    return XML_END;
                        //            throw new IllegalStateException("No more XML tokens available (end of input)");
                                }
                    children: []
                    pos: 10513
                    length: 1581
                children: []
                pos: 10490
                length: 1604
              - type: switch_expression
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: _skipUntilTag()
                        children: []
                        pos: 12177
                        length: 15
                    children: []
                    pos: 12176
                    length: 17
                  body:
                    type: switch_block
                    fields:
                      text: |-
                        {
                                case XMLStreamConstants.END_DOCUMENT:
                                    return (_currentState = XML_END);
                                case XMLStreamConstants.END_ELEMENT:
                                    return _handleEndElement();
                                }
                    children: []
                    pos: 12194
                    length: 188
                children: []
                pos: 12169
                length: 213
              - type: return_statement
                fields:
                  text: return _initStartElement();
                children: []
                pos: 12419
                length: 27
              pos: 10480
              length: 1972
          children: []
          pos: 10424
          length: 2028
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _collectUntilTag
              children: []
              pos: 12483
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 12462
              length: 886
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: String text = null;
                children: []
                pos: 12542
                length: 19
              - type: while_statement
                fields:
                  text: |-
                    while (true) {
                                switch (_xmlReader.next()) {
                                case XMLStreamConstants.START_ELEMENT:
                                case XMLStreamConstants.END_ELEMENT:
                                case XMLStreamConstants.END_DOCUMENT:
                                    return text;
                                    // note: SPACE is ignorable (and seldom seen), not to be included
                                case XMLStreamConstants.CHARACTERS:
                                case XMLStreamConstants.CDATA:
                                    if (text == null) {
                                        text = _xmlReader.getText();
                                    } else { // can be optimized in future, if need be:
                                        text += _xmlReader.getText();
                                    }
                                    break;
                                default:
                                    // any other type (proc instr, comment etc) is just ignored
                                }
                            }
                children: []
                pos: 12570
                length: 772
              pos: 12532
              length: 816
          children: []
          pos: 12462
          length: 886
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _skipUntilTag
              children: []
              pos: 13372
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 13354
              length: 577
            body:
              type: block
              fields: {}
              children:
              - type: while_statement
                fields:
                  text: |-
                    while (_xmlReader.hasNext()) {
                                int type;
                                switch (type = _xmlReader.next()) {
                                case XMLStreamConstants.START_ELEMENT:
                                case XMLStreamConstants.END_ELEMENT:
                                case XMLStreamConstants.END_DOCUMENT:
                                    return type;
                                default:
                                    // any other type (proc instr, comment etc) is just ignored
                                }
                            }
                children: []
                pos: 13428
                length: 400
              - type: throw_statement
                fields:
                  text: throw new IllegalStateException("Expected to find a tag, instead
                    reached end of input");
                children: []
                pos: 13837
                length: 88
              pos: 13418
              length: 513
          children: []
          pos: 13354
          length: 577
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _initStartElement
              children: []
              pos: 14162
              length: 17
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 14144
              length: 1486
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: final String ns = _xmlReader.getNamespaceURI();
                children: []
                pos: 14222
                length: 47
              - type: local_variable_declaration
                fields:
                  text: final String localName = _xmlReader.getLocalName();
                children: []
                pos: 14278
                length: 51
              - type: expression_statement
                fields:
                  text: _attributeCount = _xmlReader.getAttributeCount();
                children: []
                pos: 14338
                length: 49
              - type: expression_statement
                fields:
                  text: _nextAttributeIndex = 0;
                children: []
                pos: 14396
                length: 24
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentWrapper
                            children: []
                            pos: 14660
                            length: 15
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 14679
                            length: 4
                        children: []
                        pos: 14660
                        length: 23
                    children: []
                    pos: 14659
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: _currentWrapper.matchesWrapper(localName, ns)
                            children: []
                            pos: 14703
                            length: 45
                        children: []
                        pos: 14702
                        length: 47
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: _currentWrapper = _currentWrapper.intermediateWrapper();
                        children: []
                        pos: 14768
                        length: 56
                      pos: 14750
                      length: 88
                    pos: 14699
                    length: 803
                  pos: 14685
                  length: 827
                pos: 14656
                length: 856
              - type: expression_statement
                fields:
                  text: _localName = localName;
                children: []
                pos: 15521
                length: 23
              - type: expression_statement
                fields:
                  text: _namespaceURI = ns;
                children: []
                pos: 15553
                length: 19
              - type: return_statement
                fields:
                  text: return (_currentState = XML_START_ELEMENT);
                children: []
                pos: 15581
                length: 43
              pos: 14212
              length: 1418
          children: []
          pos: 14144
          length: 1486
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _handleRepeatElement
              children: []
              pos: 15794
              length: 20
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 15780
              length: 1474
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: int type = _repeatElement;
                children: []
                pos: 15851
                length: 26
              - type: expression_statement
                fields:
                  text: _repeatElement = 0;
                children: []
                pos: 15886
                length: 19
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: type
                            children: []
                            pos: 15918
                            length: 4
                          right:
                            type: identifier
                            fields:
                              text: REPLAY_START_DUP
                            children: []
                            pos: 15926
                            length: 16
                        children: []
                        pos: 15918
                        length: 24
                    children: []
                    pos: 15917
                    length: 26
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _currentWrapper = _currentWrapper.intermediateWrapper();
                    children: []
                    pos: 16152
                    length: 56
                  - type: return_statement
                    fields:
                      text: return XML_START_ELEMENT;
                    children: []
                    pos: 16221
                    length: 25
                  pos: 15944
                  length: 312
                pos: 15914
                length: 342
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: type
                            children: []
                            pos: 16269
                            length: 4
                          right:
                            type: identifier
                            fields:
                              text: REPLAY_END
                            children: []
                            pos: 16277
                            length: 10
                        children: []
                        pos: 16269
                        length: 18
                    children: []
                    pos: 16268
                    length: 20
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _localName = _xmlReader.getLocalName();
                    children: []
                    pos: 16405
                    length: 39
                  - type: expression_statement
                    fields:
                      text: _namespaceURI = _xmlReader.getNamespaceURI();
                    children: []
                    pos: 16457
                    length: 45
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: _currentWrapper
                                children: []
                                pos: 16519
                                length: 15
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 16538
                                length: 4
                            children: []
                            pos: 16519
                            length: 23
                        children: []
                        pos: 16518
                        length: 25
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: _currentWrapper = _currentWrapper.getParent();
                        children: []
                        pos: 16562
                        length: 46
                      pos: 16544
                      length: 78
                    pos: 16515
                    length: 107
                  - type: return_statement
                    fields:
                      text: return XML_END_ELEMENT;
                    children: []
                    pos: 16635
                    length: 23
                  pos: 16289
                  length: 379
                pos: 16265
                length: 403
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: type
                            children: []
                            pos: 16681
                            length: 4
                          right:
                            type: identifier
                            fields:
                              text: REPLAY_START_DELAYED
                            children: []
                            pos: 16689
                            length: 20
                        children: []
                        pos: 16681
                        length: 28
                    children: []
                    pos: 16680
                    length: 30
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: _currentWrapper
                                children: []
                                pos: 16729
                                length: 15
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 16748
                                length: 4
                            children: []
                            pos: 16729
                            length: 23
                        children: []
                        pos: 16728
                        length: 25
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: _currentWrapper = _currentWrapper.intermediateWrapper();
                        children: []
                        pos: 16772
                        length: 56
                      pos: 16754
                      length: 88
                    pos: 16725
                    length: 117
                  - type: expression_statement
                    fields:
                      text: _localName = _nextLocalName;
                    children: []
                    pos: 16855
                    length: 28
                  - type: expression_statement
                    fields:
                      text: _namespaceURI = _nextNamespaceURI;
                    children: []
                    pos: 16896
                    length: 34
                  - type: expression_statement
                    fields:
                      text: _nextLocalName = null;
                    children: []
                    pos: 16943
                    length: 22
                  - type: expression_statement
                    fields:
                      text: _nextNamespaceURI = null;
                    children: []
                    pos: 16978
                    length: 25
                  - type: return_statement
                    fields:
                      text: return XML_START_ELEMENT;
                    children: []
                    pos: 17134
                    length: 25
                  pos: 16711
                  length: 458
                pos: 16677
                length: 492
              - type: throw_statement
                fields:
                  text: 'throw new IllegalStateException("Unrecognized type to repeat:
                    "+type);'
                children: []
                pos: 17178
                length: 70
              pos: 15841
              length: 1413
          children: []
          pos: 15780
          length: 1474
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _handleEndElement
              children: []
              pos: 17282
              length: 17
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 17264
              length: 708
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _currentWrapper
                            children: []
                            pos: 17320
                            length: 15
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 17339
                            length: 4
                        children: []
                        pos: 17320
                        length: 23
                    children: []
                    pos: 17319
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: ElementWrapper w = _currentWrapper;
                    children: []
                    pos: 17359
                    length: 35
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: w.isMatching()
                            children: []
                            pos: 17495
                            length: 14
                        children: []
                        pos: 17494
                        length: 16
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: _repeatElement = REPLAY_END;
                        children: []
                        pos: 17529
                        length: 28
                      - type: expression_statement
                        fields:
                          text: _localName = w.getWrapperLocalName();
                        children: []
                        pos: 17574
                        length: 37
                      - type: expression_statement
                        fields:
                          text: _namespaceURI = w.getWrapperNamespace();
                        children: []
                        pos: 17628
                        length: 40
                      - type: expression_statement
                        fields:
                          text: _currentWrapper = _currentWrapper.getParent();
                        children: []
                        pos: 17685
                        length: 46
                      pos: 17511
                      length: 311
                    pos: 17491
                    length: 415
                  pos: 17345
                  length: 571
                pos: 17316
                length: 600
              - type: return_statement
                fields:
                  text: return (_currentState = XML_END_ELEMENT);
                children: []
                pos: 17925
                length: 41
              pos: 17306
              length: 666
          children: []
          pos: 17264
          length: 708
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _extractLocation
              children: []
              pos: 18003
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: XMLStreamLocation2 location
                children: []
                pos: 18020
                length: 27
              pos: 17982
              length: 413
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: location
                            children: []
                            pos: 18067
                            length: 8
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 18079
                            length: 4
                        children: []
                        pos: 18067
                        length: 16
                    children: []
                    pos: 18066
                    length: 18
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return new JsonLocation(_sourceReference, -1, -1, -1);
                    children: []
                    pos: 18141
                    length: 54
                  pos: 18085
                  length: 120
                pos: 18063
                length: 142
              - type: return_statement
                fields:
                  text: |-
                    return new JsonLocation(_sourceReference,
                                    location.getCharacterOffset(),
                                    location.getLineNumber(),
                                    location.getColumnNumber());
                children: []
                pos: 18214
                length: 175
              pos: 18053
              length: 342
          children: []
          pos: 17982
          length: 413
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: toString
              children: []
              pos: 18456
              length: 8
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 18428
              length: 683
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: StringBuilder sb = new StringBuilder();
                children: []
                pos: 18481
                length: 39
              - type: expression_statement
                fields:
                  text: sb.append("(Token stream:");
                children: []
                pos: 18529
                length: 28
              - type: expression_statement
                fields:
                  text: sb.append(" state=").append(_currentState);
                children: []
                pos: 18566
                length: 43
              - type: expression_statement
                fields:
                  text: sb.append(" attr#=").append(_attributeCount);
                children: []
                pos: 18618
                length: 45
              - type: expression_statement
                fields:
                  text: sb.append(" nextAttr#=").append(_nextAttributeIndex);
                children: []
                pos: 18672
                length: 53
              - type: expression_statement
                fields:
                  text: sb.append(" name=").append(_localName);
                children: []
                pos: 18734
                length: 39
              - type: expression_statement
                fields:
                  text: sb.append(" text=").append(_textValue);
                children: []
                pos: 18782
                length: 39
              - type: expression_statement
                fields:
                  text: sb.append(" repeat?=").append(_repeatElement);
                children: []
                pos: 18830
                length: 46
              - type: expression_statement
                fields:
                  text: sb.append(" wrapper=[").append(_currentWrapper);
                children: []
                pos: 18885
                length: 48
              - type: expression_statement
                fields:
                  text: sb.append("] repeatElement=").append(_repeatElement);
                children: []
                pos: 18942
                length: 53
              - type: expression_statement
                fields:
                  text: sb.append(" nextName=").append(_nextLocalName);
                children: []
                pos: 19004
                length: 47
              - type: expression_statement
                fields:
                  text: sb.append(")");
                children: []
                pos: 19060
                length: 15
              - type: return_statement
                fields:
                  text: return sb.toString();
                children: []
                pos: 19084
                length: 21
              pos: 18471
              length: 640
          children: []
          pos: 18428
          length: 683
        pos: 691
        length: 18422
    children: []
    pos: 691
    length: 18422
  pos: 0
  length: 19114
text_diff: "--- before\n+++ after\n@@ -59,7 +59,6 @@\n      *\n      * @since 2.8\n
  \     */\n-    protected boolean _mixedText;\n \n     /**\n      * Index of the
  next attribute of the current START_ELEMENT\n@@ -322,24 +321,15 @@\n             }\n
  \            // otherwise need to find START/END_ELEMENT or text\n             String
  text = _collectUntilTag();\n-            final boolean startElementNext = _xmlReader.getEventType()
  == XMLStreamReader.START_ELEMENT;\n             // If we have no/all-whitespace
  text followed by START_ELEMENT, ignore text\n-            if (startElementNext)
  {\n-                if (text == null || _allWs(text)) {\n-                    _mixedText
  = false;\n+            if (_xmlReader.getEventType() == XMLStreamReader.START_ELEMENT)
  {\n                     return _initStartElement();\n-                }\n-                _mixedText
  = true;\n-                _textValue = text;\n-                return (_currentState
  = XML_TEXT);\n             }\n             // For END_ELEMENT we will return text,
  if any\n             if (text != null) {\n-                _mixedText = false;\n
  \                _textValue = text;\n                 return (_currentState = XML_TEXT);\n
  \            }\n-            _mixedText = false;\n             return _handleEndElement();\n
  \n         case XML_ATTRIBUTE_NAME:\n@@ -347,10 +337,6 @@\n             return (_currentState
  = XML_ATTRIBUTE_VALUE);\n         case XML_TEXT:\n             // mixed text with
  other elements\n-            if (_mixedText){\n-                _mixedText = false;\n-
  \               return _initStartElement();\n-            }\n             // text
  followed by END_ELEMENT\n             return _handleEndElement();\n         case
  XML_END:\n@@ -517,18 +503,6 @@\n     }\n \n \n-    protected boolean _allWs(String
  str)\n-    {\n-        final int len = (str == null) ? 0 : str.length();\n-        if
  (len > 0) {\n-            for (int i = 0; i < len; ++i) {\n-                if (str.charAt(i)
  > ' ') {\n-                    return false;\n-                }\n-            }\n-
  \       }\n-        return true;\n-    }\n     \n     // for DEBUGGING\n     @Override\n"
tree_diff: |+
  New cluster:
  UPDATE from {
          case XML_ATTRIBUTE_VALUE:
              ++_nextAttributeIndex;
              // fall through
          case XML_START_ELEMENT: // attributes to return?
              if (_nextAttributeIndex < _attributeCount) {
                  _localName = _xmlReader.getAttributeLocalName(_nextAttributeIndex);
                  _namespaceURI = _xmlReader.getAttributeNamespace(_nextAttributeIndex);
                  _textValue = _xmlReader.getAttributeValue(_nextAttributeIndex);
                  return (_currentState = XML_ATTRIBUTE_NAME);
              }
              // otherwise need to find START/END_ELEMENT or text
              String text = _collectUntilTag();
              final boolean startElementNext = _xmlReader.getEventType() == XMLStreamReader.START_ELEMENT;
              // If we have no/all-whitespace text followed by START_ELEMENT, ignore text
              if (startElementNext) {
                  if (text == null || _allWs(text)) {
                      _mixedText = false;
                      return _initStartElement();
                  }
                  _mixedText = true;
                  _textValue = text;
                  return (_currentState = XML_TEXT);
              }
              // For END_ELEMENT we will return text, if any
              if (text != null) {
                  _mixedText = false;
                  _textValue = text;
                  return (_currentState = XML_TEXT);
              }
              _mixedText = false;
              return _handleEndElement();

          case XML_ATTRIBUTE_NAME:
              // if we just returned name, will need to just send value next
              return (_currentState = XML_ATTRIBUTE_VALUE);
          case XML_TEXT:
              // mixed text with other elements
              if (_mixedText){
                  _mixedText = false;
                  return _initStartElement();
              }
              // text followed by END_ELEMENT
              return _handleEndElement();
          case XML_END:
              return XML_END;
  //            throw new IllegalStateException("No more XML tokens available (end of input)");
          } to {
          case XML_ATTRIBUTE_VALUE:
              ++_nextAttributeIndex;
              // fall through
          case XML_START_ELEMENT: // attributes to return?
              if (_nextAttributeIndex < _attributeCount) {
                  _localName = _xmlReader.getAttributeLocalName(_nextAttributeIndex);
                  _namespaceURI = _xmlReader.getAttributeNamespace(_nextAttributeIndex);
                  _textValue = _xmlReader.getAttributeValue(_nextAttributeIndex);
                  return (_currentState = XML_ATTRIBUTE_NAME);
              }
              // otherwise need to find START/END_ELEMENT or text
              String text = _collectUntilTag();
              // If we have no/all-whitespace text followed by START_ELEMENT, ignore text
              if (_xmlReader.getEventType() == XMLStreamReader.START_ELEMENT) {
                      return _initStartElement();
              }
              // For END_ELEMENT we will return text, if any
              if (text != null) {
                  _textValue = text;
                  return (_currentState = XML_TEXT);
              }
              return _handleEndElement();

          case XML_ATTRIBUTE_NAME:
              // if we just returned name, will need to just send value next
              return (_currentState = XML_ATTRIBUTE_VALUE);
          case XML_TEXT:
              // mixed text with other elements
              // text followed by END_ELEMENT
              return _handleEndElement();
          case XML_END:
              return XML_END;
  //            throw new IllegalStateException("No more XML tokens available (end of input)");
          }
  ------------
  ===
  update-node
  ---
  switch_block: {
          case XML_ATTRIBUTE_VALUE:
              ++_nextAttributeIndex;
              // fall through
          case XML_START_ELEMENT: // attributes to return?
              if (_nextAttributeIndex < _attributeCount) {
                  _localName = _xmlReader.getAttributeLocalName(_nextAttributeIndex);
                  _namespaceURI = _xmlReader.getAttributeNamespace(_nextAttributeIndex);
                  _textValue = _xmlReader.getAttributeValue(_nextAttributeIndex);
                  return (_currentState = XML_ATTRIBUTE_NAME);
              }
              // otherwise need to find START/END_ELEMENT or text
              String text = _collectUntilTag();
              final boolean startElementNext = _xmlReader.getEventType() == XMLStreamReader.START_ELEMENT;
              // If we have no/all-whitespace text followed by START_ELEMENT, ignore text
              if (startElementNext) {
                  if (text == null || _allWs(text)) {
                      _mixedText = false;
                      return _initStartElement();
                  }
                  _mixedText = true;
                  _textValue = text;
                  return (_currentState = XML_TEXT);
              }
              // For END_ELEMENT we will return text, if any
              if (text != null) {
                  _mixedText = false;
                  _textValue = text;
                  return (_currentState = XML_TEXT);
              }
              _mixedText = false;
              return _handleEndElement();

          case XML_ATTRIBUTE_NAME:
              // if we just returned name, will need to just send value next
              return (_currentState = XML_ATTRIBUTE_VALUE);
          case XML_TEXT:
              // mixed text with other elements
              if (_mixedText){
                  _mixedText = false;
                  return _initStartElement();
              }
              // text followed by END_ELEMENT
              return _handleEndElement();
          case XML_END:
              return XML_END;
  //            throw new IllegalStateException("No more XML tokens available (end of input)");
          } [10547,12613]
  replace {
          case XML_ATTRIBUTE_VALUE:
              ++_nextAttributeIndex;
              // fall through
          case XML_START_ELEMENT: // attributes to return?
              if (_nextAttributeIndex < _attributeCount) {
                  _localName = _xmlReader.getAttributeLocalName(_nextAttributeIndex);
                  _namespaceURI = _xmlReader.getAttributeNamespace(_nextAttributeIndex);
                  _textValue = _xmlReader.getAttributeValue(_nextAttributeIndex);
                  return (_currentState = XML_ATTRIBUTE_NAME);
              }
              // otherwise need to find START/END_ELEMENT or text
              String text = _collectUntilTag();
              final boolean startElementNext = _xmlReader.getEventType() == XMLStreamReader.START_ELEMENT;
              // If we have no/all-whitespace text followed by START_ELEMENT, ignore text
              if (startElementNext) {
                  if (text == null || _allWs(text)) {
                      _mixedText = false;
                      return _initStartElement();
                  }
                  _mixedText = true;
                  _textValue = text;
                  return (_currentState = XML_TEXT);
              }
              // For END_ELEMENT we will return text, if any
              if (text != null) {
                  _mixedText = false;
                  _textValue = text;
                  return (_currentState = XML_TEXT);
              }
              _mixedText = false;
              return _handleEndElement();

          case XML_ATTRIBUTE_NAME:
              // if we just returned name, will need to just send value next
              return (_currentState = XML_ATTRIBUTE_VALUE);
          case XML_TEXT:
              // mixed text with other elements
              if (_mixedText){
                  _mixedText = false;
                  return _initStartElement();
              }
              // text followed by END_ELEMENT
              return _handleEndElement();
          case XML_END:
              return XML_END;
  //            throw new IllegalStateException("No more XML tokens available (end of input)");
          } by {
          case XML_ATTRIBUTE_VALUE:
              ++_nextAttributeIndex;
              // fall through
          case XML_START_ELEMENT: // attributes to return?
              if (_nextAttributeIndex < _attributeCount) {
                  _localName = _xmlReader.getAttributeLocalName(_nextAttributeIndex);
                  _namespaceURI = _xmlReader.getAttributeNamespace(_nextAttributeIndex);
                  _textValue = _xmlReader.getAttributeValue(_nextAttributeIndex);
                  return (_currentState = XML_ATTRIBUTE_NAME);
              }
              // otherwise need to find START/END_ELEMENT or text
              String text = _collectUntilTag();
              // If we have no/all-whitespace text followed by START_ELEMENT, ignore text
              if (_xmlReader.getEventType() == XMLStreamReader.START_ELEMENT) {
                      return _initStartElement();
              }
              // For END_ELEMENT we will return text, if any
              if (text != null) {
                  _textValue = text;
                  return (_currentState = XML_TEXT);
              }
              return _handleEndElement();

          case XML_ATTRIBUTE_NAME:
              // if we just returned name, will need to just send value next
              return (_currentState = XML_ATTRIBUTE_VALUE);
          case XML_TEXT:
              // mixed text with other elements
              // text followed by END_ELEMENT
              return _handleEndElement();
          case XML_END:
              return XML_END;
  //            throw new IllegalStateException("No more XML tokens available (end of input)");
          }

  New cluster:
  ===
  delete-node
  ---
  field_declaration: protected boolean _mixedText; [1885,1914]
  ===
  ------------
  ===
  delete-node
  ---
  field_declaration: protected boolean _mixedText; [1885,1914]
  ===

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  method_declaration [18921,19234]
      identifier: _allWs [18939,18945]
      method_parameters [18921,19234]
          formal_parameter: String str [18946,18956]
      block [18962,19234]
          local_variable_declaration: final int len = (str == null) ? 0 : str.length(); [18972,19021]
          if_statement [19030,19207]
              parenthesized_expression [19033,19042]
                  greater_than [19034,19041]
                      identifier: len [19034,19037]
                      decimal_integer_literal: 0 [19040,19041]
              block [19043,19207]
                  for_statement: for (int i = 0; i < len; ++i) {
                  if (str.charAt(i) > ' ') {
                      return false;
                  }
              } [19057,19197]
          return_statement: return true; [19216,19228]

...
