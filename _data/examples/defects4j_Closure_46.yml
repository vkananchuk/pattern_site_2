---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: RecordType
        children: []
        pos: 2509
        length: 10
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private static final long serialVersionUID = 1L;
          children: []
          pos: 2552
          length: 48
        - type: field_declaration
          fields:
            text: private final SortedMap<String, JSType> properties = Maps.newTreeMap();
          children: []
          pos: 2604
          length: 71
        - type: field_declaration
          fields:
            text: private boolean isFrozen = false;
          children: []
          pos: 2678
          length: 33
        - type: constructor_declaration
          fields:
            text: |-
              RecordType(JSTypeRegistry registry, Map<String, RecordProperty> properties) {
                  super(registry, null, null);
                  setPrettyPrint(true);

                  for (String property : properties.keySet()) {
                    RecordProperty prop = properties.get(property);
                    if (prop == null) {
                      throw new IllegalStateException(
                          "RecordProperty associated with a property should not be null!");
                    }
                    defineDeclaredProperty(property, prop.getType(), prop.getPropertyNode());
                  }

                  // Freeze the record type.
                  isFrozen = true;
                }
          children: []
          pos: 3014
          length: 537
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: isEquivalentTo
              children: []
              pos: 3582
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JSType other
                children: []
                pos: 3597
                length: 12
              pos: 3555
              length: 596
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!other.isRecordType()"
                        children: []
                        pos: 3621
                        length: 21
                    children: []
                    pos: 3620
                    length: 23
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 3652
                    length: 13
                  pos: 3644
                  length: 27
                pos: 3617
                length: 54
              - type: local_variable_declaration
                fields:
                  text: RecordType otherRecord = other.toMaybeRecordType();
                children: []
                pos: 3704
                length: 51
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: otherRecord
                            children: []
                            pos: 3764
                            length: 11
                          right:
                            type: this
                            fields: {}
                            children: []
                            pos: 3779
                            length: 4
                        children: []
                        pos: 3764
                        length: 19
                    children: []
                    pos: 3763
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return true;
                    children: []
                    pos: 3793
                    length: 12
                  pos: 3785
                  length: 26
                pos: 3760
                length: 51
              - type: local_variable_declaration
                fields:
                  text: Set<String> keySet = properties.keySet();
                children: []
                pos: 3817
                length: 41
              - type: local_variable_declaration
                fields:
                  text: Map<String, JSType> otherProps = otherRecord.properties;
                children: []
                pos: 3863
                length: 56
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!otherProps.keySet().equals(keySet)"
                        children: []
                        pos: 3928
                        length: 35
                    children: []
                    pos: 3927
                    length: 37
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 3973
                    length: 13
                  pos: 3965
                  length: 27
                pos: 3924
                length: 68
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (String key : keySet) {
                          if (!otherProps.get(key).isEquivalentTo(properties.get(key))) {
                            return false;
                          }
                        }
                children: []
                pos: 3997
                length: 133
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 4135
                length: 12
              pos: 3611
              length: 540
          children: []
          pos: 3555
          length: 596
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getImplicitPrototype
              children: []
              pos: 4185
              length: 20
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 4155
              length: 125
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return registry.getNativeObjectType(JSTypeNative.OBJECT_TYPE);
                children: []
                pos: 4214
                length: 62
              pos: 4208
              length: 72
          children: []
          pos: 4155
          length: 125
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: defineProperty
              children: []
              pos: 4304
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String propertyName
                children: []
                pos: 4319
                length: 19
              pos: 4284
              length: 319
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: isFrozen
                        children: []
                        pos: 4406
                        length: 8
                    children: []
                    pos: 4405
                    length: 10
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 4424
                    length: 13
                  pos: 4416
                  length: 27
                pos: 4402
                length: 41
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!inferred"
                        children: []
                        pos: 4453
                        length: 9
                    children: []
                    pos: 4452
                    length: 11
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: properties.put(propertyName, type);
                    children: []
                    pos: 4472
                    length: 35
                  pos: 4464
                  length: 49
                pos: 4449
                length: 64
              - type: return_statement
                fields:
                  text: |-
                    return super.defineProperty(propertyName, type, inferred,
                            propertyNode);
                children: []
                pos: 4519
                length: 80
              pos: 4396
              length: 207
          children: []
          pos: 4284
          length: 319
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getGreatestSubtypeHelper
              children: []
              pos: 4614
              length: 24
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JSType that
                children: []
                pos: 4639
                length: 11
              pos: 4607
              length: 2525
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: that.isRecordType()
                        children: []
                        pos: 4662
                        length: 19
                    children: []
                    pos: 4661
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: RecordType thatRecord = that.toMaybeRecordType();
                    children: []
                    pos: 4691
                    length: 49
                  - type: local_variable_declaration
                    fields:
                      text: RecordTypeBuilder builder = new RecordTypeBuilder(registry);
                    children: []
                    pos: 4747
                    length: 60
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (String property : properties.keySet()) {
                                if (thatRecord.hasProperty(property) &&
                                    !thatRecord.getPropertyType(property).isEquivalentTo(
                                        getPropertyType(property))) {
                                  return registry.getNativeObjectType(JSTypeNative.NO_TYPE);
                                }

                                builder.addProperty(property, getPropertyType(property),
                                    getPropertyNode(property));
                              }
                    children: []
                    pos: 4985
                    length: 398
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (String property : thatRecord.properties.keySet()) {
                                if (!hasProperty(property)) {
                                  builder.addProperty(property, thatRecord.getPropertyType(property),
                                      thatRecord.getPropertyNode(property));
                                }
                              }
                    children: []
                    pos: 5391
                    length: 243
                  - type: return_statement
                    fields:
                      text: return builder.build();
                    children: []
                    pos: 5642
                    length: 23
                  pos: 4683
                  length: 988
                pos: 4658
                length: 1013
              - type: local_variable_declaration
                fields:
                  text: |-
                    JSType greatestSubtype = registry.getNativeType(
                            JSTypeNative.NO_OBJECT_TYPE);
                children: []
                pos: 5677
                length: 86
              - type: local_variable_declaration
                fields:
                  text: |-
                    JSType thatRestrictedToObj =
                            registry.getNativeType(JSTypeNative.OBJECT_TYPE)
                            .getGreatestSubtype(that);
                children: []
                pos: 5768
                length: 120
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!thatRestrictedToObj.isEmptyType()"
                        children: []
                        pos: 5897
                        length: 34
                    children: []
                    pos: 5896
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Map.Entry<String, JSType> entry : properties.entrySet()) {
                                String propName = entry.getKey();
                                JSType propType = entry.getValue();
                                UnionTypeBuilder builder = new UnionTypeBuilder(registry);
                                for (ObjectType alt :
                                         registry.getEachReferenceTypeWithProperty(propName)) {
                                  JSType altPropType = alt.getPropertyType(propName);
                                  if (altPropType != null && !alt.isEquivalentTo(this) &&
                                      alt.isSubtype(that) &&
                                      (propType.isUnknownType() || altPropType.isUnknownType() ||
                                          altPropType.isEquivalentTo(propType))) {
                                    builder.addAlternate(alt);
                                  }
                                }
                                greatestSubtype = greatestSubtype.getLeastSupertype(builder.build());
                              }
                    children: []
                    pos: 6331
                    length: 763
                  pos: 5933
                  length: 1167
                pos: 5893
                length: 1207
              - type: return_statement
                fields:
                  text: return greatestSubtype;
                children: []
                pos: 7105
                length: 23
              pos: 4652
              length: 2480
          children: []
          pos: 4607
          length: 2525
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: toMaybeRecordType
              children: []
              pos: 7159
              length: 17
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 7136
              length: 65
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return this;
                children: []
                pos: 7185
                length: 12
              pos: 7179
              length: 22
          children: []
          pos: 7136
          length: 65
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: isSubtype
              children: []
              pos: 7232
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JSType that
                children: []
                pos: 7242
                length: 11
              pos: 7205
              length: 612
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: JSType.isSubtypeHelper(this, that)
                        children: []
                        pos: 7265
                        length: 34
                    children: []
                    pos: 7264
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return true;
                    children: []
                    pos: 7309
                    length: 12
                  pos: 7301
                  length: 26
                pos: 7261
                length: 66
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: |-
                            registry.getNativeObjectType(
                                        JSTypeNative.OBJECT_TYPE).isSubtype(that)
                        children: []
                        pos: 7405
                        length: 83
                    children: []
                    pos: 7404
                    length: 85
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return true;
                    children: []
                    pos: 7498
                    length: 12
                  pos: 7490
                  length: 26
                pos: 7401
                length: 115
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!that.isRecordType()"
                        children: []
                        pos: 7698
                        length: 20
                    children: []
                    pos: 7697
                    length: 22
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 7728
                    length: 13
                  pos: 7720
                  length: 27
                pos: 7694
                length: 53
              - type: return_statement
                fields:
                  text: return RecordType.isSubtype(this, that.toMaybeRecordType());
                children: []
                pos: 7753
                length: 60
              pos: 7255
              length: 562
          children: []
          pos: 7205
          length: 612
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: isSubtype
              children: []
              pos: 7887
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: ObjectType typeA
                children: []
                pos: 7897
                length: 16
              pos: 7872
              length: 1502
            body:
              type: block
              fields: {}
              children:
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (String property : typeB.properties.keySet()) {
                          if (!typeA.hasProperty(property)) {
                            return false;
                          }

                          JSType propA = typeA.getPropertyType(property);
                          JSType propB = typeB.getPropertyType(property);
                          if (!propA.isUnknownType() && !propB.isUnknownType()) {
                            if (typeA.isPropertyTypeDeclared(property)) {
                              if (!propA.isEquivalentTo(propB)) {
                                return false;
                              }
                            } else {
                              if (!propA.isSubtype(propB)) {
                                return false;
                              }
                            }
                          }
                        }
                children: []
                pos: 8800
                length: 552
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 9358
                length: 12
              pos: 7933
              length: 1441
          children: []
          pos: 7872
          length: 1502
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: resolveInternal
              children: []
              pos: 9397
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: ErrorReporter t
                children: []
                pos: 9413
                length: 15
              pos: 9378
              length: 388
            body:
              type: block
              fields: {}
              children:
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (Map.Entry<String, JSType> entry : properties.entrySet()) {
                          JSType type = entry.getValue();
                          JSType resolvedType = type.resolve(t, scope);
                          if (type != resolvedType) {
                            properties.put(entry.getKey(), resolvedType);
                          }
                        }
                children: []
                pos: 9463
                length: 255
              - type: return_statement
                fields:
                  text: return super.resolveInternal(t, scope);
                children: []
                pos: 9723
                length: 39
              pos: 9457
              length: 309
          children: []
          pos: 9378
          length: 388
        pos: 2503
        length: 7265
    children: []
    pos: 2503
    length: 7265
  pos: 0
  length: 9769
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: RecordType
        children: []
        pos: 2509
        length: 10
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private static final long serialVersionUID = 1L;
          children: []
          pos: 2552
          length: 48
        - type: field_declaration
          fields:
            text: private final SortedMap<String, JSType> properties = Maps.newTreeMap();
          children: []
          pos: 2604
          length: 71
        - type: field_declaration
          fields:
            text: private boolean isFrozen = false;
          children: []
          pos: 2678
          length: 33
        - type: constructor_declaration
          fields:
            text: |-
              RecordType(JSTypeRegistry registry, Map<String, RecordProperty> properties) {
                  super(registry, null, null);
                  setPrettyPrint(true);

                  for (String property : properties.keySet()) {
                    RecordProperty prop = properties.get(property);
                    if (prop == null) {
                      throw new IllegalStateException(
                          "RecordProperty associated with a property should not be null!");
                    }
                    defineDeclaredProperty(property, prop.getType(), prop.getPropertyNode());
                  }

                  // Freeze the record type.
                  isFrozen = true;
                }
          children: []
          pos: 3014
          length: 537
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: isEquivalentTo
              children: []
              pos: 3582
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JSType other
                children: []
                pos: 3597
                length: 12
              pos: 3555
              length: 596
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!other.isRecordType()"
                        children: []
                        pos: 3621
                        length: 21
                    children: []
                    pos: 3620
                    length: 23
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 3652
                    length: 13
                  pos: 3644
                  length: 27
                pos: 3617
                length: 54
              - type: local_variable_declaration
                fields:
                  text: RecordType otherRecord = other.toMaybeRecordType();
                children: []
                pos: 3704
                length: 51
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: otherRecord
                            children: []
                            pos: 3764
                            length: 11
                          right:
                            type: this
                            fields: {}
                            children: []
                            pos: 3779
                            length: 4
                        children: []
                        pos: 3764
                        length: 19
                    children: []
                    pos: 3763
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return true;
                    children: []
                    pos: 3793
                    length: 12
                  pos: 3785
                  length: 26
                pos: 3760
                length: 51
              - type: local_variable_declaration
                fields:
                  text: Set<String> keySet = properties.keySet();
                children: []
                pos: 3817
                length: 41
              - type: local_variable_declaration
                fields:
                  text: Map<String, JSType> otherProps = otherRecord.properties;
                children: []
                pos: 3863
                length: 56
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!otherProps.keySet().equals(keySet)"
                        children: []
                        pos: 3928
                        length: 35
                    children: []
                    pos: 3927
                    length: 37
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 3973
                    length: 13
                  pos: 3965
                  length: 27
                pos: 3924
                length: 68
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (String key : keySet) {
                          if (!otherProps.get(key).isEquivalentTo(properties.get(key))) {
                            return false;
                          }
                        }
                children: []
                pos: 3997
                length: 133
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 4135
                length: 12
              pos: 3611
              length: 540
          children: []
          pos: 3555
          length: 596
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getImplicitPrototype
              children: []
              pos: 4185
              length: 20
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 4155
              length: 125
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return registry.getNativeObjectType(JSTypeNative.OBJECT_TYPE);
                children: []
                pos: 4214
                length: 62
              pos: 4208
              length: 72
          children: []
          pos: 4155
          length: 125
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: defineProperty
              children: []
              pos: 4304
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String propertyName
                children: []
                pos: 4319
                length: 19
              pos: 4284
              length: 319
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: isFrozen
                        children: []
                        pos: 4406
                        length: 8
                    children: []
                    pos: 4405
                    length: 10
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 4424
                    length: 13
                  pos: 4416
                  length: 27
                pos: 4402
                length: 41
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!inferred"
                        children: []
                        pos: 4453
                        length: 9
                    children: []
                    pos: 4452
                    length: 11
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: properties.put(propertyName, type);
                    children: []
                    pos: 4472
                    length: 35
                  pos: 4464
                  length: 49
                pos: 4449
                length: 64
              - type: return_statement
                fields:
                  text: |-
                    return super.defineProperty(propertyName, type, inferred,
                            propertyNode);
                children: []
                pos: 4519
                length: 80
              pos: 4396
              length: 207
          children: []
          pos: 4284
          length: 319
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getLeastSupertype
              children: []
              pos: 4633
              length: 17
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JSType that
                children: []
                pos: 4651
                length: 11
              pos: 4607
              length: 587
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!that.isRecordType()"
                        children: []
                        pos: 4674
                        length: 20
                    children: []
                    pos: 4673
                    length: 22
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return super.getLeastSupertype(that);
                    children: []
                    pos: 4704
                    length: 37
                  pos: 4696
                  length: 51
                pos: 4670
                length: 77
              - type: local_variable_declaration
                fields:
                  text: RecordTypeBuilder builder = new RecordTypeBuilder(registry);
                children: []
                pos: 4752
                length: 60
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (String property : properties.keySet()) {
                          if (that.toMaybeRecordType().hasProperty(property) &&
                              that.toMaybeRecordType().getPropertyType(property).isEquivalentTo(
                                  getPropertyType(property))) {
                            builder.addProperty(property, getPropertyType(property),
                                getPropertyNode(property));
                          }
                        }
                children: []
                pos: 4817
                length: 345
              - type: return_statement
                fields:
                  text: return builder.build();
                children: []
                pos: 5167
                length: 23
              pos: 4664
              length: 530
          children: []
          pos: 4607
          length: 587
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getGreatestSubtypeHelper
              children: []
              pos: 5204
              length: 24
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JSType that
                children: []
                pos: 5229
                length: 11
              pos: 5197
              length: 2525
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: that.isRecordType()
                        children: []
                        pos: 5252
                        length: 19
                    children: []
                    pos: 5251
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: RecordType thatRecord = that.toMaybeRecordType();
                    children: []
                    pos: 5281
                    length: 49
                  - type: local_variable_declaration
                    fields:
                      text: RecordTypeBuilder builder = new RecordTypeBuilder(registry);
                    children: []
                    pos: 5337
                    length: 60
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (String property : properties.keySet()) {
                                if (thatRecord.hasProperty(property) &&
                                    !thatRecord.getPropertyType(property).isEquivalentTo(
                                        getPropertyType(property))) {
                                  return registry.getNativeObjectType(JSTypeNative.NO_TYPE);
                                }

                                builder.addProperty(property, getPropertyType(property),
                                    getPropertyNode(property));
                              }
                    children: []
                    pos: 5575
                    length: 398
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (String property : thatRecord.properties.keySet()) {
                                if (!hasProperty(property)) {
                                  builder.addProperty(property, thatRecord.getPropertyType(property),
                                      thatRecord.getPropertyNode(property));
                                }
                              }
                    children: []
                    pos: 5981
                    length: 243
                  - type: return_statement
                    fields:
                      text: return builder.build();
                    children: []
                    pos: 6232
                    length: 23
                  pos: 5273
                  length: 988
                pos: 5248
                length: 1013
              - type: local_variable_declaration
                fields:
                  text: |-
                    JSType greatestSubtype = registry.getNativeType(
                            JSTypeNative.NO_OBJECT_TYPE);
                children: []
                pos: 6267
                length: 86
              - type: local_variable_declaration
                fields:
                  text: |-
                    JSType thatRestrictedToObj =
                            registry.getNativeType(JSTypeNative.OBJECT_TYPE)
                            .getGreatestSubtype(that);
                children: []
                pos: 6358
                length: 120
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!thatRestrictedToObj.isEmptyType()"
                        children: []
                        pos: 6487
                        length: 34
                    children: []
                    pos: 6486
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Map.Entry<String, JSType> entry : properties.entrySet()) {
                                String propName = entry.getKey();
                                JSType propType = entry.getValue();
                                UnionTypeBuilder builder = new UnionTypeBuilder(registry);
                                for (ObjectType alt :
                                         registry.getEachReferenceTypeWithProperty(propName)) {
                                  JSType altPropType = alt.getPropertyType(propName);
                                  if (altPropType != null && !alt.isEquivalentTo(this) &&
                                      alt.isSubtype(that) &&
                                      (propType.isUnknownType() || altPropType.isUnknownType() ||
                                          altPropType.isEquivalentTo(propType))) {
                                    builder.addAlternate(alt);
                                  }
                                }
                                greatestSubtype = greatestSubtype.getLeastSupertype(builder.build());
                              }
                    children: []
                    pos: 6921
                    length: 763
                  pos: 6523
                  length: 1167
                pos: 6483
                length: 1207
              - type: return_statement
                fields:
                  text: return greatestSubtype;
                children: []
                pos: 7695
                length: 23
              pos: 5242
              length: 2480
          children: []
          pos: 5197
          length: 2525
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: toMaybeRecordType
              children: []
              pos: 7749
              length: 17
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 7726
              length: 65
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return this;
                children: []
                pos: 7775
                length: 12
              pos: 7769
              length: 22
          children: []
          pos: 7726
          length: 65
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: isSubtype
              children: []
              pos: 7822
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JSType that
                children: []
                pos: 7832
                length: 11
              pos: 7795
              length: 612
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: JSType.isSubtypeHelper(this, that)
                        children: []
                        pos: 7855
                        length: 34
                    children: []
                    pos: 7854
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return true;
                    children: []
                    pos: 7899
                    length: 12
                  pos: 7891
                  length: 26
                pos: 7851
                length: 66
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: |-
                            registry.getNativeObjectType(
                                        JSTypeNative.OBJECT_TYPE).isSubtype(that)
                        children: []
                        pos: 7995
                        length: 83
                    children: []
                    pos: 7994
                    length: 85
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return true;
                    children: []
                    pos: 8088
                    length: 12
                  pos: 8080
                  length: 26
                pos: 7991
                length: 115
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!that.isRecordType()"
                        children: []
                        pos: 8288
                        length: 20
                    children: []
                    pos: 8287
                    length: 22
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 8318
                    length: 13
                  pos: 8310
                  length: 27
                pos: 8284
                length: 53
              - type: return_statement
                fields:
                  text: return RecordType.isSubtype(this, that.toMaybeRecordType());
                children: []
                pos: 8343
                length: 60
              pos: 7845
              length: 562
          children: []
          pos: 7795
          length: 612
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: isSubtype
              children: []
              pos: 8477
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: ObjectType typeA
                children: []
                pos: 8487
                length: 16
              pos: 8462
              length: 1502
            body:
              type: block
              fields: {}
              children:
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (String property : typeB.properties.keySet()) {
                          if (!typeA.hasProperty(property)) {
                            return false;
                          }

                          JSType propA = typeA.getPropertyType(property);
                          JSType propB = typeB.getPropertyType(property);
                          if (!propA.isUnknownType() && !propB.isUnknownType()) {
                            if (typeA.isPropertyTypeDeclared(property)) {
                              if (!propA.isEquivalentTo(propB)) {
                                return false;
                              }
                            } else {
                              if (!propA.isSubtype(propB)) {
                                return false;
                              }
                            }
                          }
                        }
                children: []
                pos: 9390
                length: 552
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 9948
                length: 12
              pos: 8523
              length: 1441
          children: []
          pos: 8462
          length: 1502
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: resolveInternal
              children: []
              pos: 9987
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: ErrorReporter t
                children: []
                pos: 10003
                length: 15
              pos: 9968
              length: 388
            body:
              type: block
              fields: {}
              children:
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (Map.Entry<String, JSType> entry : properties.entrySet()) {
                          JSType type = entry.getValue();
                          JSType resolvedType = type.resolve(t, scope);
                          if (type != resolvedType) {
                            properties.put(entry.getKey(), resolvedType);
                          }
                        }
                children: []
                pos: 10053
                length: 255
              - type: return_statement
                fields:
                  text: return super.resolveInternal(t, scope);
                children: []
                pos: 10313
                length: 39
              pos: 10047
              length: 309
          children: []
          pos: 9968
          length: 388
        pos: 2503
        length: 7855
    children: []
    pos: 2503
    length: 7855
  pos: 0
  length: 10359
text_diff: "--- before\n+++ after\n@@ -137,6 +137,22 @@\n         propertyNode);\n
  \  }\n \n+  @Override\n+  public JSType getLeastSupertype(JSType that) {\n+    if
  (!that.isRecordType()) {\n+      return super.getLeastSupertype(that);\n+    }\n+
  \   RecordTypeBuilder builder = new RecordTypeBuilder(registry);\n+    for (String
  property : properties.keySet()) {\n+      if (that.toMaybeRecordType().hasProperty(property)
  &&\n+          that.toMaybeRecordType().getPropertyType(property).isEquivalentTo(\n+
  \             getPropertyType(property))) {\n+        builder.addProperty(property,
  getPropertyType(property),\n+            getPropertyNode(property));\n+      }\n+
  \   }\n+    return builder.build();\n+  }\n   JSType getGreatestSubtypeHelper(JSType
  that) {\n     if (that.isRecordType()) {\n       RecordType thatRecord = that.toMaybeRecordType();\n"
tree_diff: |+
  New cluster:
  Unknown cluster type
  ------------
  ===
  insert-tree
  ---
  method_declaration [4607,5194]
      identifier: getLeastSupertype [4633,4650]
      method_parameters [4607,5194]
          formal_parameter: JSType that [4651,4662]
      block [4664,5194]
          if_statement [4670,4747]
              parenthesized_expression [4673,4695]
                  unary_expression: !that.isRecordType() [4674,4694]
              block [4696,4747]
                  return_statement: return super.getLeastSupertype(that); [4704,4741]
          local_variable_declaration: RecordTypeBuilder builder = new RecordTypeBuilder(registry); [4752,4812]
          enhanced_for_statement: for (String property : properties.keySet()) {
        if (that.toMaybeRecordType().hasProperty(property) &&
            that.toMaybeRecordType().getPropertyType(property).isEquivalentTo(
                getPropertyType(property))) {
          builder.addProperty(property, getPropertyType(property),
              getPropertyNode(property));
        }
      } [4817,5162]
          return_statement: return builder.build(); [5167,5190]
  to
  class_body [2503,9768]
  at 7

...
