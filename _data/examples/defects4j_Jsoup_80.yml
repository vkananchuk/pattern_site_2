---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: XmlTreeBuilder
        children: []
        pos: 467
        length: 14
      body:
        type: class_body
        fields: {}
        children:
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: defaultSettings
              children: []
              pos: 522
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 508
              length: 82
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return ParseSettings.preserveCase;
                children: []
                pos: 550
                length: 34
              pos: 540
              length: 50
          children: []
          pos: 508
          length: 82
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: parse
              children: []
              pos: 605
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Reader input
                children: []
                pos: 611
                length: 12
              pos: 596
              length: 147
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return parse(input, baseUri, ParseErrorList.noTracking(),
                    ParseSettings.preserveCase);
                children: []
                pos: 651
                length: 86
              pos: 641
              length: 102
          children: []
          pos: 596
          length: 147
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: parse
              children: []
              pos: 758
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String input
                children: []
                pos: 764
                length: 12
              pos: 749
              length: 165
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return parse(new StringReader(input), baseUri, ParseErrorList.noTracking(),
                    ParseSettings.preserveCase);
                children: []
                pos: 804
                length: 104
              pos: 794
              length: 120
          children: []
          pos: 749
          length: 165
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: initialiseParse
              children: []
              pos: 949
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Reader input
                children: []
                pos: 965
                length: 12
              pos: 920
              length: 373
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: super.initialiseParse(input, baseUri, errors, settings);
                children: []
                pos: 1052
                length: 56
              - type: expression_statement
                fields:
                  text: stack.add(doc);
                children: []
                pos: 1117
                length: 15
              - type: expression_statement
                fields:
                  text: doc.outputSettings().syntax(Document.OutputSettings.Syntax.xml);
                children: []
                pos: 1223
                length: 64
              pos: 1042
              length: 251
          children: []
          pos: 920
          length: 373
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: process
              children: []
              pos: 1331
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token token
                children: []
                pos: 1339
                length: 11
              pos: 1299
              length: 843
            body:
              type: block
              fields: {}
              children:
              - type: switch_expression
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: field_access
                        fields:
                          text: token.type
                        children: []
                        pos: 1434
                        length: 10
                    children: []
                    pos: 1433
                    length: 12
                  body:
                    type: switch_block
                    fields:
                      text: |-
                        {
                                    case StartTag:
                                        insert(token.asStartTag());
                                        break;
                                    case EndTag:
                                        popStackToClose(token.asEndTag());
                                        break;
                                    case Comment:
                                        insert(token.asComment());
                                        break;
                                    case Character:
                                        insert(token.asCharacter());
                                        break;
                                    case Doctype:
                                        insert(token.asDoctype());
                                        break;
                                    case EOF: // could put some normalisation here if desired
                                        break;
                                    default:
                                        Validate.fail("Unexpected token type: " + token.type);
                                }
                    children: []
                    pos: 1446
                    length: 669
                children: []
                pos: 1426
                length: 689
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 2124
                length: 12
              pos: 1352
              length: 790
          children: []
          pos: 1299
          length: 843
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insertNode
              children: []
              pos: 2161
              length: 10
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node node
                children: []
                pos: 2172
                length: 9
              pos: 2148
              length: 86
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: currentElement().appendChild(node);
                children: []
                pos: 2193
                length: 35
              pos: 2183
              length: 51
          children: []
          pos: 2148
          length: 86
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insert
              children: []
              pos: 2248
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.StartTag startTag
                children: []
                pos: 2255
                length: 23
              pos: 2240
              length: 584
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Tag tag = Tag.valueOf(startTag.name(), settings);
                children: []
                pos: 2290
                length: 49
              - type: local_variable_declaration
                fields:
                  text: Element el = new Element(tag, baseUri, settings.normalizeAttributes(startTag.attributes));
                children: []
                pos: 2449
                length: 90
              - type: expression_statement
                fields:
                  text: insertNode(el);
                children: []
                pos: 2548
                length: 15
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: startTag.isSelfClosing()
                        children: []
                        pos: 2576
                        length: 24
                    children: []
                    pos: 2575
                    length: 26
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: unary_expression
                            fields:
                              text: "!tag.isKnownTag()"
                            children: []
                            pos: 2620
                            length: 17
                        children: []
                        pos: 2619
                        length: 19
                    children:
                    - type: expression_statement
                      fields:
                        text: tag.setSelfClosing();
                      children: []
                      pos: 2724
                      length: 21
                    pos: 2616
                    length: 129
                  pos: 2602
                  length: 153
                pos: 2572
                length: 227
              - type: return_statement
                fields:
                  text: return el;
                children: []
                pos: 2808
                length: 10
              pos: 2280
              length: 544
          children: []
          pos: 2240
          length: 584
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insert
              children: []
              pos: 2835
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.Comment commentToken
                children: []
                pos: 2842
                length: 26
              pos: 2830
              length: 1018
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Comment comment = new Comment(commentToken.getData());
                children: []
                pos: 2880
                length: 54
              - type: local_variable_declaration
                fields:
                  text: Node insert = comment;
                children: []
                pos: 2943
                length: 22
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: field_access
                        fields:
                          text: commentToken.bogus
                        children: []
                        pos: 2978
                        length: 18
                    children: []
                    pos: 2977
                    length: 20
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String data = comment.getData();
                    children: []
                    pos: 3201
                    length: 32
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: and
                            fields:
                              left:
                                type: greater_than
                                fields:
                                  left:
                                    type: method_invocation
                                    fields:
                                      text: data.length()
                                    children: []
                                    pos: 3250
                                    length: 13
                                  right:
                                    type: decimal_integer_literal
                                    fields:
                                      text: '1'
                                    children: []
                                    pos: 3266
                                    length: 1
                                children: []
                                pos: 3250
                                length: 17
                              right:
                                type: parenthesized_expression
                                fields:
                                  expression:
                                    type: or
                                    fields:
                                      left:
                                        type: method_invocation
                                        fields:
                                          text: data.startsWith("!")
                                        children: []
                                        pos: 3272
                                        length: 20
                                      right:
                                        type: method_invocation
                                        fields:
                                          text: data.startsWith("?")
                                        children: []
                                        pos: 3296
                                        length: 20
                                    children: []
                                    pos: 3272
                                    length: 44
                                children: []
                                pos: 3271
                                length: 46
                            children: []
                            pos: 3250
                            length: 67
                        children: []
                        pos: 3249
                        length: 69
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: local_variable_declaration
                        fields:
                          text: Document doc = Jsoup.parse("<" + data.substring(1,
                            data.length() -1) + ">", baseUri, Parser.xmlParser());
                        children: []
                        pos: 3337
                        length: 105
                      - type: if_statement
                        fields:
                          condition:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: greater_than
                                fields:
                                  left:
                                    type: method_invocation
                                    fields:
                                      text: doc.childNodeSize()
                                    children: []
                                    pos: 3463
                                    length: 19
                                  right:
                                    type: decimal_integer_literal
                                    fields:
                                      text: '0'
                                    children: []
                                    pos: 3485
                                    length: 1
                                children: []
                                pos: 3463
                                length: 23
                            children: []
                            pos: 3462
                            length: 25
                        children:
                        - type: block
                          fields: {}
                          children:
                          - type: local_variable_declaration
                            fields:
                              text: Element el = doc.child(0);
                            children: []
                            pos: 3510
                            length: 26
                          - type: expression_statement
                            fields:
                              text: insert = new XmlDeclaration(settings.normalizeTag(el.tagName()),
                                data.startsWith("!"));
                            children: []
                            pos: 3557
                            length: 87
                          - type: expression_statement
                            fields:
                              text: insert.attributes().addAll(el.attributes());
                            children: []
                            pos: 3665
                            length: 44
                          pos: 3488
                          length: 239
                        pos: 3459
                        length: 268
                      pos: 3319
                      length: 485
                    pos: 3246
                    length: 558
                  pos: 2998
                  length: 816
                pos: 2974
                length: 840
              - type: expression_statement
                fields:
                  text: insertNode(insert);
                children: []
                pos: 3823
                length: 19
              pos: 2870
              length: 978
          children: []
          pos: 2830
          length: 1018
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insert
              children: []
              pos: 3859
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.Character token
                children: []
                pos: 3866
                length: 21
              pos: 3854
              length: 167
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: final String data = token.getData();
                children: []
                pos: 3899
                length: 36
              - type: expression_statement
                fields:
                  text: 'insertNode(token.isCData() ? new CDataNode(data) : new TextNode(data));'
                children: []
                pos: 3944
                length: 71
              pos: 3889
              length: 132
          children: []
          pos: 3854
          length: 167
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insert
              children: []
              pos: 4032
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.Doctype d
                children: []
                pos: 4039
                length: 15
              pos: 4027
              length: 260
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: DocumentType doctypeNode = new DocumentType(settings.normalizeTag(d.getName()),
                    d.getPublicIdentifier(), d.getSystemIdentifier());
                children: []
                pos: 4066
                length: 130
              - type: expression_statement
                fields:
                  text: doctypeNode.setPubSysKey(d.getPubSysKey());
                children: []
                pos: 4205
                length: 43
              - type: expression_statement
                fields:
                  text: insertNode(doctypeNode);
                children: []
                pos: 4257
                length: 24
              pos: 4056
              length: 231
          children: []
          pos: 4027
          length: 260
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: popStackToClose
              children: []
              pos: 4502
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.EndTag endTag
                children: []
                pos: 4518
                length: 19
              pos: 4489
              length: 664
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: String elName = settings.normalizeTag(endTag.tagName);
                children: []
                pos: 4549
                length: 54
              - type: local_variable_declaration
                fields:
                  text: Element firstFound = null;
                children: []
                pos: 4612
                length: 26
              - type: for_statement
                fields:
                  text: |-
                    for (int pos = stack.size() -1; pos >= 0; pos--) {
                                Element next = stack.get(pos);
                                if (next.nodeName().equals(elName)) {
                                    firstFound = next;
                                    break;
                                }
                            }
                children: []
                pos: 4648
                length: 225
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: firstFound
                            children: []
                            pos: 4886
                            length: 10
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 4900
                            length: 4
                        children: []
                        pos: 4886
                        length: 18
                    children: []
                    pos: 4885
                    length: 20
                children:
                - type: return_statement
                  fields:
                    text: return;
                  children: []
                  pos: 4918
                  length: 7
                pos: 4882
                length: 43
              - type: for_statement
                fields:
                  text: |-
                    for (int pos = stack.size() -1; pos >= 0; pos--) {
                                Element next = stack.get(pos);
                                stack.remove(pos);
                                if (next == firstFound)
                                    break;
                            }
                children: []
                pos: 4954
                length: 193
              pos: 4539
              length: 614
          children: []
          pos: 4489
          length: 664
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: parseFragment
              children: []
              pos: 5170
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String inputFragment
                children: []
                pos: 5184
                length: 20
              pos: 5159
              length: 256
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: initialiseParse(new StringReader(inputFragment), baseUri,
                    errors, settings);
                children: []
                pos: 5279
                length: 76
              - type: expression_statement
                fields:
                  text: runParser();
                children: []
                pos: 5364
                length: 12
              - type: return_statement
                fields:
                  text: return doc.childNodes();
                children: []
                pos: 5385
                length: 24
              pos: 5269
              length: 146
          children: []
          pos: 5159
          length: 256
        pos: 454
        length: 4963
    children: []
    pos: 454
    length: 4963
  pos: 0
  length: 5418
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: XmlTreeBuilder
        children: []
        pos: 467
        length: 14
      body:
        type: class_body
        fields: {}
        children:
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: defaultSettings
              children: []
              pos: 522
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 508
              length: 82
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return ParseSettings.preserveCase;
                children: []
                pos: 550
                length: 34
              pos: 540
              length: 50
          children: []
          pos: 508
          length: 82
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: parse
              children: []
              pos: 605
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Reader input
                children: []
                pos: 611
                length: 12
              pos: 596
              length: 147
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return parse(input, baseUri, ParseErrorList.noTracking(),
                    ParseSettings.preserveCase);
                children: []
                pos: 651
                length: 86
              pos: 641
              length: 102
          children: []
          pos: 596
          length: 147
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: parse
              children: []
              pos: 758
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String input
                children: []
                pos: 764
                length: 12
              pos: 749
              length: 165
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return parse(new StringReader(input), baseUri, ParseErrorList.noTracking(),
                    ParseSettings.preserveCase);
                children: []
                pos: 804
                length: 104
              pos: 794
              length: 120
          children: []
          pos: 749
          length: 165
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: initialiseParse
              children: []
              pos: 949
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Reader input
                children: []
                pos: 965
                length: 12
              pos: 920
              length: 373
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: super.initialiseParse(input, baseUri, errors, settings);
                children: []
                pos: 1052
                length: 56
              - type: expression_statement
                fields:
                  text: stack.add(doc);
                children: []
                pos: 1117
                length: 15
              - type: expression_statement
                fields:
                  text: doc.outputSettings().syntax(Document.OutputSettings.Syntax.xml);
                children: []
                pos: 1223
                length: 64
              pos: 1042
              length: 251
          children: []
          pos: 920
          length: 373
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: process
              children: []
              pos: 1331
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token token
                children: []
                pos: 1339
                length: 11
              pos: 1299
              length: 843
            body:
              type: block
              fields: {}
              children:
              - type: switch_expression
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: field_access
                        fields:
                          text: token.type
                        children: []
                        pos: 1434
                        length: 10
                    children: []
                    pos: 1433
                    length: 12
                  body:
                    type: switch_block
                    fields:
                      text: |-
                        {
                                    case StartTag:
                                        insert(token.asStartTag());
                                        break;
                                    case EndTag:
                                        popStackToClose(token.asEndTag());
                                        break;
                                    case Comment:
                                        insert(token.asComment());
                                        break;
                                    case Character:
                                        insert(token.asCharacter());
                                        break;
                                    case Doctype:
                                        insert(token.asDoctype());
                                        break;
                                    case EOF: // could put some normalisation here if desired
                                        break;
                                    default:
                                        Validate.fail("Unexpected token type: " + token.type);
                                }
                    children: []
                    pos: 1446
                    length: 669
                children: []
                pos: 1426
                length: 689
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 2124
                length: 12
              pos: 1352
              length: 790
          children: []
          pos: 1299
          length: 843
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insertNode
              children: []
              pos: 2161
              length: 10
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node node
                children: []
                pos: 2172
                length: 9
              pos: 2148
              length: 86
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: currentElement().appendChild(node);
                children: []
                pos: 2193
                length: 35
              pos: 2183
              length: 51
          children: []
          pos: 2148
          length: 86
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insert
              children: []
              pos: 2248
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.StartTag startTag
                children: []
                pos: 2255
                length: 23
              pos: 2240
              length: 584
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Tag tag = Tag.valueOf(startTag.name(), settings);
                children: []
                pos: 2290
                length: 49
              - type: local_variable_declaration
                fields:
                  text: Element el = new Element(tag, baseUri, settings.normalizeAttributes(startTag.attributes));
                children: []
                pos: 2449
                length: 90
              - type: expression_statement
                fields:
                  text: insertNode(el);
                children: []
                pos: 2548
                length: 15
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: startTag.isSelfClosing()
                        children: []
                        pos: 2576
                        length: 24
                    children: []
                    pos: 2575
                    length: 26
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: unary_expression
                            fields:
                              text: "!tag.isKnownTag()"
                            children: []
                            pos: 2620
                            length: 17
                        children: []
                        pos: 2619
                        length: 19
                    children:
                    - type: expression_statement
                      fields:
                        text: tag.setSelfClosing();
                      children: []
                      pos: 2724
                      length: 21
                    pos: 2616
                    length: 129
                  pos: 2602
                  length: 153
                pos: 2572
                length: 227
              - type: return_statement
                fields:
                  text: return el;
                children: []
                pos: 2808
                length: 10
              pos: 2280
              length: 544
          children: []
          pos: 2240
          length: 584
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insert
              children: []
              pos: 2835
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.Comment commentToken
                children: []
                pos: 2842
                length: 26
              pos: 2830
              length: 890
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Comment comment = new Comment(commentToken.getData());
                children: []
                pos: 2880
                length: 54
              - type: local_variable_declaration
                fields:
                  text: Node insert = comment;
                children: []
                pos: 2943
                length: 22
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: field_access
                        fields:
                          text: commentToken.bogus
                        children: []
                        pos: 2978
                        length: 18
                    children: []
                    pos: 2977
                    length: 20
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String data = comment.getData();
                    children: []
                    pos: 3201
                    length: 32
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: and
                            fields:
                              left:
                                type: greater_than
                                fields:
                                  left:
                                    type: method_invocation
                                    fields:
                                      text: data.length()
                                    children: []
                                    pos: 3250
                                    length: 13
                                  right:
                                    type: decimal_integer_literal
                                    fields:
                                      text: '1'
                                    children: []
                                    pos: 3266
                                    length: 1
                                children: []
                                pos: 3250
                                length: 17
                              right:
                                type: parenthesized_expression
                                fields:
                                  expression:
                                    type: or
                                    fields:
                                      left:
                                        type: method_invocation
                                        fields:
                                          text: data.startsWith("!")
                                        children: []
                                        pos: 3272
                                        length: 20
                                      right:
                                        type: method_invocation
                                        fields:
                                          text: data.startsWith("?")
                                        children: []
                                        pos: 3296
                                        length: 20
                                    children: []
                                    pos: 3272
                                    length: 44
                                children: []
                                pos: 3271
                                length: 46
                            children: []
                            pos: 3250
                            length: 67
                        children: []
                        pos: 3249
                        length: 69
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: local_variable_declaration
                        fields:
                          text: Document doc = Jsoup.parse("<" + data.substring(1,
                            data.length() -1) + ">", baseUri, Parser.xmlParser());
                        children: []
                        pos: 3337
                        length: 105
                      - type: local_variable_declaration
                        fields:
                          text: Element el = doc.child(0);
                        children: []
                        pos: 3463
                        length: 26
                      - type: expression_statement
                        fields:
                          text: insert = new XmlDeclaration(settings.normalizeTag(el.tagName()),
                            data.startsWith("!"));
                        children: []
                        pos: 3510
                        length: 87
                      - type: expression_statement
                        fields:
                          text: insert.attributes().addAll(el.attributes());
                        children: []
                        pos: 3618
                        length: 44
                      pos: 3319
                      length: 357
                    pos: 3246
                    length: 430
                  pos: 2998
                  length: 688
                pos: 2974
                length: 712
              - type: expression_statement
                fields:
                  text: insertNode(insert);
                children: []
                pos: 3695
                length: 19
              pos: 2870
              length: 850
          children: []
          pos: 2830
          length: 890
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insert
              children: []
              pos: 3731
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.Character token
                children: []
                pos: 3738
                length: 21
              pos: 3726
              length: 167
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: final String data = token.getData();
                children: []
                pos: 3771
                length: 36
              - type: expression_statement
                fields:
                  text: 'insertNode(token.isCData() ? new CDataNode(data) : new TextNode(data));'
                children: []
                pos: 3816
                length: 71
              pos: 3761
              length: 132
          children: []
          pos: 3726
          length: 167
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: insert
              children: []
              pos: 3904
              length: 6
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.Doctype d
                children: []
                pos: 3911
                length: 15
              pos: 3899
              length: 260
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: DocumentType doctypeNode = new DocumentType(settings.normalizeTag(d.getName()),
                    d.getPublicIdentifier(), d.getSystemIdentifier());
                children: []
                pos: 3938
                length: 130
              - type: expression_statement
                fields:
                  text: doctypeNode.setPubSysKey(d.getPubSysKey());
                children: []
                pos: 4077
                length: 43
              - type: expression_statement
                fields:
                  text: insertNode(doctypeNode);
                children: []
                pos: 4129
                length: 24
              pos: 3928
              length: 231
          children: []
          pos: 3899
          length: 260
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: popStackToClose
              children: []
              pos: 4374
              length: 15
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Token.EndTag endTag
                children: []
                pos: 4390
                length: 19
              pos: 4361
              length: 664
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: String elName = settings.normalizeTag(endTag.tagName);
                children: []
                pos: 4421
                length: 54
              - type: local_variable_declaration
                fields:
                  text: Element firstFound = null;
                children: []
                pos: 4484
                length: 26
              - type: for_statement
                fields:
                  text: |-
                    for (int pos = stack.size() -1; pos >= 0; pos--) {
                                Element next = stack.get(pos);
                                if (next.nodeName().equals(elName)) {
                                    firstFound = next;
                                    break;
                                }
                            }
                children: []
                pos: 4520
                length: 225
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: firstFound
                            children: []
                            pos: 4758
                            length: 10
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 4772
                            length: 4
                        children: []
                        pos: 4758
                        length: 18
                    children: []
                    pos: 4757
                    length: 20
                children:
                - type: return_statement
                  fields:
                    text: return;
                  children: []
                  pos: 4790
                  length: 7
                pos: 4754
                length: 43
              - type: for_statement
                fields:
                  text: |-
                    for (int pos = stack.size() -1; pos >= 0; pos--) {
                                Element next = stack.get(pos);
                                stack.remove(pos);
                                if (next == firstFound)
                                    break;
                            }
                children: []
                pos: 4826
                length: 193
              pos: 4411
              length: 614
          children: []
          pos: 4361
          length: 664
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: parseFragment
              children: []
              pos: 5042
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String inputFragment
                children: []
                pos: 5056
                length: 20
              pos: 5031
              length: 256
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: initialiseParse(new StringReader(inputFragment), baseUri,
                    errors, settings);
                children: []
                pos: 5151
                length: 76
              - type: expression_statement
                fields:
                  text: runParser();
                children: []
                pos: 5236
                length: 12
              - type: return_statement
                fields:
                  text: return doc.childNodes();
                children: []
                pos: 5257
                length: 24
              pos: 5141
              length: 146
          children: []
          pos: 5031
          length: 256
        pos: 454
        length: 4835
    children: []
    pos: 454
    length: 4835
  pos: 0
  length: 5290
text_diff: |
  --- before
  +++ after
  @@ -88,11 +88,9 @@
               String data = comment.getData();
               if (data.length() > 1 && (data.startsWith("!") || data.startsWith("?"))) {
                   Document doc = Jsoup.parse("<" + data.substring(1, data.length() -1) + ">", baseUri, Parser.xmlParser());
  -                if (doc.childNodeSize() > 0) {
                       Element el = doc.child(0);
                       insert = new XmlDeclaration(settings.normalizeTag(el.tagName()), data.startsWith("!"));
                       insert.attributes().addAll(el.attributes());
  -                } // else, we couldn't parse it as a decl, so leave as a comment
               }
           }
           insertNode(insert);
tree_diff: |+
  New cluster:
  ===
  insert-node
  ---
  local_variable_declaration: Element el = doc.child(0); [3463,3489]
  to
  block [3319,3804]
  at 1
  ------------
  ===
  insert-node
  ---
  local_variable_declaration: Element el = doc.child(0); [3463,3489]
  to
  block [3319,3804]
  at 1

  New cluster:
  ===
  insert-node
  ---
  expression_statement: insert = new XmlDeclaration(settings.normalizeTag(el.tagName()), data.startsWith("!")); [3510,3597]
  to
  block [3319,3804]
  at 2
  ------------
  ===
  insert-node
  ---
  expression_statement: insert = new XmlDeclaration(settings.normalizeTag(el.tagName()), data.startsWith("!")); [3510,3597]
  to
  block [3319,3804]
  at 2

  New cluster:
  ===
  insert-node
  ---
  expression_statement: insert.attributes().addAll(el.attributes()); [3618,3662]
  to
  block [3319,3804]
  at 3
  ------------
  ===
  insert-node
  ---
  expression_statement: insert.attributes().addAll(el.attributes()); [3618,3662]
  to
  block [3319,3804]
  at 3

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  if_statement [3459,3727]
      parenthesized_expression [3462,3487]
          greater_than [3463,3486]
              method_invocation: doc.childNodeSize() [3463,3482]
              decimal_integer_literal: 0 [3485,3486]
      block [3488,3727]
          local_variable_declaration: Element el = doc.child(0); [3510,3536]
          expression_statement: insert = new XmlDeclaration(settings.normalizeTag(el.tagName()), data.startsWith("!")); [3557,3644]
          expression_statement: insert.attributes().addAll(el.attributes()); [3665,3709]

...
