---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: DataUtil
        children: []
        pos: 419
        length: 8
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private static final Pattern charsetPattern = Pattern.compile("(?i)\\bcharset=\\s*(?:\"|')?([^\\s,;\"']*)");
          children: []
          pos: 434
          length: 108
        - type: field_declaration
          fields:
            text: static final String defaultCharset = "UTF-8";
          children: []
          pos: 547
          length: 45
        - type: field_declaration
          fields:
            text: private static final int bufferSize = 0x20000;
          children: []
          pos: 644
          length: 46
        - type: constructor_declaration
          fields:
            text: private DataUtil() {}
          children: []
          pos: 706
          length: 21
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: load
              children: []
              pos: 1027
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: File in
                children: []
                pos: 1032
                length: 7
              pos: 1004
              length: 449
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: FileInputStream inStream = null;
                children: []
                pos: 1106
                length: 32
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: inStream = new FileInputStream(in);
                      children: []
                      pos: 1165
                      length: 35
                    - type: local_variable_declaration
                      fields:
                        text: ByteBuffer byteData = readToByteBuffer(inStream);
                      children: []
                      pos: 1213
                      length: 49
                    - type: return_statement
                      fields:
                        text: return parseByteData(byteData, charsetName, baseUri,
                          Parser.htmlParser());
                      children: []
                      pos: 1275
                      length: 74
                    pos: 1151
                    length: 208
                  excepts:
                    type: excepts
                    fields: {}
                    children: []
                    pos: 1147
                    length: 300
                children: []
                pos: 1147
                length: 300
              pos: 1096
              length: 357
          children: []
          pos: 1004
          length: 449
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: load
              children: []
              pos: 1801
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: InputStream in
                children: []
                pos: 1806
                length: 14
              pos: 1778
              length: 241
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: ByteBuffer byteData = readToByteBuffer(in);
                children: []
                pos: 1887
                length: 43
              - type: return_statement
                fields:
                  text: return parseByteData(byteData, charsetName, baseUri, Parser.htmlParser());
                children: []
                pos: 1939
                length: 74
              pos: 1877
              length: 142
          children: []
          pos: 1778
          length: 241
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: load
              children: []
              pos: 2467
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: InputStream in
                children: []
                pos: 2472
                length: 14
              pos: 2444
              length: 243
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: ByteBuffer byteData = readToByteBuffer(in);
                children: []
                pos: 2568
                length: 43
              - type: return_statement
                fields:
                  text: return parseByteData(byteData, charsetName, baseUri, parser);
                children: []
                pos: 2620
                length: 61
              pos: 2558
              length: 129
          children: []
          pos: 2444
          length: 243
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: parseByteData
              children: []
              pos: 2905
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: ByteBuffer byteData
                children: []
                pos: 2919
                length: 19
              pos: 2889
              length: 2718
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: String docData;
                children: []
                pos: 3001
                length: 15
              - type: local_variable_declaration
                fields:
                  text: Document doc = null;
                children: []
                pos: 3025
                length: 20
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: charsetName
                            children: []
                            pos: 3058
                            length: 11
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3073
                            length: 4
                        children: []
                        pos: 3058
                        length: 19
                    children: []
                    pos: 3057
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: docData = Charset.forName(defaultCharset).decode(byteData).toString();
                    children: []
                    pos: 3262
                    length: 70
                  - type: expression_statement
                    fields:
                      text: doc = parser.parseInput(docData, baseUri);
                    children: []
                    pos: 3345
                    length: 42
                  - type: local_variable_declaration
                    fields:
                      text: Element meta = doc.select("meta[http-equiv=content-type],
                        meta[charset]").first();
                    children: []
                    pos: 3400
                    length: 82
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: meta
                                children: []
                                pos: 3499
                                length: 4
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 3507
                                length: 4
                            children: []
                            pos: 3499
                            length: 12
                        children: []
                        pos: 3498
                        length: 14
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: local_variable_declaration
                        fields:
                          text: String foundCharset;
                        children: []
                        pos: 3581
                        length: 20
                      - type: if_statement
                        fields:
                          condition:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: method_invocation
                                fields:
                                  text: meta.hasAttr("http-equiv")
                                children: []
                                pos: 3622
                                length: 26
                            children: []
                            pos: 3621
                            length: 28
                        children:
                        - type: block
                          fields: {}
                          children:
                          - type: expression_statement
                            fields:
                              text: foundCharset = getCharsetFromContentType(meta.attr("content"));
                            children: []
                            pos: 3672
                            length: 63
                          - type: if_statement
                            fields:
                              condition:
                                type: parenthesized_expression
                                fields:
                                  expression:
                                    type: and
                                    fields:
                                      left:
                                        type: equals
                                        fields:
                                          left:
                                            type: identifier
                                            fields:
                                              text: foundCharset
                                            children: []
                                            pos: 3760
                                            length: 12
                                          right:
                                            type: null_literal
                                            fields: {}
                                            children: []
                                            pos: 3776
                                            length: 4
                                        children: []
                                        pos: 3760
                                        length: 20
                                      right:
                                        type: method_invocation
                                        fields:
                                          text: meta.hasAttr("charset")
                                        children: []
                                        pos: 3784
                                        length: 23
                                    children: []
                                    pos: 3760
                                    length: 47
                                children: []
                                pos: 3759
                                length: 49
                            children:
                            - type: block
                              fields: {}
                              children:
                              - type: try_statement
                                fields:
                                  body:
                                    type: block
                                    fields: {}
                                    children:
                                    - type: if_statement
                                      fields:
                                        condition:
                                          type: parenthesized_expression
                                          fields:
                                            expression:
                                              type: method_invocation
                                              fields:
                                                text: Charset.isSupported(meta.attr("charset"))
                                              children: []
                                              pos: 3873
                                              length: 41
                                          children: []
                                          pos: 3872
                                          length: 43
                                      children:
                                      - type: block
                                        fields: {}
                                        children:
                                        - type: expression_statement
                                          fields:
                                            text: foundCharset = meta.attr("charset");
                                          children: []
                                          pos: 3950
                                          length: 36
                                        pos: 3916
                                        length: 100
                                      pos: 3869
                                      length: 147
                                    pos: 3839
                                    length: 203
                                  excepts:
                                    type: excepts
                                    fields: {}
                                    children:
                                    - type: catch_clause
                                      fields:
                                        text: |-
                                          catch (IllegalCharsetNameException e) {
                                                                      foundCharset = null;
                                                                  }
                                      children: []
                                      pos: 4043
                                      length: 114
                                    pos: 3835
                                    length: 322
                                children: []
                                pos: 3835
                                length: 322
                              pos: 3809
                              length: 370
                            pos: 3756
                            length: 423
                          pos: 3650
                          length: 547
                        pos: 3618
                        length: 661
                      - type: if_statement
                        fields:
                          condition:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: and
                                fields:
                                  left:
                                    type: and
                                    fields:
                                      left:
                                        type: not_equals
                                        fields:
                                          left:
                                            type: identifier
                                            fields:
                                              text: foundCharset
                                            children: []
                                            pos: 4301
                                            length: 12
                                          right:
                                            type: null_literal
                                            fields: {}
                                            children: []
                                            pos: 4317
                                            length: 4
                                        children: []
                                        pos: 4301
                                        length: 20
                                      right:
                                        type: not_equals
                                        fields:
                                          left:
                                            type: method_invocation
                                            fields:
                                              text: foundCharset.length()
                                            children: []
                                            pos: 4325
                                            length: 21
                                          right:
                                            type: decimal_integer_literal
                                            fields:
                                              text: '0'
                                            children: []
                                            pos: 4350
                                            length: 1
                                        children: []
                                        pos: 4325
                                        length: 26
                                    children: []
                                    pos: 4301
                                    length: 50
                                  right:
                                    type: unary_expression
                                    fields:
                                      text: "!foundCharset.equals(defaultCharset)"
                                    children: []
                                    pos: 4355
                                    length: 36
                                children: []
                                pos: 4301
                                length: 90
                            children: []
                            pos: 4300
                            length: 92
                        children:
                        - type: block
                          fields: {}
                          children:
                          - type: expression_statement
                            fields:
                              text: foundCharset = foundCharset.trim().replaceAll("[\"']",
                                "");
                            children: []
                            pos: 4436
                            length: 59
                          - type: expression_statement
                            fields:
                              text: charsetName = foundCharset;
                            children: []
                            pos: 4516
                            length: 27
                          - type: expression_statement
                            fields:
                              text: byteData.rewind();
                            children: []
                            pos: 4564
                            length: 18
                          - type: expression_statement
                            fields:
                              text: docData = Charset.forName(foundCharset).decode(byteData).toString();
                            children: []
                            pos: 4603
                            length: 68
                          - type: expression_statement
                            fields:
                              text: doc = null;
                            children: []
                            pos: 4692
                            length: 11
                          pos: 4393
                          length: 328
                        pos: 4297
                        length: 424
                      pos: 3513
                      length: 1222
                    pos: 3495
                    length: 1240
                  pos: 3079
                  length: 1666
                pos: 3054
                length: 1996
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: doc
                            children: []
                            pos: 5063
                            length: 3
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 5070
                            length: 4
                        children: []
                        pos: 5063
                        length: 11
                    children: []
                    pos: 5062
                    length: 13
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: and
                            fields:
                              left:
                                type: greater_than
                                fields:
                                  left:
                                    type: method_invocation
                                    fields:
                                      text: docData.length()
                                    children: []
                                    pos: 5361
                                    length: 16
                                  right:
                                    type: decimal_integer_literal
                                    fields:
                                      text: '0'
                                    children: []
                                    pos: 5380
                                    length: 1
                                children: []
                                pos: 5361
                                length: 20
                              right:
                                type: equals
                                fields:
                                  left:
                                    type: method_invocation
                                    fields:
                                      text: docData.charAt(0)
                                    children: []
                                    pos: 5385
                                    length: 17
                                  right:
                                    type: decimal_integer_literal
                                    fields:
                                      text: '65279'
                                    children: []
                                    pos: 5406
                                    length: 5
                                children: []
                                pos: 5385
                                length: 26
                            children: []
                            pos: 5361
                            length: 50
                        children: []
                        pos: 5360
                        length: 52
                    children:
                    - type: expression_statement
                      fields:
                        text: docData = docData.substring(1);
                      children: []
                      pos: 5429
                      length: 31
                    pos: 5357
                    length: 103
                  - type: expression_statement
                    fields:
                      text: doc = parser.parseInput(docData, baseUri);
                    children: []
                    pos: 5474
                    length: 42
                  - type: expression_statement
                    fields:
                      text: doc.outputSettings().charset(charsetName);
                    children: []
                    pos: 5529
                    length: 42
                  pos: 5076
                  length: 505
                pos: 5059
                length: 522
              - type: return_statement
                fields:
                  text: return doc;
                children: []
                pos: 5590
                length: 11
              pos: 2991
              length: 2616
          children: []
          pos: 2889
          length: 2718
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: readToByteBuffer
              children: []
              pos: 5974
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: InputStream inStream
                children: []
                pos: 5991
                length: 20
              pos: 5956
              length: 873
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: Validate.isTrue(maxSize >= 0, "maxSize must be 0 (unlimited)
                    or larger");
                children: []
                pos: 6055
                length: 73
              - type: local_variable_declaration
                fields:
                  text: final boolean capped = maxSize > 0;
                children: []
                pos: 6137
                length: 35
              - type: local_variable_declaration
                fields:
                  text: byte[] buffer = new byte[bufferSize];
                children: []
                pos: 6181
                length: 37
              - type: local_variable_declaration
                fields:
                  text: ByteArrayOutputStream outStream = new ByteArrayOutputStream(bufferSize);
                children: []
                pos: 6227
                length: 72
              - type: local_variable_declaration
                fields:
                  text: int read;
                children: []
                pos: 6308
                length: 9
              - type: local_variable_declaration
                fields:
                  text: int remaining = maxSize;
                children: []
                pos: 6326
                length: 24
              - type: while_statement
                fields:
                  text: |-
                    while (true) {
                                read = inStream.read(buffer);
                                if (read == -1) break;
                                if (capped) {
                                    if (read > remaining) {
                                        outStream.write(buffer, 0, remaining);
                                        break;
                                    }
                                    remaining -= read;
                                }
                                outStream.write(buffer, 0, read);
                            }
                children: []
                pos: 6360
                length: 366
              - type: local_variable_declaration
                fields:
                  text: ByteBuffer byteData = ByteBuffer.wrap(outStream.toByteArray());
                children: []
                pos: 6735
                length: 63
              - type: return_statement
                fields:
                  text: return byteData;
                children: []
                pos: 6807
                length: 16
              pos: 6045
              length: 784
          children: []
          pos: 5956
          length: 873
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: readToByteBuffer
              children: []
              pos: 6853
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: InputStream inStream
                children: []
                pos: 6870
                length: 20
              pos: 6835
              length: 129
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return readToByteBuffer(inStream, 0);
                children: []
                pos: 6921
                length: 37
              pos: 6911
              length: 53
          children: []
          pos: 6835
          length: 129
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getCharsetFromContentType
              children: []
              pos: 7280
              length: 25
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String contentType
                children: []
                pos: 7306
                length: 18
              pos: 7266
              length: 773
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: contentType
                            children: []
                            pos: 7340
                            length: 11
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 7355
                            length: 4
                        children: []
                        pos: 7340
                        length: 19
                    children: []
                    pos: 7339
                    length: 21
                children:
                - type: return_statement
                  fields:
                    text: return null;
                  children: []
                  pos: 7361
                  length: 12
                pos: 7336
                length: 37
              - type: local_variable_declaration
                fields:
                  text: Matcher m = charsetPattern.matcher(contentType);
                children: []
                pos: 7382
                length: 48
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: m.find()
                        children: []
                        pos: 7443
                        length: 8
                    children: []
                    pos: 7442
                    length: 10
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String charset = m.group(1).trim();
                    children: []
                    pos: 7467
                    length: 35
                  - type: expression_statement
                    fields:
                      text: charset = charset.replace("charset=", "");
                    children: []
                    pos: 7515
                    length: 42
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: charset.isEmpty()
                            children: []
                            pos: 7574
                            length: 17
                        children: []
                        pos: 7573
                        length: 19
                    children:
                    - type: return_statement
                      fields:
                        text: return null;
                      children: []
                      pos: 7593
                      length: 12
                    pos: 7570
                    length: 35
                  - type: try_statement
                    fields:
                      body:
                        type: block
                        fields: {}
                        children:
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: method_invocation
                                  fields:
                                    text: Charset.isSupported(charset)
                                  children: []
                                  pos: 7644
                                  length: 28
                              children: []
                              pos: 7643
                              length: 30
                          children:
                          - type: return_statement
                            fields:
                              text: return charset;
                            children: []
                            pos: 7674
                            length: 15
                          pos: 7640
                          length: 49
                        - type: expression_statement
                          fields:
                            text: charset = charset.toUpperCase(Locale.ENGLISH);
                          children: []
                          pos: 7706
                          length: 46
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: method_invocation
                                  fields:
                                    text: Charset.isSupported(charset)
                                  children: []
                                  pos: 7773
                                  length: 28
                              children: []
                              pos: 7772
                              length: 30
                          children:
                          - type: return_statement
                            fields:
                              text: return charset;
                            children: []
                            pos: 7803
                            length: 15
                          pos: 7769
                          length: 49
                        pos: 7622
                        length: 210
                      excepts:
                        type: excepts
                        fields: {}
                        children:
                        - type: catch_clause
                          fields:
                            text: |-
                              catch (IllegalCharsetNameException e) {
                                              // if our advanced charset matching fails.... we just take the default
                                              return null;
                                          }
                          children: []
                          pos: 7833
                          length: 169
                        pos: 7618
                        length: 384
                    children: []
                    pos: 7618
                    length: 384
                  pos: 7453
                  length: 559
                pos: 7439
                length: 573
              - type: return_statement
                fields:
                  text: return null;
                children: []
                pos: 8021
                length: 12
              pos: 7326
              length: 713
          children: []
          pos: 7266
          length: 773
        pos: 406
        length: 7645
    children: []
    pos: 406
    length: 7645
  pos: 0
  length: 8052
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: DataUtil
        children: []
        pos: 366
        length: 8
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private static final Pattern charsetPattern = Pattern.compile("(?i)\\bcharset=\\s*\"?([^\\s;\"]*)");
          children: []
          pos: 381
          length: 100
        - type: field_declaration
          fields:
            text: static final String defaultCharset = "UTF-8";
          children: []
          pos: 486
          length: 45
        - type: field_declaration
          fields:
            text: private static final int bufferSize = 0x20000;
          children: []
          pos: 583
          length: 46
        - type: constructor_declaration
          fields:
            text: private DataUtil() {}
          children: []
          pos: 645
          length: 21
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: load
              children: []
              pos: 966
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: File in
                children: []
                pos: 971
                length: 7
              pos: 943
              length: 449
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: FileInputStream inStream = null;
                children: []
                pos: 1045
                length: 32
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: inStream = new FileInputStream(in);
                      children: []
                      pos: 1104
                      length: 35
                    - type: local_variable_declaration
                      fields:
                        text: ByteBuffer byteData = readToByteBuffer(inStream);
                      children: []
                      pos: 1152
                      length: 49
                    - type: return_statement
                      fields:
                        text: return parseByteData(byteData, charsetName, baseUri,
                          Parser.htmlParser());
                      children: []
                      pos: 1214
                      length: 74
                    pos: 1090
                    length: 208
                  excepts:
                    type: excepts
                    fields: {}
                    children: []
                    pos: 1086
                    length: 300
                children: []
                pos: 1086
                length: 300
              pos: 1035
              length: 357
          children: []
          pos: 943
          length: 449
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: load
              children: []
              pos: 1740
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: InputStream in
                children: []
                pos: 1745
                length: 14
              pos: 1717
              length: 241
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: ByteBuffer byteData = readToByteBuffer(in);
                children: []
                pos: 1826
                length: 43
              - type: return_statement
                fields:
                  text: return parseByteData(byteData, charsetName, baseUri, Parser.htmlParser());
                children: []
                pos: 1878
                length: 74
              pos: 1816
              length: 142
          children: []
          pos: 1717
          length: 241
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: load
              children: []
              pos: 2406
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: InputStream in
                children: []
                pos: 2411
                length: 14
              pos: 2383
              length: 243
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: ByteBuffer byteData = readToByteBuffer(in);
                children: []
                pos: 2507
                length: 43
              - type: return_statement
                fields:
                  text: return parseByteData(byteData, charsetName, baseUri, parser);
                children: []
                pos: 2559
                length: 61
              pos: 2497
              length: 129
          children: []
          pos: 2383
          length: 243
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: parseByteData
              children: []
              pos: 2844
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: ByteBuffer byteData
                children: []
                pos: 2858
                length: 19
              pos: 2828
              length: 2194
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: String docData;
                children: []
                pos: 2940
                length: 15
              - type: local_variable_declaration
                fields:
                  text: Document doc = null;
                children: []
                pos: 2964
                length: 20
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: charsetName
                            children: []
                            pos: 2997
                            length: 11
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3012
                            length: 4
                        children: []
                        pos: 2997
                        length: 19
                    children: []
                    pos: 2996
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: docData = Charset.forName(defaultCharset).decode(byteData).toString();
                    children: []
                    pos: 3201
                    length: 70
                  - type: expression_statement
                    fields:
                      text: doc = parser.parseInput(docData, baseUri);
                    children: []
                    pos: 3284
                    length: 42
                  - type: local_variable_declaration
                    fields:
                      text: Element meta = doc.select("meta[http-equiv=content-type],
                        meta[charset]").first();
                    children: []
                    pos: 3339
                    length: 82
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: not_equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: meta
                                children: []
                                pos: 3438
                                length: 4
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 3446
                                length: 4
                            children: []
                            pos: 3438
                            length: 12
                        children: []
                        pos: 3437
                        length: 14
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: local_variable_declaration
                        fields:
                          text: String foundCharset;
                        children: []
                        pos: 3520
                        length: 20
                      - type: if_statement
                        fields:
                          condition:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: method_invocation
                                fields:
                                  text: meta.hasAttr("http-equiv")
                                children: []
                                pos: 3561
                                length: 26
                            children: []
                            pos: 3560
                            length: 28
                        children:
                        - type: block
                          fields: {}
                          children:
                          - type: expression_statement
                            fields:
                              text: foundCharset = getCharsetFromContentType(meta.attr("content"));
                            children: []
                            pos: 3611
                            length: 63
                          pos: 3589
                          length: 103
                        pos: 3557
                        length: 217
                      - type: if_statement
                        fields:
                          condition:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: and
                                fields:
                                  left:
                                    type: and
                                    fields:
                                      left:
                                        type: not_equals
                                        fields:
                                          left:
                                            type: identifier
                                            fields:
                                              text: foundCharset
                                            children: []
                                            pos: 3796
                                            length: 12
                                          right:
                                            type: null_literal
                                            fields: {}
                                            children: []
                                            pos: 3812
                                            length: 4
                                        children: []
                                        pos: 3796
                                        length: 20
                                      right:
                                        type: not_equals
                                        fields:
                                          left:
                                            type: method_invocation
                                            fields:
                                              text: foundCharset.length()
                                            children: []
                                            pos: 3820
                                            length: 21
                                          right:
                                            type: decimal_integer_literal
                                            fields:
                                              text: '0'
                                            children: []
                                            pos: 3845
                                            length: 1
                                        children: []
                                        pos: 3820
                                        length: 26
                                    children: []
                                    pos: 3796
                                    length: 50
                                  right:
                                    type: unary_expression
                                    fields:
                                      text: "!foundCharset.equals(defaultCharset)"
                                    children: []
                                    pos: 3850
                                    length: 36
                                children: []
                                pos: 3796
                                length: 90
                            children: []
                            pos: 3795
                            length: 92
                        children:
                        - type: block
                          fields: {}
                          children:
                          - type: expression_statement
                            fields:
                              text: charsetName = foundCharset;
                            children: []
                            pos: 3931
                            length: 27
                          - type: expression_statement
                            fields:
                              text: byteData.rewind();
                            children: []
                            pos: 3979
                            length: 18
                          - type: expression_statement
                            fields:
                              text: docData = Charset.forName(foundCharset).decode(byteData).toString();
                            children: []
                            pos: 4018
                            length: 68
                          - type: expression_statement
                            fields:
                              text: doc = null;
                            children: []
                            pos: 4107
                            length: 11
                          pos: 3888
                          length: 248
                        pos: 3792
                        length: 344
                      pos: 3452
                      length: 698
                    pos: 3434
                    length: 716
                  pos: 3018
                  length: 1142
                pos: 2993
                length: 1472
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: doc
                            children: []
                            pos: 4478
                            length: 3
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 4485
                            length: 4
                        children: []
                        pos: 4478
                        length: 11
                    children: []
                    pos: 4477
                    length: 13
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: and
                            fields:
                              left:
                                type: greater_than
                                fields:
                                  left:
                                    type: method_invocation
                                    fields:
                                      text: docData.length()
                                    children: []
                                    pos: 4776
                                    length: 16
                                  right:
                                    type: decimal_integer_literal
                                    fields:
                                      text: '0'
                                    children: []
                                    pos: 4795
                                    length: 1
                                children: []
                                pos: 4776
                                length: 20
                              right:
                                type: equals
                                fields:
                                  left:
                                    type: method_invocation
                                    fields:
                                      text: docData.charAt(0)
                                    children: []
                                    pos: 4800
                                    length: 17
                                  right:
                                    type: decimal_integer_literal
                                    fields:
                                      text: '65279'
                                    children: []
                                    pos: 4821
                                    length: 5
                                children: []
                                pos: 4800
                                length: 26
                            children: []
                            pos: 4776
                            length: 50
                        children: []
                        pos: 4775
                        length: 52
                    children:
                    - type: expression_statement
                      fields:
                        text: docData = docData.substring(1);
                      children: []
                      pos: 4844
                      length: 31
                    pos: 4772
                    length: 103
                  - type: expression_statement
                    fields:
                      text: doc = parser.parseInput(docData, baseUri);
                    children: []
                    pos: 4889
                    length: 42
                  - type: expression_statement
                    fields:
                      text: doc.outputSettings().charset(charsetName);
                    children: []
                    pos: 4944
                    length: 42
                  pos: 4491
                  length: 505
                pos: 4474
                length: 522
              - type: return_statement
                fields:
                  text: return doc;
                children: []
                pos: 5005
                length: 11
              pos: 2930
              length: 2092
          children: []
          pos: 2828
          length: 2194
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: readToByteBuffer
              children: []
              pos: 5389
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: InputStream inStream
                children: []
                pos: 5406
                length: 20
              pos: 5371
              length: 873
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: Validate.isTrue(maxSize >= 0, "maxSize must be 0 (unlimited)
                    or larger");
                children: []
                pos: 5470
                length: 73
              - type: local_variable_declaration
                fields:
                  text: final boolean capped = maxSize > 0;
                children: []
                pos: 5552
                length: 35
              - type: local_variable_declaration
                fields:
                  text: byte[] buffer = new byte[bufferSize];
                children: []
                pos: 5596
                length: 37
              - type: local_variable_declaration
                fields:
                  text: ByteArrayOutputStream outStream = new ByteArrayOutputStream(bufferSize);
                children: []
                pos: 5642
                length: 72
              - type: local_variable_declaration
                fields:
                  text: int read;
                children: []
                pos: 5723
                length: 9
              - type: local_variable_declaration
                fields:
                  text: int remaining = maxSize;
                children: []
                pos: 5741
                length: 24
              - type: while_statement
                fields:
                  text: |-
                    while (true) {
                                read = inStream.read(buffer);
                                if (read == -1) break;
                                if (capped) {
                                    if (read > remaining) {
                                        outStream.write(buffer, 0, remaining);
                                        break;
                                    }
                                    remaining -= read;
                                }
                                outStream.write(buffer, 0, read);
                            }
                children: []
                pos: 5775
                length: 366
              - type: local_variable_declaration
                fields:
                  text: ByteBuffer byteData = ByteBuffer.wrap(outStream.toByteArray());
                children: []
                pos: 6150
                length: 63
              - type: return_statement
                fields:
                  text: return byteData;
                children: []
                pos: 6222
                length: 16
              pos: 5460
              length: 784
          children: []
          pos: 5371
          length: 873
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: readToByteBuffer
              children: []
              pos: 6268
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: InputStream inStream
                children: []
                pos: 6285
                length: 20
              pos: 6250
              length: 129
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return readToByteBuffer(inStream, 0);
                children: []
                pos: 6336
                length: 37
              pos: 6326
              length: 53
          children: []
          pos: 6250
          length: 129
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getCharsetFromContentType
              children: []
              pos: 6695
              length: 25
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String contentType
                children: []
                pos: 6721
                length: 18
              pos: 6681
              length: 555
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: contentType
                            children: []
                            pos: 6755
                            length: 11
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 6770
                            length: 4
                        children: []
                        pos: 6755
                        length: 19
                    children: []
                    pos: 6754
                    length: 21
                children:
                - type: return_statement
                  fields:
                    text: return null;
                  children: []
                  pos: 6776
                  length: 12
                pos: 6751
                length: 37
              - type: local_variable_declaration
                fields:
                  text: Matcher m = charsetPattern.matcher(contentType);
                children: []
                pos: 6797
                length: 48
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: m.find()
                        children: []
                        pos: 6858
                        length: 8
                    children: []
                    pos: 6857
                    length: 10
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String charset = m.group(1).trim();
                    children: []
                    pos: 6882
                    length: 35
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: Charset.isSupported(charset)
                            children: []
                            pos: 6938
                            length: 28
                        children: []
                        pos: 6937
                        length: 30
                    children:
                    - type: return_statement
                      fields:
                        text: return charset;
                      children: []
                      pos: 6968
                      length: 15
                    pos: 6934
                    length: 49
                  - type: expression_statement
                    fields:
                      text: charset = charset.toUpperCase(Locale.ENGLISH);
                    children: []
                    pos: 7000
                    length: 46
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: Charset.isSupported(charset)
                            children: []
                            pos: 7067
                            length: 28
                        children: []
                        pos: 7066
                        length: 30
                    children:
                    - type: return_statement
                      fields:
                        text: return charset;
                      children: []
                      pos: 7097
                      length: 15
                    pos: 7063
                    length: 49
                  pos: 6868
                  length: 341
                pos: 6854
                length: 355
              - type: return_statement
                fields:
                  text: return null;
                children: []
                pos: 7218
                length: 12
              pos: 6741
              length: 495
          children: []
          pos: 6681
          length: 555
        pos: 353
        length: 6895
    children: []
    pos: 353
    length: 6895
  pos: 0
  length: 7249
text_diff: "--- before\n+++ after\n@@ -7,7 +7,6 @@\n import java.io.*;\n import java.nio.ByteBuffer;\n
  import java.nio.charset.Charset;\n-import java.nio.charset.IllegalCharsetNameException;\n
  import java.util.regex.Matcher;\n import java.util.regex.Pattern;\n import java.util.Locale;\n@@
  -17,7 +16,7 @@\n  *\n  */\n public class DataUtil {\n-    private static final Pattern
  charsetPattern = Pattern.compile(\"(?i)\\\\bcharset=\\\\s*(?:\\\"|')?([^\\\\s,;\\\"']*)\");\n+
  \   private static final Pattern charsetPattern = Pattern.compile(\"(?i)\\\\bcharset=\\\\s*\\\"?([^\\\\s;\\\"]*)\");\n
  \    static final String defaultCharset = \"UTF-8\"; // used if not found in header
  or meta charset\n     private static final int bufferSize = 0x20000; // ~130K.\n
  \n@@ -85,21 +84,11 @@\n                 String foundCharset;\n                 if
  (meta.hasAttr(\"http-equiv\")) {\n                     foundCharset = getCharsetFromContentType(meta.attr(\"content\"));\n-
  \                   if (foundCharset == null && meta.hasAttr(\"charset\")) {\n-
  \                       try {\n-                            if (Charset.isSupported(meta.attr(\"charset\")))
  {\n-                                foundCharset = meta.attr(\"charset\");\n-                            }\n-
  \                       } catch (IllegalCharsetNameException e) {\n-                            foundCharset
  = null;\n-                        }\n-                    }\n                 }
  else {\n                     foundCharset = meta.attr(\"charset\");\n                 }\n
  \n                 if (foundCharset != null && foundCharset.length() != 0 && !foundCharset.equals(defaultCharset))
  { // need to re-decode\n-                    foundCharset = foundCharset.trim().replaceAll(\"[\\\"']\",
  \"\");\n                     charsetName = foundCharset;\n                     byteData.rewind();\n
  \                    docData = Charset.forName(foundCharset).decode(byteData).toString();\n@@
  -169,16 +158,10 @@\n         Matcher m = charsetPattern.matcher(contentType);\n
  \        if (m.find()) {\n             String charset = m.group(1).trim();\n-            charset
  = charset.replace(\"charset=\", \"\");\n-            if (charset.isEmpty()) return
  null;\n-            try {\n                 if (Charset.isSupported(charset)) return
  charset;\n                 charset = charset.toUpperCase(Locale.ENGLISH);\n                 if
  (Charset.isSupported(charset)) return charset;\n-            } catch (IllegalCharsetNameException
  e) {\n                 // if our advanced charset matching fails.... we just take
  the default\n-                return null;\n-            }\n         }\n         return
  null;\n     }\n"
tree_diff: |+
  New cluster:
  UPDATE from private static final Pattern charsetPattern = Pattern.compile("(?i)\\bcharset=\\s*(?:\"|')?([^\\s,;\"']*)"); to private static final Pattern charsetPattern = Pattern.compile("(?i)\\bcharset=\\s*\"?([^\\s;\"]*)");
  ------------
  ===
  update-node
  ---
  field_declaration: private static final Pattern charsetPattern = Pattern.compile("(?i)\\bcharset=\\s*(?:\"|')?([^\\s,;\"']*)"); [434,542]
  replace private static final Pattern charsetPattern = Pattern.compile("(?i)\\bcharset=\\s*(?:\"|')?([^\\s,;\"']*)"); by private static final Pattern charsetPattern = Pattern.compile("(?i)\\bcharset=\\s*\"?([^\\s;\"]*)");

  New cluster:
  MOVE from method_declaration [7266,8039]
  ------------
  ===
  move-tree
  ---
  block [7453,8012]
      local_variable_declaration: String charset = m.group(1).trim(); [7467,7502]
      expression_statement: charset = charset.replace("charset=", ""); [7515,7557]
      if_statement [7570,7605]
          parenthesized_expression [7573,7592]
              method_invocation: charset.isEmpty() [7574,7591]
          return_statement: return null; [7593,7605]
      try_statement [7618,8002]
          block [7622,7832]
              if_statement [7640,7689]
                  parenthesized_expression [7643,7673]
                      method_invocation: Charset.isSupported(charset) [7644,7672]
                  return_statement: return charset; [7674,7689]
              expression_statement: charset = charset.toUpperCase(Locale.ENGLISH); [7706,7752]
              if_statement [7769,7818]
                  parenthesized_expression [7772,7802]
                      method_invocation: Charset.isSupported(charset) [7773,7801]
                  return_statement: return charset; [7803,7818]
          excepts [7618,8002]
              catch_clause: catch (IllegalCharsetNameException e) {
                  // if our advanced charset matching fails.... we just take the default
                  return null;
              } [7833,8002]
  to
  method_declaration [7266,8039]
  at 2
  ===
  move-tree
  ---
  parenthesized_expression [7442,7452]
      method_invocation: m.find() [7443,7451]
  to
  if_statement [7570,7605]
  at 0

  New cluster:
  MOVE from block [7453,8012]
  ------------
  ===
  move-tree
  ---
  if_statement [7336,7373]
      parenthesized_expression [7339,7360]
          equals [7340,7359]
              identifier: contentType [7340,7351]
              null_literal [7355,7359]
      return_statement: return null; [7361,7373]
  to
  block [7453,8012]
  at 0

  New cluster:
  UPDATE from String charset = m.group(1).trim(); to Matcher m = charsetPattern.matcher(contentType);
  ------------
  ===
  update-node
  ---
  local_variable_declaration: String charset = m.group(1).trim(); [7467,7502]
  replace String charset = m.group(1).trim(); by Matcher m = charsetPattern.matcher(contentType);

  New cluster:
  ===
  insert-node
  ---
  return_statement: return null; [7218,7230]
  to
  block [7453,8012]
  at 4
  ------------
  ===
  insert-node
  ---
  return_statement: return null; [7218,7230]
  to
  block [7453,8012]
  at 4

  New cluster:
  MOVE from if_statement [7570,7605]
  ------------
  ===
  move-tree
  ---
  block [7622,7832]
      if_statement [7640,7689]
          parenthesized_expression [7643,7673]
              method_invocation: Charset.isSupported(charset) [7644,7672]
          return_statement: return charset; [7674,7689]
      expression_statement: charset = charset.toUpperCase(Locale.ENGLISH); [7706,7752]
      if_statement [7769,7818]
          parenthesized_expression [7772,7802]
              method_invocation: Charset.isSupported(charset) [7773,7801]
          return_statement: return charset; [7803,7818]
  to
  if_statement [7570,7605]
  at 1

  New cluster:
  ===
  insert-node
  ---
  local_variable_declaration: String charset = m.group(1).trim(); [6882,6917]
  to
  block [7622,7832]
  at 0
  ------------
  ===
  insert-node
  ---
  local_variable_declaration: String charset = m.group(1).trim(); [6882,6917]
  to
  block [7622,7832]
  at 0

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  if_statement [3756,4179]
      parenthesized_expression [3759,3808]
          and [3760,3807]
              equals [3760,3780]
                  identifier: foundCharset [3760,3772]
                  null_literal [3776,3780]
              method_invocation: meta.hasAttr("charset") [3784,3807]
      block [3809,4179]
          try_statement [3835,4157]
              block [3839,4042]
                  if_statement [3869,4016]
                      parenthesized_expression [3872,3915]
                          method_invocation: Charset.isSupported(meta.attr("charset")) [3873,3914]
                      block [3916,4016]
                          expression_statement: foundCharset = meta.attr("charset"); [3950,3986]
              excepts [3835,4157]
                  catch_clause: catch (IllegalCharsetNameException e) {
                              foundCharset = null;
                          } [4043,4157]

  New cluster:
  ===
  delete-node
  ---
  expression_statement: foundCharset = foundCharset.trim().replaceAll("[\"']", ""); [4436,4495]
  ===
  ------------
  ===
  delete-node
  ---
  expression_statement: foundCharset = foundCharset.trim().replaceAll("[\"']", ""); [4436,4495]
  ===

  New cluster:
  ===
  delete-node
  ---
  expression_statement: charset = charset.replace("charset=", ""); [7515,7557]
  ===
  ------------
  ===
  delete-node
  ---
  expression_statement: charset = charset.replace("charset=", ""); [7515,7557]
  ===

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  parenthesized_expression [7573,7592]
      method_invocation: charset.isEmpty() [7574,7591]

  New cluster:
  ===
  delete-node
  ---
  return_statement: return null; [7593,7605]
  ===
  ------------
  ===
  delete-node
  ---
  return_statement: return null; [7593,7605]
  ===

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  excepts [7618,8002]
      catch_clause: catch (IllegalCharsetNameException e) {
                  // if our advanced charset matching fails.... we just take the default
                  return null;
              } [7833,8002]

  New cluster:
  ===
  delete-node
  ---
  try_statement [7618,8002]
  ===
  ------------
  ===
  delete-node
  ---
  try_statement [7618,8002]
  ===

  New cluster:
  ===
  delete-node
  ---
  block [7326,8039]
  ===
  ------------
  ===
  delete-node
  ---
  block [7326,8039]
  ===
  ===
  delete-node
  ---
  return_statement: return null; [8021,8033]
  ===
  ===
  delete-node
  ---
  if_statement [7439,8012]
  ===
  ===
  delete-node
  ---
  local_variable_declaration: Matcher m = charsetPattern.matcher(contentType); [7382,7430]
  ===

...
