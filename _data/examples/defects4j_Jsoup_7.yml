---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: Document
        children: []
        pos: 334
        length: 8
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private OutputSettings outputSettings = new OutputSettings();
          children: []
          pos: 365
          length: 61
        - type: constructor_declaration
          fields:
            text: |-
              public Document(String baseUri) {
                      super(Tag.valueOf("#root"), baseUri);
                  }
          children: []
          pos: 579
          length: 85
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: createShell
              children: []
              pos: 893
              length: 11
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String baseUri
                children: []
                pos: 905
                length: 14
              pos: 870
              length: 283
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: Validate.notNull(baseUri);
                children: []
                pos: 931
                length: 26
              - type: local_variable_declaration
                fields:
                  text: Document doc = new Document(baseUri);
                children: []
                pos: 967
                length: 37
              - type: local_variable_declaration
                fields:
                  text: Element html = doc.appendElement("html");
                children: []
                pos: 1013
                length: 41
              - type: expression_statement
                fields:
                  text: html.appendElement("head");
                children: []
                pos: 1063
                length: 27
              - type: expression_statement
                fields:
                  text: html.appendElement("body");
                children: []
                pos: 1099
                length: 27
              - type: return_statement
                fields:
                  text: return doc;
                children: []
                pos: 1136
                length: 11
              pos: 921
              length: 232
          children: []
          pos: 870
          length: 283
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: head
              children: []
              pos: 1270
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 1255
              length: 85
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return findFirstElementByTagName("head", this);
                children: []
                pos: 1287
                length: 47
              pos: 1277
              length: 63
          children: []
          pos: 1255
          length: 85
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: body
              children: []
              pos: 1457
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 1442
              length: 85
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return findFirstElementByTagName("body", this);
                children: []
                pos: 1474
                length: 47
              pos: 1464
              length: 63
          children: []
          pos: 1442
          length: 85
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: title
              children: []
              pos: 1689
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 1675
              length: 151
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Element titleEl = getElementsByTag("title").first();
                children: []
                pos: 1707
                length: 52
              - type: return_statement
                fields:
                  text: 'return titleEl != null ? titleEl.text().trim() : "";'
                children: []
                pos: 1768
                length: 52
              pos: 1697
              length: 129
          children: []
          pos: 1675
          length: 151
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: title
              children: []
              pos: 2036
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String title
                children: []
                pos: 2042
                length: 12
              pos: 2024
              length: 294
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: Validate.notNull(title);
                children: []
                pos: 2066
                length: 24
              - type: local_variable_declaration
                fields:
                  text: Element titleEl = getElementsByTag("title").first();
                children: []
                pos: 2099
                length: 52
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: titleEl
                            children: []
                            pos: 2164
                            length: 7
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 2175
                            length: 4
                        children: []
                        pos: 2164
                        length: 15
                    children: []
                    pos: 2163
                    length: 17
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: head().appendElement("title").text(title);
                    children: []
                    pos: 2210
                    length: 42
                  pos: 2181
                  length: 81
                pos: 2160
                length: 152
              pos: 2056
              length: 262
          children: []
          pos: 2024
          length: 294
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: createElement
              children: []
              pos: 2548
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String tagName
                children: []
                pos: 2562
                length: 14
              pos: 2533
              length: 118
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return new Element(Tag.valueOf(tagName), this.baseUri());
                children: []
                pos: 2588
                length: 57
              pos: 2578
              length: 73
          children: []
          pos: 2533
          length: 118
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: normalise
              children: []
              pos: 2916
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 2900
              length: 717
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Element htmlEl = findFirstElementByTagName("html", this);
                children: []
                pos: 2938
                length: 57
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: htmlEl
                            children: []
                            pos: 3008
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3018
                            length: 4
                        children: []
                        pos: 3008
                        length: 14
                    children: []
                    pos: 3007
                    length: 16
                children:
                - type: expression_statement
                  fields:
                    text: htmlEl = appendElement("html");
                  children: []
                  pos: 3036
                  length: 31
                pos: 3004
                length: 63
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: head()
                            children: []
                            pos: 3080
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3090
                            length: 4
                        children: []
                        pos: 3080
                        length: 14
                    children: []
                    pos: 3079
                    length: 16
                children:
                - type: expression_statement
                  fields:
                    text: htmlEl.prependElement("head");
                  children: []
                  pos: 3108
                  length: 30
                pos: 3076
                length: 62
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: body()
                            children: []
                            pos: 3151
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3161
                            length: 4
                        children: []
                        pos: 3151
                        length: 14
                    children: []
                    pos: 3150
                    length: 16
                children:
                - type: expression_statement
                  fields:
                    text: htmlEl.appendElement("body");
                  children: []
                  pos: 3179
                  length: 29
                pos: 3147
                length: 61
              - type: expression_statement
                fields:
                  text: normaliseTextNodes(head());
                children: []
                pos: 3395
                length: 27
              - type: expression_statement
                fields:
                  text: normaliseTextNodes(htmlEl);
                children: []
                pos: 3431
                length: 27
              - type: expression_statement
                fields:
                  text: normaliseTextNodes(this);
                children: []
                pos: 3467
                length: 25
              - type: expression_statement
                fields:
                  text: normaliseStructure("head", htmlEl);
                children: []
                pos: 3502
                length: 35
              - type: expression_statement
                fields:
                  text: normaliseStructure("body", htmlEl);
                children: []
                pos: 3546
                length: 35
              - type: return_statement
                fields:
                  text: return this;
                children: []
                pos: 3599
                length: 12
              pos: 2928
              length: 689
          children: []
          pos: 2900
          length: 717
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: normaliseTextNodes
              children: []
              pos: 3661
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Element element
                children: []
                pos: 3680
                length: 15
              pos: 3648
              length: 576
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: List<Node> toMove = new ArrayList<Node>();
                children: []
                pos: 3707
                length: 42
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (Node node: element.childNodes) {
                                if (node instanceof TextNode) {
                                    TextNode tn = (TextNode) node;
                                    if (!tn.isBlank())
                                        toMove.add(tn);
                                }
                            }
                children: []
                pos: 3758
                length: 223
              - type: for_statement
                fields:
                  text: |-
                    for (int i = toMove.size()-1; i >= 0; i--) {
                                Node node = toMove.get(i);
                                element.removeChild(node);
                                body().prependChild(new TextNode(" ", ""));
                                body().prependChild(node);
                            }
                children: []
                pos: 3991
                length: 227
              pos: 3697
              length: 527
          children: []
          pos: 3648
          length: 576
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: normaliseStructure
              children: []
              pos: 4359
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String tag
                children: []
                pos: 4378
                length: 10
              pos: 4346
              length: 842
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Elements elements = this.getElementsByTag(tag);
                children: []
                pos: 4416
                length: 47
              - type: local_variable_declaration
                fields:
                  text: Element master = elements.first();
                children: []
                pos: 4472
                length: 34
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: greater_than
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: elements.size()
                            children: []
                            pos: 4580
                            length: 15
                          right:
                            type: decimal_integer_literal
                            fields:
                              text: '1'
                            children: []
                            pos: 4598
                            length: 1
                        children: []
                        pos: 4580
                        length: 19
                    children: []
                    pos: 4579
                    length: 21
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: List<Node> toMove = new ArrayList<Node>();
                    children: []
                    pos: 4649
                    length: 42
                  - type: for_statement
                    fields:
                      text: |-
                        for (int i = 1; i < elements.size(); i++) {
                                        Node dupe = elements.get(i);
                                        for (Node node : dupe.childNodes)
                                            toMove.add(node);
                                        dupe.remove();
                                    }
                    children: []
                    pos: 4704
                    length: 221
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Node dupe : toMove)
                                        master.appendChild(dupe);
                    children: []
                    pos: 4939
                    length: 66
                  pos: 4601
                  length: 414
                pos: 4576
                length: 439
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!master.parent().equals(htmlEl)"
                        children: []
                        pos: 5065
                        length: 31
                    children: []
                    pos: 5064
                    length: 33
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: htmlEl.appendChild(master);
                    children: []
                    pos: 5112
                    length: 27
                  pos: 5098
                  length: 84
                pos: 5061
                length: 121
              pos: 4406
              length: 782
          children: []
          pos: 4346
          length: 842
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: findFirstElementByTagName
              children: []
              pos: 5289
              length: 25
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String tag
                children: []
                pos: 5315
                length: 10
              pos: 5273
              length: 396
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: node.nodeName().equals(tag)
                        children: []
                        pos: 5352
                        length: 27
                    children: []
                    pos: 5351
                    length: 29
                children:
                - type: return_statement
                  fields:
                    text: return (Element) node;
                  children: []
                  pos: 5393
                  length: 22
                pos: 5348
                length: 294
              - type: return_statement
                fields:
                  text: return null;
                children: []
                pos: 5651
                length: 12
              pos: 5338
              length: 331
          children: []
          pos: 5273
          length: 396
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: outerHtml
              children: []
              pos: 5703
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5675
              length: 100
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return super.html();
                children: []
                pos: 5725
                length: 20
              pos: 5715
              length: 60
          children: []
          pos: 5675
          length: 100
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: text
              children: []
              pos: 5993
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String text
                children: []
                pos: 5998
                length: 11
              pos: 5964
              length: 142
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: body().text(text);
                children: []
                pos: 6021
                length: 18
              - type: return_statement
                fields:
                  text: return this;
                children: []
                pos: 6088
                length: 12
              pos: 6011
              length: 95
          children: []
          pos: 5964
          length: 142
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: nodeName
              children: []
              pos: 6140
              length: 8
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6112
              length: 74
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return "#document";
                children: []
                pos: 6161
                length: 19
              pos: 6151
              length: 35
          children: []
          pos: 6112
          length: 74
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: OutputSettings
              children: []
              pos: 6308
              length: 14
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private Entities.EscapeMode escapeMode = Entities.EscapeMode.base;
                children: []
                pos: 6333
                length: 66
              - type: field_declaration
                fields:
                  text: private Charset charset = Charset.forName("UTF-8");
                children: []
                pos: 6408
                length: 51
              - type: field_declaration
                fields:
                  text: private CharsetEncoder charsetEncoder = charset.newEncoder();
                children: []
                pos: 6468
                length: 61
              - type: field_declaration
                fields:
                  text: private boolean prettyPrint = true;
                children: []
                pos: 6538
                length: 35
              - type: field_declaration
                fields:
                  text: private int indentAmount = 1;
                children: []
                pos: 6582
                length: 29
              - type: constructor_declaration
                fields:
                  text: public OutputSettings() {}
                children: []
                pos: 6621
                length: 26
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: escapeMode
                    children: []
                    pos: 7138
                    length: 10
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 7111
                    length: 82
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return escapeMode;
                      children: []
                      pos: 7165
                      length: 18
                    pos: 7151
                    length: 42
                children: []
                pos: 7111
                length: 82
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: escapeMode
                    children: []
                    pos: 7411
                    length: 10
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Entities.EscapeMode escapeMode
                      children: []
                      pos: 7422
                      length: 30
                    pos: 7389
                    length: 143
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: this.escapeMode = escapeMode;
                      children: []
                      pos: 7468
                      length: 29
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 7510
                      length: 12
                    pos: 7454
                    length: 78
                children: []
                pos: 7389
                length: 143
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: charset
                    children: []
                    pos: 8031
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 8016
                    length: 64
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return charset;
                      children: []
                      pos: 8055
                      length: 15
                    pos: 8041
                    length: 39
                children: []
                pos: 8016
                length: 64
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: charset
                    children: []
                    pos: 8299
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Charset charset
                      children: []
                      pos: 8307
                      length: 15
                    pos: 8277
                    length: 242
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: this.charset = charset;
                      children: []
                      pos: 8410
                      length: 23
                    - type: expression_statement
                      fields:
                        text: charsetEncoder = charset.newEncoder();
                      children: []
                      pos: 8446
                      length: 38
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 8497
                      length: 12
                    pos: 8324
                    length: 195
                children: []
                pos: 8277
                length: 242
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: charset
                    children: []
                    pos: 8748
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: String charset
                      children: []
                      pos: 8756
                      length: 14
                    pos: 8726
                    length: 129
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: charset(Charset.forName(charset));
                      children: []
                      pos: 8786
                      length: 34
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 8833
                      length: 12
                    pos: 8772
                    length: 83
                children: []
                pos: 8726
                length: 129
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: encoder
                    children: []
                    pos: 8880
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 8865
                    length: 71
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return charsetEncoder;
                      children: []
                      pos: 8904
                      length: 22
                    pos: 8890
                    length: 46
                children: []
                pos: 8865
                length: 71
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: prettyPrint
                    children: []
                    pos: 9228
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 9213
                    length: 72
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return prettyPrint;
                      children: []
                      pos: 9256
                      length: 19
                    pos: 9242
                    length: 43
                children: []
                pos: 9213
                length: 72
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: prettyPrint
                    children: []
                    pos: 9475
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: boolean pretty
                      children: []
                      pos: 9487
                      length: 14
                    pos: 9453
                    length: 120
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: prettyPrint = pretty;
                      children: []
                      pos: 9517
                      length: 21
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 9551
                      length: 12
                    pos: 9503
                    length: 70
                children: []
                pos: 9453
                length: 120
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: indentAmount
                    children: []
                    pos: 9736
                    length: 12
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 9725
                    length: 70
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return indentAmount;
                      children: []
                      pos: 9765
                      length: 20
                    pos: 9751
                    length: 44
                children: []
                pos: 9725
                length: 70
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: indentAmount
                    children: []
                    pos: 10037
                    length: 12
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: int indentAmount
                      children: []
                      pos: 10050
                      length: 16
                    pos: 10015
                    length: 183
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: Validate.isTrue(indentAmount >= 0);
                      children: []
                      pos: 10082
                      length: 35
                    - type: expression_statement
                      fields:
                        text: this.indentAmount = indentAmount;
                      children: []
                      pos: 10130
                      length: 33
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 10176
                      length: 12
                    pos: 10068
                    length: 130
                children: []
                pos: 10015
                length: 183
              pos: 6295
              length: 3909
          children: []
          pos: 6295
          length: 3909
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: outputSettings
              children: []
              pos: 10354
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 10332
              length: 77
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return outputSettings;
                children: []
                pos: 10381
                length: 22
              pos: 10371
              length: 38
          children: []
          pos: 10332
          length: 77
        pos: 321
        length: 10090
    children: []
    pos: 321
    length: 10090
  pos: 0
  length: 10413
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: Document
        children: []
        pos: 300
        length: 8
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private OutputSettings outputSettings = new OutputSettings();
          children: []
          pos: 331
          length: 61
        - type: constructor_declaration
          fields:
            text: |-
              public Document(String baseUri) {
                      super(Tag.valueOf("#root"), baseUri);
                  }
          children: []
          pos: 545
          length: 85
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: createShell
              children: []
              pos: 859
              length: 11
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String baseUri
                children: []
                pos: 871
                length: 14
              pos: 836
              length: 283
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: Validate.notNull(baseUri);
                children: []
                pos: 897
                length: 26
              - type: local_variable_declaration
                fields:
                  text: Document doc = new Document(baseUri);
                children: []
                pos: 933
                length: 37
              - type: local_variable_declaration
                fields:
                  text: Element html = doc.appendElement("html");
                children: []
                pos: 979
                length: 41
              - type: expression_statement
                fields:
                  text: html.appendElement("head");
                children: []
                pos: 1029
                length: 27
              - type: expression_statement
                fields:
                  text: html.appendElement("body");
                children: []
                pos: 1065
                length: 27
              - type: return_statement
                fields:
                  text: return doc;
                children: []
                pos: 1102
                length: 11
              pos: 887
              length: 232
          children: []
          pos: 836
          length: 283
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: head
              children: []
              pos: 1236
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 1221
              length: 85
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return findFirstElementByTagName("head", this);
                children: []
                pos: 1253
                length: 47
              pos: 1243
              length: 63
          children: []
          pos: 1221
          length: 85
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: body
              children: []
              pos: 1423
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 1408
              length: 85
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return findFirstElementByTagName("body", this);
                children: []
                pos: 1440
                length: 47
              pos: 1430
              length: 63
          children: []
          pos: 1408
          length: 85
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: title
              children: []
              pos: 1655
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 1641
              length: 151
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Element titleEl = getElementsByTag("title").first();
                children: []
                pos: 1673
                length: 52
              - type: return_statement
                fields:
                  text: 'return titleEl != null ? titleEl.text().trim() : "";'
                children: []
                pos: 1734
                length: 52
              pos: 1663
              length: 129
          children: []
          pos: 1641
          length: 151
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: title
              children: []
              pos: 2002
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String title
                children: []
                pos: 2008
                length: 12
              pos: 1990
              length: 294
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: Validate.notNull(title);
                children: []
                pos: 2032
                length: 24
              - type: local_variable_declaration
                fields:
                  text: Element titleEl = getElementsByTag("title").first();
                children: []
                pos: 2065
                length: 52
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: titleEl
                            children: []
                            pos: 2130
                            length: 7
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 2141
                            length: 4
                        children: []
                        pos: 2130
                        length: 15
                    children: []
                    pos: 2129
                    length: 17
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: head().appendElement("title").text(title);
                    children: []
                    pos: 2176
                    length: 42
                  pos: 2147
                  length: 81
                pos: 2126
                length: 152
              pos: 2022
              length: 262
          children: []
          pos: 1990
          length: 294
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: createElement
              children: []
              pos: 2514
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String tagName
                children: []
                pos: 2528
                length: 14
              pos: 2499
              length: 118
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return new Element(Tag.valueOf(tagName), this.baseUri());
                children: []
                pos: 2554
                length: 57
              pos: 2544
              length: 73
          children: []
          pos: 2499
          length: 118
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: normalise
              children: []
              pos: 2882
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 2866
              length: 629
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Element htmlEl = findFirstElementByTagName("html", this);
                children: []
                pos: 2904
                length: 57
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: htmlEl
                            children: []
                            pos: 2974
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 2984
                            length: 4
                        children: []
                        pos: 2974
                        length: 14
                    children: []
                    pos: 2973
                    length: 16
                children:
                - type: expression_statement
                  fields:
                    text: htmlEl = appendElement("html");
                  children: []
                  pos: 3002
                  length: 31
                pos: 2970
                length: 63
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: head()
                            children: []
                            pos: 3046
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3056
                            length: 4
                        children: []
                        pos: 3046
                        length: 14
                    children: []
                    pos: 3045
                    length: 16
                children:
                - type: expression_statement
                  fields:
                    text: htmlEl.prependElement("head");
                  children: []
                  pos: 3074
                  length: 30
                pos: 3042
                length: 62
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: body()
                            children: []
                            pos: 3117
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3127
                            length: 4
                        children: []
                        pos: 3117
                        length: 14
                    children: []
                    pos: 3116
                    length: 16
                children:
                - type: expression_statement
                  fields:
                    text: htmlEl.appendElement("body");
                  children: []
                  pos: 3145
                  length: 29
                pos: 3113
                length: 61
              - type: expression_statement
                fields:
                  text: normaliseTextNodes(head());
                children: []
                pos: 3361
                length: 27
              - type: expression_statement
                fields:
                  text: normaliseTextNodes(htmlEl);
                children: []
                pos: 3397
                length: 27
              - type: expression_statement
                fields:
                  text: normaliseTextNodes(this);
                children: []
                pos: 3433
                length: 25
              - type: return_statement
                fields:
                  text: return this;
                children: []
                pos: 3477
                length: 12
              pos: 2894
              length: 601
          children: []
          pos: 2866
          length: 629
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: normaliseTextNodes
              children: []
              pos: 3539
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Element element
                children: []
                pos: 3558
                length: 15
              pos: 3526
              length: 576
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: List<Node> toMove = new ArrayList<Node>();
                children: []
                pos: 3585
                length: 42
              - type: enhanced_for_statement
                fields:
                  text: |-
                    for (Node node: element.childNodes) {
                                if (node instanceof TextNode) {
                                    TextNode tn = (TextNode) node;
                                    if (!tn.isBlank())
                                        toMove.add(tn);
                                }
                            }
                children: []
                pos: 3636
                length: 223
              - type: for_statement
                fields:
                  text: |-
                    for (int i = toMove.size()-1; i >= 0; i--) {
                                Node node = toMove.get(i);
                                element.removeChild(node);
                                body().prependChild(new TextNode(" ", ""));
                                body().prependChild(node);
                            }
                children: []
                pos: 3869
                length: 227
              pos: 3575
              length: 527
          children: []
          pos: 3526
          length: 576
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: findFirstElementByTagName
              children: []
              pos: 4357
              length: 25
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String tag
                children: []
                pos: 4383
                length: 10
              pos: 4341
              length: 396
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: node.nodeName().equals(tag)
                        children: []
                        pos: 4420
                        length: 27
                    children: []
                    pos: 4419
                    length: 29
                children:
                - type: return_statement
                  fields:
                    text: return (Element) node;
                  children: []
                  pos: 4461
                  length: 22
                pos: 4416
                length: 294
              - type: return_statement
                fields:
                  text: return null;
                children: []
                pos: 4719
                length: 12
              pos: 4406
              length: 331
          children: []
          pos: 4341
          length: 396
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: outerHtml
              children: []
              pos: 4771
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 4743
              length: 100
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return super.html();
                children: []
                pos: 4793
                length: 20
              pos: 4783
              length: 60
          children: []
          pos: 4743
          length: 100
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: text
              children: []
              pos: 5061
              length: 4
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String text
                children: []
                pos: 5066
                length: 11
              pos: 5032
              length: 142
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: body().text(text);
                children: []
                pos: 5089
                length: 18
              - type: return_statement
                fields:
                  text: return this;
                children: []
                pos: 5156
                length: 12
              pos: 5079
              length: 95
          children: []
          pos: 5032
          length: 142
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: nodeName
              children: []
              pos: 5208
              length: 8
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5180
              length: 74
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return "#document";
                children: []
                pos: 5229
                length: 19
              pos: 5219
              length: 35
          children: []
          pos: 5180
          length: 74
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: OutputSettings
              children: []
              pos: 5376
              length: 14
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private Entities.EscapeMode escapeMode = Entities.EscapeMode.base;
                children: []
                pos: 5401
                length: 66
              - type: field_declaration
                fields:
                  text: private Charset charset = Charset.forName("UTF-8");
                children: []
                pos: 5476
                length: 51
              - type: field_declaration
                fields:
                  text: private CharsetEncoder charsetEncoder = charset.newEncoder();
                children: []
                pos: 5536
                length: 61
              - type: field_declaration
                fields:
                  text: private boolean prettyPrint = true;
                children: []
                pos: 5606
                length: 35
              - type: field_declaration
                fields:
                  text: private int indentAmount = 1;
                children: []
                pos: 5650
                length: 29
              - type: constructor_declaration
                fields:
                  text: public OutputSettings() {}
                children: []
                pos: 5689
                length: 26
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: escapeMode
                    children: []
                    pos: 6206
                    length: 10
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 6179
                    length: 82
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return escapeMode;
                      children: []
                      pos: 6233
                      length: 18
                    pos: 6219
                    length: 42
                children: []
                pos: 6179
                length: 82
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: escapeMode
                    children: []
                    pos: 6479
                    length: 10
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Entities.EscapeMode escapeMode
                      children: []
                      pos: 6490
                      length: 30
                    pos: 6457
                    length: 143
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: this.escapeMode = escapeMode;
                      children: []
                      pos: 6536
                      length: 29
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 6578
                      length: 12
                    pos: 6522
                    length: 78
                children: []
                pos: 6457
                length: 143
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: charset
                    children: []
                    pos: 7099
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 7084
                    length: 64
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return charset;
                      children: []
                      pos: 7123
                      length: 15
                    pos: 7109
                    length: 39
                children: []
                pos: 7084
                length: 64
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: charset
                    children: []
                    pos: 7367
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Charset charset
                      children: []
                      pos: 7375
                      length: 15
                    pos: 7345
                    length: 242
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: this.charset = charset;
                      children: []
                      pos: 7478
                      length: 23
                    - type: expression_statement
                      fields:
                        text: charsetEncoder = charset.newEncoder();
                      children: []
                      pos: 7514
                      length: 38
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 7565
                      length: 12
                    pos: 7392
                    length: 195
                children: []
                pos: 7345
                length: 242
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: charset
                    children: []
                    pos: 7816
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: String charset
                      children: []
                      pos: 7824
                      length: 14
                    pos: 7794
                    length: 129
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: charset(Charset.forName(charset));
                      children: []
                      pos: 7854
                      length: 34
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 7901
                      length: 12
                    pos: 7840
                    length: 83
                children: []
                pos: 7794
                length: 129
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: encoder
                    children: []
                    pos: 7948
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 7933
                    length: 71
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return charsetEncoder;
                      children: []
                      pos: 7972
                      length: 22
                    pos: 7958
                    length: 46
                children: []
                pos: 7933
                length: 71
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: prettyPrint
                    children: []
                    pos: 8296
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 8281
                    length: 72
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return prettyPrint;
                      children: []
                      pos: 8324
                      length: 19
                    pos: 8310
                    length: 43
                children: []
                pos: 8281
                length: 72
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: prettyPrint
                    children: []
                    pos: 8543
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: boolean pretty
                      children: []
                      pos: 8555
                      length: 14
                    pos: 8521
                    length: 120
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: prettyPrint = pretty;
                      children: []
                      pos: 8585
                      length: 21
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 8619
                      length: 12
                    pos: 8571
                    length: 70
                children: []
                pos: 8521
                length: 120
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: indentAmount
                    children: []
                    pos: 8804
                    length: 12
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 8793
                    length: 70
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return indentAmount;
                      children: []
                      pos: 8833
                      length: 20
                    pos: 8819
                    length: 44
                children: []
                pos: 8793
                length: 70
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: indentAmount
                    children: []
                    pos: 9105
                    length: 12
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: int indentAmount
                      children: []
                      pos: 9118
                      length: 16
                    pos: 9083
                    length: 183
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: Validate.isTrue(indentAmount >= 0);
                      children: []
                      pos: 9150
                      length: 35
                    - type: expression_statement
                      fields:
                        text: this.indentAmount = indentAmount;
                      children: []
                      pos: 9198
                      length: 33
                    - type: return_statement
                      fields:
                        text: return this;
                      children: []
                      pos: 9244
                      length: 12
                    pos: 9136
                    length: 130
                children: []
                pos: 9083
                length: 183
              pos: 5363
              length: 3909
          children: []
          pos: 5363
          length: 3909
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: outputSettings
              children: []
              pos: 9422
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 9400
              length: 77
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return outputSettings;
                children: []
                pos: 9449
                length: 22
              pos: 9439
              length: 38
          children: []
          pos: 9400
          length: 77
        pos: 287
        length: 9192
    children: []
    pos: 287
    length: 9192
  pos: 0
  length: 9481
text_diff: "--- before\n+++ after\n@@ -2,7 +2,6 @@\n \n import org.jsoup.helper.Validate;\n
  import org.jsoup.parser.Tag;\n-import org.jsoup.select.Elements;\n \n import java.nio.charset.Charset;\n
  import java.nio.charset.CharsetEncoder;\n@@ -111,8 +110,6 @@\n         normaliseTextNodes(htmlEl);\n
  \        normaliseTextNodes(this);\n \n-        normaliseStructure(\"head\", htmlEl);\n-
  \       normaliseStructure(\"body\", htmlEl);\n         \n         return this;\n
  \    }\n@@ -137,26 +134,7 @@\n     }\n \n     // merge multiple <head> or <body>
  contents into one, delete the remainder, and ensure they are owned by <html>\n-
  \   private void normaliseStructure(String tag, Element htmlEl) {\n-        Elements
  elements = this.getElementsByTag(tag);\n-        Element master = elements.first();
  // will always be available as created above if not existent\n-        if (elements.size()
  > 1) { // dupes, move contents to master\n-            List<Node> toMove = new ArrayList<Node>();\n-
  \           for (int i = 1; i < elements.size(); i++) {\n-                Node dupe
  = elements.get(i);\n-                for (Node node : dupe.childNodes)\n-                    toMove.add(node);\n-
  \               dupe.remove();\n-            }\n-\n-            for (Node dupe :
  toMove)\n-                master.appendChild(dupe);\n-        }\n         // ensure
  parented by <html>\n-        if (!master.parent().equals(htmlEl)) {\n-            htmlEl.appendChild(master);
  // includes remove()            \n-        }\n-    }\n \n     // fast method to
  get first by tag name, used for html, head, body finders\n     private Element findFirstElementByTagName(String
  tag, Node node) {\n"
tree_diff: |+
  New cluster:
  ===
  delete-node
  ---
  expression_statement: normaliseStructure("head", htmlEl); [3502,3537]
  ===
  ------------
  ===
  delete-node
  ---
  expression_statement: normaliseStructure("head", htmlEl); [3502,3537]
  ===

  New cluster:
  ===
  delete-node
  ---
  expression_statement: normaliseStructure("body", htmlEl); [3546,3581]
  ===
  ------------
  ===
  delete-node
  ---
  expression_statement: normaliseStructure("body", htmlEl); [3546,3581]
  ===

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  method_declaration [4346,5188]
      identifier: normaliseStructure [4359,4377]
      method_parameters [4346,5188]
          formal_parameter: String tag [4378,4388]
      block [4406,5188]
          local_variable_declaration: Elements elements = this.getElementsByTag(tag); [4416,4463]
          local_variable_declaration: Element master = elements.first(); [4472,4506]
          if_statement [4576,5015]
              parenthesized_expression [4579,4600]
                  greater_than [4580,4599]
                      method_invocation: elements.size() [4580,4595]
                      decimal_integer_literal: 1 [4598,4599]
              block [4601,5015]
                  local_variable_declaration: List<Node> toMove = new ArrayList<Node>(); [4649,4691]
                  for_statement: for (int i = 1; i < elements.size(); i++) {
                  Node dupe = elements.get(i);
                  for (Node node : dupe.childNodes)
                      toMove.add(node);
                  dupe.remove();
              } [4704,4925]
                  enhanced_for_statement: for (Node dupe : toMove)
                  master.appendChild(dupe); [4939,5005]
          if_statement [5061,5182]
              parenthesized_expression [5064,5097]
                  unary_expression: !master.parent().equals(htmlEl) [5065,5096]
              block [5098,5182]
                  expression_statement: htmlEl.appendChild(master); [5112,5139]

...
