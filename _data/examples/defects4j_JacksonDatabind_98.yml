---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: ExternalTypeHandler
        children: []
        pos: 744
        length: 19
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private final JavaType _beanType;
          children: []
          pos: 770
          length: 33
        - type: field_declaration
          fields:
            text: private final ExtTypedProperty[] _properties;
          children: []
          pos: 809
          length: 45
        - type: field_declaration
          fields:
            text: private final Map<String, Object> _nameToPropertyIndex;
          children: []
          pos: 1106
          length: 55
        - type: field_declaration
          fields:
            text: private final String[] _typeIds;
          children: []
          pos: 1167
          length: 32
        - type: field_declaration
          fields:
            text: private final TokenBuffer[] _tokens;
          children: []
          pos: 1204
          length: 36
        - type: constructor_declaration
          fields:
            text: |-
              protected ExternalTypeHandler(JavaType beanType,
                          ExtTypedProperty[] properties,
                          Map<String, Object> nameToPropertyIndex,
                          String[] typeIds, TokenBuffer[] tokens)
                  {
                      _beanType = beanType;
                      _properties = properties;
                      _nameToPropertyIndex = nameToPropertyIndex;
                      _typeIds = typeIds;
                      _tokens = tokens;
                  }
          children: []
          pos: 1246
          length: 378
        - type: constructor_declaration
          fields:
            text: |-
              protected ExternalTypeHandler(ExternalTypeHandler h)
                  {
                      _beanType = h._beanType;
                      _properties = h._properties;
                      _nameToPropertyIndex = h._nameToPropertyIndex;
                      int len = _properties.length;
                      _typeIds = new String[len];
                      _tokens = new TokenBuffer[len];
                  }
          children: []
          pos: 1630
          length: 303
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: builder
              children: []
              pos: 1995
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JavaType beanType
                children: []
                pos: 2003
                length: 17
              pos: 1973
              length: 94
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return new Builder(beanType);
                children: []
                pos: 2032
                length: 29
              pos: 2022
              length: 45
          children: []
          pos: 1973
          length: 94
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: start
              children: []
              pos: 2209
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 2182
              length: 88
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return new ExternalTypeHandler(this);
                children: []
                pos: 2227
                length: 37
              pos: 2217
              length: 53
          children: []
          pos: 2182
          length: 88
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: handleTypePropertyValue
              children: []
              pos: 2676
              length: 23
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 2700
                length: 12
              pos: 2626
              length: 903
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Object ob = _nameToPropertyIndex.get(propName);
                children: []
                pos: 2826
                length: 47
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: ob
                            children: []
                            pos: 2886
                            length: 2
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 2892
                            length: 4
                        children: []
                        pos: 2886
                        length: 10
                    children: []
                    pos: 2885
                    length: 12
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 2912
                    length: 13
                  pos: 2898
                  length: 37
                pos: 2882
                length: 53
              - type: local_variable_declaration
                fields:
                  text: final String typeId = p.getText();
                children: []
                pos: 2944
                length: 34
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: instanceof_expression
                        fields:
                          text: ob instanceof List<?>
                        children: []
                        pos: 3064
                        length: 21
                    children: []
                    pos: 3063
                    length: 23
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: boolean result = false;
                    children: []
                    pos: 3101
                    length: 23
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Integer index : (List<Integer>) ob) {
                                        if (_handleTypePropertyValue(p, ctxt, propName, bean,
                                                typeId, index.intValue())) {
                                            result = true;
                                        }
                                    }
                    children: []
                    pos: 3137
                    length: 232
                  - type: return_statement
                    fields:
                      text: return result;
                    children: []
                    pos: 3382
                    length: 14
                  pos: 3087
                  length: 319
                pos: 3060
                length: 346
              - type: return_statement
                fields:
                  text: |-
                    return _handleTypePropertyValue(p, ctxt, propName, bean,
                                    typeId, ((Integer) ob).intValue());
                children: []
                pos: 3415
                length: 108
              pos: 2816
              length: 713
          children: []
          pos: 2626
          length: 903
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _handleTypePropertyValue
              children: []
              pos: 3557
              length: 24
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 3582
                length: 12
              pos: 3535
              length: 898
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: ExtTypedProperty prop = _properties[index];
                children: []
                pos: 3734
                length: 43
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!prop.hasTypePropertyName(propName)"
                        children: []
                        pos: 3790
                        length: 35
                    children: []
                    pos: 3789
                    length: 37
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 3880
                    length: 13
                  pos: 3827
                  length: 76
                pos: 3786
                length: 117
              - type: local_variable_declaration
                fields:
                  text: boolean canDeserialize = (bean != null) && (_tokens[index]
                    != null);
                children: []
                pos: 3988
                length: 68
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: canDeserialize
                        children: []
                        pos: 4155
                        length: 14
                    children: []
                    pos: 4154
                    length: 16
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _deserializeAndSet(p, ctxt, bean, index, typeId);
                    children: []
                    pos: 4185
                    length: 49
                  - type: expression_statement
                    fields:
                      text: _tokens[index] = null;
                    children: []
                    pos: 4319
                    length: 22
                  pos: 4171
                  length: 180
                pos: 4151
                length: 255
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 4415
                length: 12
              pos: 3724
              length: 709
          children: []
          pos: 3535
          length: 898
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: handlePropertyValue
              children: []
              pos: 4865
              length: 19
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 4885
                length: 12
              pos: 4815
              length: 2536
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Object ob = _nameToPropertyIndex.get(propName);
                children: []
                pos: 5003
                length: 47
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: ob
                            children: []
                            pos: 5063
                            length: 2
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 5069
                            length: 4
                        children: []
                        pos: 5063
                        length: 10
                    children: []
                    pos: 5062
                    length: 12
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 5089
                    length: 13
                  pos: 5075
                  length: 37
                pos: 5059
                length: 53
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: instanceof_expression
                        fields:
                          text: ob instanceof List<?>
                        children: []
                        pos: 5198
                        length: 21
                    children: []
                    pos: 5197
                    length: 23
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: Iterator<Integer> it = ((List<Integer>) ob).iterator();
                    children: []
                    pos: 5235
                    length: 55
                  - type: local_variable_declaration
                    fields:
                      text: Integer index = it.next();
                    children: []
                    pos: 5303
                    length: 26
                  - type: local_variable_declaration
                    fields:
                      text: ExtTypedProperty prop = _properties[index];
                    children: []
                    pos: 5343
                    length: 43
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: prop.hasTypePropertyName(propName)
                            children: []
                            pos: 5544
                            length: 34
                        children: []
                        pos: 5543
                        length: 36
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: local_variable_declaration
                        fields:
                          text: String typeId = p.getText();
                        children: []
                        pos: 5598
                        length: 28
                      - type: expression_statement
                        fields:
                          text: p.skipChildren();
                        children: []
                        pos: 5643
                        length: 17
                      - type: expression_statement
                        fields:
                          text: _typeIds[index] = typeId;
                        children: []
                        pos: 5677
                        length: 25
                      - type: while_statement
                        fields:
                          text: |-
                            while (it.hasNext()) {
                                                _typeIds[it.next()] = typeId;
                                            }
                        children: []
                        pos: 5719
                        length: 90
                      pos: 5580
                      length: 243
                    pos: 5540
                    length: 608
                  - type: return_statement
                    fields:
                      text: return true;
                    children: []
                    pos: 6161
                    length: 12
                  pos: 5221
                  length: 962
                pos: 5194
                length: 989
              - type: local_variable_declaration
                fields:
                  text: int index = ((Integer) ob).intValue();
                children: []
                pos: 6316
                length: 38
              - type: local_variable_declaration
                fields:
                  text: ExtTypedProperty prop = _properties[index];
                children: []
                pos: 6363
                length: 43
              - type: local_variable_declaration
                fields:
                  text: boolean canDeserialize;
                children: []
                pos: 6415
                length: 23
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: prop.hasTypePropertyName(propName)
                        children: []
                        pos: 6451
                        length: 34
                    children: []
                    pos: 6450
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _typeIds[index] = p.getText();
                    children: []
                    pos: 6501
                    length: 30
                  - type: expression_statement
                    fields:
                      text: p.skipChildren();
                    children: []
                    pos: 6544
                    length: 17
                  - type: expression_statement
                    fields:
                      text: canDeserialize = (bean != null) && (_tokens[index] !=
                        null);
                    children: []
                    pos: 6574
                    length: 60
                  pos: 6487
                  length: 157
                pos: 6447
                length: 470
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: canDeserialize
                        children: []
                        pos: 7047
                        length: 14
                    children: []
                    pos: 7046
                    length: 16
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String typeId = _typeIds[index];
                    children: []
                    pos: 7077
                    length: 32
                  - type: expression_statement
                    fields:
                      text: _typeIds[index] = null;
                    children: []
                    pos: 7194
                    length: 23
                  - type: expression_statement
                    fields:
                      text: _deserializeAndSet(p, ctxt, bean, index, typeId);
                    children: []
                    pos: 7230
                    length: 49
                  - type: expression_statement
                    fields:
                      text: _tokens[index] = null;
                    children: []
                    pos: 7292
                    length: 22
                  pos: 7063
                  length: 261
                pos: 7043
                length: 281
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 7333
                length: 12
              pos: 4993
              length: 2358
          children: []
          pos: 4815
          length: 2536
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: complete
              children: []
              pos: 7539
              length: 8
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 7548
                length: 12
              pos: 7491
              length: 2443
            body:
              type: block
              fields: {}
              children:
              - type: for_statement
                fields:
                  text: "for (int i = 0, len = _properties.length; i < len; ++i) {\n
                    \           String typeId = _typeIds[i];\n            if (typeId
                    == null) {\n                TokenBuffer tokens = _tokens[i];\n
                    \               // let's allow missing both type and property
                    (may already have been set, too)\n                // but not just
                    one\n                if (tokens == null) {\n                    continue;\n
                    \               }\n                // [databind#118]: Need to
                    mind natural types, for which no type id\n                // will
                    be included.\n                JsonToken t = tokens.firstToken();\n
                    \               if (t.isScalarValue()) { // can't be null as we
                    never store empty buffers\n                    JsonParser buffered
                    = tokens.asParser(p);\n                    buffered.nextToken();\n
                    \                   SettableBeanProperty extProp = _properties[i].getProperty();\n
                    \                   Object result = TypeDeserializer.deserializeIfNatural(buffered,
                    ctxt, extProp.getType());\n                    if (result != null)
                    {\n                        extProp.set(bean, result);\n                        continue;\n
                    \                   }\n                    // 26-Oct-2012, tatu:
                    As per [databind#94], must allow use of 'defaultImpl'\n                    if
                    (!_properties[i].hasDefaultType()) {\n                        ctxt.reportInputMismatch(bean.getClass(),\n
                    \                               \"Missing external type id property
                    '%s'\",\n                                _properties[i].getTypePropertyName());
                    \                               \n                    } else  {\n
                    \                       typeId = _properties[i].getDefaultTypeId();\n
                    \                   }\n                }\n            } else if
                    (_tokens[i] == null) {\n                SettableBeanProperty prop
                    = _properties[i].getProperty();\n\n                if(prop.isRequired()
                    ||\n                        ctxt.isEnabled(DeserializationFeature.FAIL_ON_MISSING_EXTERNAL_TYPE_ID_PROPERTY))
                    {\n                    ctxt.reportInputMismatch(bean.getClass(),\n
                    \                           \"Missing property '%s' for external
                    type id '%s'\",\n                            prop.getName(), _properties[i].getTypePropertyName());\n
                    \               }\n                return bean;\n            }\n
                    \           _deserializeAndSet(p, ctxt, bean, i, typeId);\n        }"
                children: []
                pos: 7645
                length: 2262
              - type: return_statement
                fields:
                  text: return bean;
                children: []
                pos: 9916
                length: 12
              pos: 7635
              length: 2299
          children: []
          pos: 7491
          length: 2443
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: complete
              children: []
              pos: 10101
              length: 8
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 10110
                length: 12
              pos: 10087
              length: 3127
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: final int len = _properties.length;
                children: []
                pos: 10326
                length: 35
              - type: local_variable_declaration
                fields:
                  text: Object[] values = new Object[len];
                children: []
                pos: 10370
                length: 34
              - type: for_statement
                fields:
                  text: |-
                    for (int i = 0; i < len; ++i) {
                                String typeId = _typeIds[i];
                                final ExtTypedProperty extProp = _properties[i];
                                if (typeId == null) {
                                    // let's allow missing both type and property (may already have been set, too)
                                    if (_tokens[i] == null) {
                                        continue;
                                    }
                                    // but not just one
                                    // 26-Oct-2012, tatu: As per [databind#94], must allow use of 'defaultImpl'
                                    if (!extProp.hasDefaultType()) {
                                        ctxt.reportInputMismatch(_beanType,
                                                "Missing external type id property '%s'",
                                                extProp.getTypePropertyName());
                                    } else {
                                        typeId = extProp.getDefaultTypeId();
                                    }
                                } else if (_tokens[i] == null) {
                                    SettableBeanProperty prop = extProp.getProperty();
                                    ctxt.reportInputMismatch(_beanType,
                                            "Missing property '%s' for external type id '%s'",
                                            prop.getName(), _properties[i].getTypePropertyName());
                                }
                                values[i] = _deserialize(p, ctxt, i, typeId);

                                final SettableBeanProperty prop = extProp.getProperty();
                                // also: if it's creator prop, fill in
                                if (prop.getCreatorIndex() >= 0) {
                                    buffer.assignParameter(prop, values[i]);

                                    // [databind#999] And maybe there's creator property for type id too?
                                    SettableBeanProperty typeProp = extProp.getTypeProperty();
                                    // for now, should only be needed for creator properties, too
                                    if ((typeProp != null) && (typeProp.getCreatorIndex() >= 0)) {
                                        // 31-May-2018, tatu: [databind#1328] if id is NOT plain `String`, need to
                                        //    apply deserializer... fun fun.
                                        final Object v;
                                        if (typeProp.getType().hasRawClass(String.class)) {
                                            v = typeId;
                                        } else {
                                            TokenBuffer tb = new TokenBuffer(p, ctxt);
                                            tb.writeString(typeId);
                                            v = typeProp.getValueDeserializer().deserialize(tb.asParserOnFirstToken(), ctxt);
                                            tb.close();
                                        }
                                        buffer.assignParameter(typeProp, v);
                                    }
                                }
                            }
                children: []
                pos: 10413
                length: 2452
              - type: local_variable_declaration
                fields:
                  text: Object bean = creator.build(ctxt, buffer);
                children: []
                pos: 12874
                length: 42
              - type: for_statement
                fields:
                  text: |-
                    for (int i = 0; i < len; ++i) {
                                SettableBeanProperty prop = _properties[i].getProperty();
                                if (prop.getCreatorIndex() < 0) {
                                    prop.set(bean, values[i]);
                                }
                            }
                children: []
                pos: 12973
                length: 214
              - type: return_statement
                fields:
                  text: return bean;
                children: []
                pos: 13196
                length: 12
              pos: 10254
              length: 2960
          children: []
          pos: 10087
          length: 3127
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _deserialize
              children: []
              pos: 13277
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 13290
                length: 12
              pos: 13220
              length: 836
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: JsonParser p2 = _tokens[index].asParser(p);
                children: []
                pos: 13404
                length: 43
              - type: local_variable_declaration
                fields:
                  text: JsonToken t = p2.nextToken();
                children: []
                pos: 13456
                length: 29
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: t
                            children: []
                            pos: 13578
                            length: 1
                          right:
                            type: field_access
                            fields:
                              text: JsonToken.VALUE_NULL
                            children: []
                            pos: 13583
                            length: 20
                        children: []
                        pos: 13578
                        length: 25
                    children: []
                    pos: 13577
                    length: 27
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return null;
                    children: []
                    pos: 13619
                    length: 12
                  pos: 13605
                  length: 36
                pos: 13574
                length: 67
              - type: local_variable_declaration
                fields:
                  text: TokenBuffer merged = new TokenBuffer(p, ctxt);
                children: []
                pos: 13650
                length: 46
              - type: expression_statement
                fields:
                  text: merged.writeStartArray();
                children: []
                pos: 13705
                length: 25
              - type: expression_statement
                fields:
                  text: merged.writeString(typeId);
                children: []
                pos: 13739
                length: 27
              - type: expression_statement
                fields:
                  text: merged.copyCurrentStructure(p2);
                children: []
                pos: 13775
                length: 32
              - type: expression_statement
                fields:
                  text: merged.writeEndArray();
                children: []
                pos: 13816
                length: 23
              - type: local_variable_declaration
                fields:
                  text: JsonParser mp = merged.asParser(p);
                children: []
                pos: 13920
                length: 35
              - type: expression_statement
                fields:
                  text: mp.nextToken();
                children: []
                pos: 13964
                length: 15
              - type: return_statement
                fields:
                  text: return _properties[index].getProperty().deserialize(mp, ctxt);
                children: []
                pos: 13988
                length: 62
              pos: 13394
              length: 662
          children: []
          pos: 13220
          length: 836
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _deserializeAndSet
              children: []
              pos: 14117
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 14136
                length: 12
              pos: 14062
              length: 1082
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: JsonParser p2 = _tokens[index].asParser(p);
                children: []
                pos: 14430
                length: 43
              - type: local_variable_declaration
                fields:
                  text: JsonToken t = p2.nextToken();
                children: []
                pos: 14482
                length: 29
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: t
                            children: []
                            pos: 14604
                            length: 1
                          right:
                            type: field_access
                            fields:
                              text: JsonToken.VALUE_NULL
                            children: []
                            pos: 14609
                            length: 20
                        children: []
                        pos: 14604
                        length: 25
                    children: []
                    pos: 14603
                    length: 27
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _properties[index].getProperty().set(bean, null);
                    children: []
                    pos: 14645
                    length: 49
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 14707
                    length: 7
                  pos: 14631
                  length: 93
                pos: 14600
                length: 124
              - type: local_variable_declaration
                fields:
                  text: TokenBuffer merged = new TokenBuffer(p, ctxt);
                children: []
                pos: 14733
                length: 46
              - type: expression_statement
                fields:
                  text: merged.writeStartArray();
                children: []
                pos: 14788
                length: 25
              - type: expression_statement
                fields:
                  text: merged.writeString(typeId);
                children: []
                pos: 14822
                length: 27
              - type: expression_statement
                fields:
                  text: merged.copyCurrentStructure(p2);
                children: []
                pos: 14859
                length: 32
              - type: expression_statement
                fields:
                  text: merged.writeEndArray();
                children: []
                pos: 14900
                length: 23
              - type: local_variable_declaration
                fields:
                  text: JsonParser mp = merged.asParser(p);
                children: []
                pos: 15003
                length: 35
              - type: expression_statement
                fields:
                  text: mp.nextToken();
                children: []
                pos: 15047
                length: 15
              - type: expression_statement
                fields:
                  text: _properties[index].getProperty().deserializeAndSet(mp, ctxt,
                    bean);
                children: []
                pos: 15071
                length: 67
              pos: 14253
              length: 891
          children: []
          pos: 14062
          length: 1082
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: Builder
              children: []
              pos: 15340
              length: 7
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final JavaType _beanType;
                children: []
                pos: 15362
                length: 33
              - type: field_declaration
                fields:
                  text: private final List<ExtTypedProperty> _properties = new ArrayList<>();
                children: []
                pos: 15405
                length: 69
              - type: field_declaration
                fields:
                  text: private final Map<String, Object> _nameToPropertyIndex = new
                    HashMap<>();
                children: []
                pos: 15483
                length: 73
              - type: constructor_declaration
                fields:
                  text: |-
                    protected Builder(JavaType t) {
                                _beanType = t;
                            }
                children: []
                pos: 15566
                length: 68
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: addExternal
                    children: []
                    pos: 15656
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: SettableBeanProperty property
                      children: []
                      pos: 15668
                      length: 29
                    pos: 15644
                    length: 347
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: Integer index = _properties.size();
                      children: []
                      pos: 15749
                      length: 35
                    - type: expression_statement
                      fields:
                        text: _properties.add(new ExtTypedProperty(property, typeDeser));
                      children: []
                      pos: 15797
                      length: 59
                    - type: expression_statement
                      fields:
                        text: _addPropertyIndex(property.getName(), index);
                      children: []
                      pos: 15869
                      length: 45
                    - type: expression_statement
                      fields:
                        text: _addPropertyIndex(typeDeser.getPropertyName(), index);
                      children: []
                      pos: 15927
                      length: 54
                    pos: 15735
                    length: 256
                children: []
                pos: 15644
                length: 347
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: _addPropertyIndex
                    children: []
                    pos: 16014
                    length: 17
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: String name
                      children: []
                      pos: 16032
                      length: 11
                    pos: 16001
                    length: 602
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: Object ob = _nameToPropertyIndex.get(name);
                      children: []
                      pos: 16074
                      length: 43
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: equals
                              fields:
                                left:
                                  type: identifier
                                  fields:
                                    text: ob
                                  children: []
                                  pos: 16134
                                  length: 2
                                right:
                                  type: null_literal
                                  fields: {}
                                  children: []
                                  pos: 16140
                                  length: 4
                              children: []
                              pos: 16134
                              length: 10
                          children: []
                          pos: 16133
                          length: 12
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: _nameToPropertyIndex.put(name, index);
                          children: []
                          pos: 16164
                          length: 38
                        pos: 16146
                        length: 70
                      pos: 16130
                      length: 463
                    pos: 16060
                    length: 543
                children: []
                pos: 16001
                length: 602
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: build
                    children: []
                    pos: 16951
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: BeanPropertyMap otherProps
                      children: []
                      pos: 16957
                      length: 26
                    pos: 16924
                    length: 822
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: final int len = _properties.size();
                      children: []
                      pos: 17095
                      length: 35
                    - type: local_variable_declaration
                      fields:
                        text: ExtTypedProperty[] extProps = new ExtTypedProperty[len];
                      children: []
                      pos: 17143
                      length: 56
                    - type: for_statement
                      fields:
                        text: |-
                          for (int i = 0; i < len; ++i) {
                                          ExtTypedProperty extProp = _properties.get(i);
                                          String typePropId = extProp.getTypePropertyName();
                                          SettableBeanProperty typeProp = otherProps.find(typePropId);
                                          if (typeProp != null) {
                                              extProp.linkTypeProperty(typeProp);
                                          }
                                          extProps[i] = extProp;
                                      }
                      children: []
                      pos: 17212
                      length: 405
                    - type: return_statement
                      fields:
                        text: |-
                          return new ExternalTypeHandler(_beanType, extProps, _nameToPropertyIndex,
                                              null, null);
                      children: []
                      pos: 17630
                      length: 106
                    pos: 16985
                    length: 761
                children: []
                pos: 16924
                length: 822
              pos: 15320
              length: 2432
          children: []
          pos: 15320
          length: 2432
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: ExtTypedProperty
              children: []
              pos: 17785
              length: 16
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final SettableBeanProperty _property;
                children: []
                pos: 17816
                length: 45
              - type: field_declaration
                fields:
                  text: private final TypeDeserializer _typeDeserializer;
                children: []
                pos: 17870
                length: 49
              - type: field_declaration
                fields:
                  text: private final String _typePropertyName;
                children: []
                pos: 17928
                length: 39
              - type: field_declaration
                fields:
                  text: private SettableBeanProperty _typeProperty;
                children: []
                pos: 18023
                length: 43
              - type: constructor_declaration
                fields:
                  text: |-
                    public ExtTypedProperty(SettableBeanProperty property, TypeDeserializer typeDeser)
                            {
                                _property = property;
                                _typeDeserializer = typeDeser;
                                _typePropertyName = typeDeser.getPropertyName();
                            }
                children: []
                pos: 18076
                length: 240
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: linkTypeProperty
                    children: []
                    pos: 18384
                    length: 16
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: SettableBeanProperty p
                      children: []
                      pos: 18401
                      length: 22
                    pos: 18372
                    length: 95
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: _typeProperty = p;
                      children: []
                      pos: 18439
                      length: 18
                    pos: 18425
                    length: 42
                children: []
                pos: 18372
                length: 95
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: hasTypePropertyName
                    children: []
                    pos: 18492
                    length: 19
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: String n
                      children: []
                      pos: 18512
                      length: 8
                    pos: 18477
                    length: 104
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return n.equals(_typePropertyName);
                      children: []
                      pos: 18536
                      length: 35
                    pos: 18522
                    length: 59
                children: []
                pos: 18477
                length: 104
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: hasDefaultType
                    children: []
                    pos: 18606
                    length: 14
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 18591
                    length: 106
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _typeDeserializer.getDefaultImpl() != null;
                      children: []
                      pos: 18637
                      length: 50
                    pos: 18623
                    length: 74
                children: []
                pos: 18591
                length: 106
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getDefaultTypeId
                    children: []
                    pos: 18975
                    length: 16
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 18961
                    length: 293
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: Class<?> defaultType = _typeDeserializer.getDefaultImpl();
                      children: []
                      pos: 19008
                      length: 58
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: equals
                              fields:
                                left:
                                  type: identifier
                                  fields:
                                    text: defaultType
                                  children: []
                                  pos: 19083
                                  length: 11
                                right:
                                  type: null_literal
                                  fields: {}
                                  children: []
                                  pos: 19098
                                  length: 4
                              children: []
                              pos: 19083
                              length: 19
                          children: []
                          pos: 19082
                          length: 21
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: return_statement
                          fields:
                            text: return null;
                          children: []
                          pos: 19122
                          length: 12
                        pos: 19104
                        length: 44
                      pos: 19079
                      length: 69
                    - type: return_statement
                      fields:
                        text: return _typeDeserializer.getTypeIdResolver().idFromValueAndType(null,
                          defaultType);
                      children: []
                      pos: 19161
                      length: 83
                    pos: 18994
                    length: 260
                children: []
                pos: 18961
                length: 293
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getTypePropertyName
                    children: []
                    pos: 19278
                    length: 19
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 19264
                    length: 65
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _typePropertyName;
                      children: []
                      pos: 19302
                      length: 25
                    pos: 19300
                    length: 29
                children: []
                pos: 19264
                length: 65
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getProperty
                    children: []
                    pos: 19367
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 19339
                    length: 83
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _property;
                      children: []
                      pos: 19395
                      length: 17
                    pos: 19381
                    length: 41
                children: []
                pos: 19339
                length: 83
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getTypeProperty
                    children: []
                    pos: 19506
                    length: 15
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 19478
                    length: 91
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _typeProperty;
                      children: []
                      pos: 19538
                      length: 21
                    pos: 19524
                    length: 45
                children: []
                pos: 19478
                length: 91
              pos: 17758
              length: 1817
          children: []
          pos: 17758
          length: 1817
        pos: 731
        length: 18846
    children: []
    pos: 731
    length: 18846
  pos: 0
  length: 19578
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: ExternalTypeHandler
        children: []
        pos: 744
        length: 19
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private final JavaType _beanType;
          children: []
          pos: 770
          length: 33
        - type: field_declaration
          fields:
            text: private final ExtTypedProperty[] _properties;
          children: []
          pos: 809
          length: 45
        - type: field_declaration
          fields:
            text: private final Map<String, Object> _nameToPropertyIndex;
          children: []
          pos: 1106
          length: 55
        - type: field_declaration
          fields:
            text: private final String[] _typeIds;
          children: []
          pos: 1167
          length: 32
        - type: field_declaration
          fields:
            text: private final TokenBuffer[] _tokens;
          children: []
          pos: 1204
          length: 36
        - type: constructor_declaration
          fields:
            text: |-
              protected ExternalTypeHandler(JavaType beanType,
                          ExtTypedProperty[] properties,
                          Map<String, Object> nameToPropertyIndex,
                          String[] typeIds, TokenBuffer[] tokens)
                  {
                      _beanType = beanType;
                      _properties = properties;
                      _nameToPropertyIndex = nameToPropertyIndex;
                      _typeIds = typeIds;
                      _tokens = tokens;
                  }
          children: []
          pos: 1246
          length: 378
        - type: constructor_declaration
          fields:
            text: |-
              protected ExternalTypeHandler(ExternalTypeHandler h)
                  {
                      _beanType = h._beanType;
                      _properties = h._properties;
                      _nameToPropertyIndex = h._nameToPropertyIndex;
                      int len = _properties.length;
                      _typeIds = new String[len];
                      _tokens = new TokenBuffer[len];
                  }
          children: []
          pos: 1630
          length: 303
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: builder
              children: []
              pos: 1995
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JavaType beanType
                children: []
                pos: 2003
                length: 17
              pos: 1973
              length: 94
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return new Builder(beanType);
                children: []
                pos: 2032
                length: 29
              pos: 2022
              length: 45
          children: []
          pos: 1973
          length: 94
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: start
              children: []
              pos: 2209
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 2182
              length: 88
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return new ExternalTypeHandler(this);
                children: []
                pos: 2227
                length: 37
              pos: 2217
              length: 53
          children: []
          pos: 2182
          length: 88
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: handleTypePropertyValue
              children: []
              pos: 2676
              length: 23
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 2700
                length: 12
              pos: 2626
              length: 903
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Object ob = _nameToPropertyIndex.get(propName);
                children: []
                pos: 2826
                length: 47
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: ob
                            children: []
                            pos: 2886
                            length: 2
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 2892
                            length: 4
                        children: []
                        pos: 2886
                        length: 10
                    children: []
                    pos: 2885
                    length: 12
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 2912
                    length: 13
                  pos: 2898
                  length: 37
                pos: 2882
                length: 53
              - type: local_variable_declaration
                fields:
                  text: final String typeId = p.getText();
                children: []
                pos: 2944
                length: 34
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: instanceof_expression
                        fields:
                          text: ob instanceof List<?>
                        children: []
                        pos: 3064
                        length: 21
                    children: []
                    pos: 3063
                    length: 23
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: boolean result = false;
                    children: []
                    pos: 3101
                    length: 23
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Integer index : (List<Integer>) ob) {
                                        if (_handleTypePropertyValue(p, ctxt, propName, bean,
                                                typeId, index.intValue())) {
                                            result = true;
                                        }
                                    }
                    children: []
                    pos: 3137
                    length: 232
                  - type: return_statement
                    fields:
                      text: return result;
                    children: []
                    pos: 3382
                    length: 14
                  pos: 3087
                  length: 319
                pos: 3060
                length: 346
              - type: return_statement
                fields:
                  text: |-
                    return _handleTypePropertyValue(p, ctxt, propName, bean,
                                    typeId, ((Integer) ob).intValue());
                children: []
                pos: 3415
                length: 108
              pos: 2816
              length: 713
          children: []
          pos: 2626
          length: 903
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _handleTypePropertyValue
              children: []
              pos: 3557
              length: 24
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 3582
                length: 12
              pos: 3535
              length: 898
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: ExtTypedProperty prop = _properties[index];
                children: []
                pos: 3734
                length: 43
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!prop.hasTypePropertyName(propName)"
                        children: []
                        pos: 3790
                        length: 35
                    children: []
                    pos: 3789
                    length: 37
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 3880
                    length: 13
                  pos: 3827
                  length: 76
                pos: 3786
                length: 117
              - type: local_variable_declaration
                fields:
                  text: boolean canDeserialize = (bean != null) && (_tokens[index]
                    != null);
                children: []
                pos: 3988
                length: 68
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: canDeserialize
                        children: []
                        pos: 4155
                        length: 14
                    children: []
                    pos: 4154
                    length: 16
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _deserializeAndSet(p, ctxt, bean, index, typeId);
                    children: []
                    pos: 4185
                    length: 49
                  - type: expression_statement
                    fields:
                      text: _tokens[index] = null;
                    children: []
                    pos: 4319
                    length: 22
                  pos: 4171
                  length: 180
                pos: 4151
                length: 255
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 4415
                length: 12
              pos: 3724
              length: 709
          children: []
          pos: 3535
          length: 898
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: handlePropertyValue
              children: []
              pos: 4865
              length: 19
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 4885
                length: 12
              pos: 4815
              length: 2536
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Object ob = _nameToPropertyIndex.get(propName);
                children: []
                pos: 5003
                length: 47
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: ob
                            children: []
                            pos: 5063
                            length: 2
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 5069
                            length: 4
                        children: []
                        pos: 5063
                        length: 10
                    children: []
                    pos: 5062
                    length: 12
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return false;
                    children: []
                    pos: 5089
                    length: 13
                  pos: 5075
                  length: 37
                pos: 5059
                length: 53
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: instanceof_expression
                        fields:
                          text: ob instanceof List<?>
                        children: []
                        pos: 5198
                        length: 21
                    children: []
                    pos: 5197
                    length: 23
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: Iterator<Integer> it = ((List<Integer>) ob).iterator();
                    children: []
                    pos: 5235
                    length: 55
                  - type: local_variable_declaration
                    fields:
                      text: Integer index = it.next();
                    children: []
                    pos: 5303
                    length: 26
                  - type: local_variable_declaration
                    fields:
                      text: ExtTypedProperty prop = _properties[index];
                    children: []
                    pos: 5343
                    length: 43
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: prop.hasTypePropertyName(propName)
                            children: []
                            pos: 5544
                            length: 34
                        children: []
                        pos: 5543
                        length: 36
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: local_variable_declaration
                        fields:
                          text: String typeId = p.getText();
                        children: []
                        pos: 5598
                        length: 28
                      - type: expression_statement
                        fields:
                          text: p.skipChildren();
                        children: []
                        pos: 5643
                        length: 17
                      - type: expression_statement
                        fields:
                          text: _typeIds[index] = typeId;
                        children: []
                        pos: 5677
                        length: 25
                      - type: while_statement
                        fields:
                          text: |-
                            while (it.hasNext()) {
                                                _typeIds[it.next()] = typeId;
                                            }
                        children: []
                        pos: 5719
                        length: 90
                      pos: 5580
                      length: 243
                    pos: 5540
                    length: 608
                  - type: return_statement
                    fields:
                      text: return true;
                    children: []
                    pos: 6161
                    length: 12
                  pos: 5221
                  length: 962
                pos: 5194
                length: 989
              - type: local_variable_declaration
                fields:
                  text: int index = ((Integer) ob).intValue();
                children: []
                pos: 6316
                length: 38
              - type: local_variable_declaration
                fields:
                  text: ExtTypedProperty prop = _properties[index];
                children: []
                pos: 6363
                length: 43
              - type: local_variable_declaration
                fields:
                  text: boolean canDeserialize;
                children: []
                pos: 6415
                length: 23
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: prop.hasTypePropertyName(propName)
                        children: []
                        pos: 6451
                        length: 34
                    children: []
                    pos: 6450
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _typeIds[index] = p.getText();
                    children: []
                    pos: 6501
                    length: 30
                  - type: expression_statement
                    fields:
                      text: p.skipChildren();
                    children: []
                    pos: 6544
                    length: 17
                  - type: expression_statement
                    fields:
                      text: canDeserialize = (bean != null) && (_tokens[index] !=
                        null);
                    children: []
                    pos: 6574
                    length: 60
                  pos: 6487
                  length: 157
                pos: 6447
                length: 470
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: canDeserialize
                        children: []
                        pos: 7047
                        length: 14
                    children: []
                    pos: 7046
                    length: 16
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String typeId = _typeIds[index];
                    children: []
                    pos: 7077
                    length: 32
                  - type: expression_statement
                    fields:
                      text: _typeIds[index] = null;
                    children: []
                    pos: 7194
                    length: 23
                  - type: expression_statement
                    fields:
                      text: _deserializeAndSet(p, ctxt, bean, index, typeId);
                    children: []
                    pos: 7230
                    length: 49
                  - type: expression_statement
                    fields:
                      text: _tokens[index] = null;
                    children: []
                    pos: 7292
                    length: 22
                  pos: 7063
                  length: 261
                pos: 7043
                length: 281
              - type: return_statement
                fields:
                  text: return true;
                children: []
                pos: 7333
                length: 12
              pos: 4993
              length: 2358
          children: []
          pos: 4815
          length: 2536
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: complete
              children: []
              pos: 7539
              length: 8
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 7548
                length: 12
              pos: 7491
              length: 2443
            body:
              type: block
              fields: {}
              children:
              - type: for_statement
                fields:
                  text: "for (int i = 0, len = _properties.length; i < len; ++i) {\n
                    \           String typeId = _typeIds[i];\n            if (typeId
                    == null) {\n                TokenBuffer tokens = _tokens[i];\n
                    \               // let's allow missing both type and property
                    (may already have been set, too)\n                // but not just
                    one\n                if (tokens == null) {\n                    continue;\n
                    \               }\n                // [databind#118]: Need to
                    mind natural types, for which no type id\n                // will
                    be included.\n                JsonToken t = tokens.firstToken();\n
                    \               if (t.isScalarValue()) { // can't be null as we
                    never store empty buffers\n                    JsonParser buffered
                    = tokens.asParser(p);\n                    buffered.nextToken();\n
                    \                   SettableBeanProperty extProp = _properties[i].getProperty();\n
                    \                   Object result = TypeDeserializer.deserializeIfNatural(buffered,
                    ctxt, extProp.getType());\n                    if (result != null)
                    {\n                        extProp.set(bean, result);\n                        continue;\n
                    \                   }\n                    // 26-Oct-2012, tatu:
                    As per [databind#94], must allow use of 'defaultImpl'\n                    if
                    (!_properties[i].hasDefaultType()) {\n                        ctxt.reportInputMismatch(bean.getClass(),\n
                    \                               \"Missing external type id property
                    '%s'\",\n                                _properties[i].getTypePropertyName());
                    \                               \n                    } else  {\n
                    \                       typeId = _properties[i].getDefaultTypeId();\n
                    \                   }\n                }\n            } else if
                    (_tokens[i] == null) {\n                SettableBeanProperty prop
                    = _properties[i].getProperty();\n\n                if(prop.isRequired()
                    ||\n                        ctxt.isEnabled(DeserializationFeature.FAIL_ON_MISSING_EXTERNAL_TYPE_ID_PROPERTY))
                    {\n                    ctxt.reportInputMismatch(bean.getClass(),\n
                    \                           \"Missing property '%s' for external
                    type id '%s'\",\n                            prop.getName(), _properties[i].getTypePropertyName());\n
                    \               }\n                return bean;\n            }\n
                    \           _deserializeAndSet(p, ctxt, bean, i, typeId);\n        }"
                children: []
                pos: 7645
                length: 2262
              - type: return_statement
                fields:
                  text: return bean;
                children: []
                pos: 9916
                length: 12
              pos: 7635
              length: 2299
          children: []
          pos: 7491
          length: 2443
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: complete
              children: []
              pos: 10101
              length: 8
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 10110
                length: 12
              pos: 10087
              length: 2680
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: final int len = _properties.length;
                children: []
                pos: 10326
                length: 35
              - type: local_variable_declaration
                fields:
                  text: Object[] values = new Object[len];
                children: []
                pos: 10370
                length: 34
              - type: for_statement
                fields:
                  text: |-
                    for (int i = 0; i < len; ++i) {
                                String typeId = _typeIds[i];
                                final ExtTypedProperty extProp = _properties[i];
                                if (typeId == null) {
                                    // let's allow missing both type and property (may already have been set, too)
                                    if (_tokens[i] == null) {
                                        continue;
                                    }
                                    // but not just one
                                    // 26-Oct-2012, tatu: As per [databind#94], must allow use of 'defaultImpl'
                                    if (!extProp.hasDefaultType()) {
                                        ctxt.reportInputMismatch(_beanType,
                                                "Missing external type id property '%s'",
                                                extProp.getTypePropertyName());
                                    } else {
                                        typeId = extProp.getDefaultTypeId();
                                    }
                                } else if (_tokens[i] == null) {
                                    SettableBeanProperty prop = extProp.getProperty();
                                    ctxt.reportInputMismatch(_beanType,
                                            "Missing property '%s' for external type id '%s'",
                                            prop.getName(), _properties[i].getTypePropertyName());
                                }
                                values[i] = _deserialize(p, ctxt, i, typeId);

                                final SettableBeanProperty prop = extProp.getProperty();
                                // also: if it's creator prop, fill in
                                if (prop.getCreatorIndex() >= 0) {
                                    buffer.assignParameter(prop, values[i]);

                                    // [databind#999] And maybe there's creator property for type id too?
                                    SettableBeanProperty typeProp = extProp.getTypeProperty();
                                    // for now, should only be needed for creator properties, too
                                    if ((typeProp != null) && (typeProp.getCreatorIndex() >= 0)) {
                                        // 31-May-2018, tatu: [databind#1328] if id is NOT plain `String`, need to
                                        //    apply deserializer... fun fun.
                                        buffer.assignParameter(typeProp, typeId);
                                    }
                                }
                            }
                children: []
                pos: 10413
                length: 2005
              - type: local_variable_declaration
                fields:
                  text: Object bean = creator.build(ctxt, buffer);
                children: []
                pos: 12427
                length: 42
              - type: for_statement
                fields:
                  text: |-
                    for (int i = 0; i < len; ++i) {
                                SettableBeanProperty prop = _properties[i].getProperty();
                                if (prop.getCreatorIndex() < 0) {
                                    prop.set(bean, values[i]);
                                }
                            }
                children: []
                pos: 12526
                length: 214
              - type: return_statement
                fields:
                  text: return bean;
                children: []
                pos: 12749
                length: 12
              pos: 10254
              length: 2513
          children: []
          pos: 10087
          length: 2680
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _deserialize
              children: []
              pos: 12830
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 12843
                length: 12
              pos: 12773
              length: 836
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: JsonParser p2 = _tokens[index].asParser(p);
                children: []
                pos: 12957
                length: 43
              - type: local_variable_declaration
                fields:
                  text: JsonToken t = p2.nextToken();
                children: []
                pos: 13009
                length: 29
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: t
                            children: []
                            pos: 13131
                            length: 1
                          right:
                            type: field_access
                            fields:
                              text: JsonToken.VALUE_NULL
                            children: []
                            pos: 13136
                            length: 20
                        children: []
                        pos: 13131
                        length: 25
                    children: []
                    pos: 13130
                    length: 27
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return null;
                    children: []
                    pos: 13172
                    length: 12
                  pos: 13158
                  length: 36
                pos: 13127
                length: 67
              - type: local_variable_declaration
                fields:
                  text: TokenBuffer merged = new TokenBuffer(p, ctxt);
                children: []
                pos: 13203
                length: 46
              - type: expression_statement
                fields:
                  text: merged.writeStartArray();
                children: []
                pos: 13258
                length: 25
              - type: expression_statement
                fields:
                  text: merged.writeString(typeId);
                children: []
                pos: 13292
                length: 27
              - type: expression_statement
                fields:
                  text: merged.copyCurrentStructure(p2);
                children: []
                pos: 13328
                length: 32
              - type: expression_statement
                fields:
                  text: merged.writeEndArray();
                children: []
                pos: 13369
                length: 23
              - type: local_variable_declaration
                fields:
                  text: JsonParser mp = merged.asParser(p);
                children: []
                pos: 13473
                length: 35
              - type: expression_statement
                fields:
                  text: mp.nextToken();
                children: []
                pos: 13517
                length: 15
              - type: return_statement
                fields:
                  text: return _properties[index].getProperty().deserialize(mp, ctxt);
                children: []
                pos: 13541
                length: 62
              pos: 12947
              length: 662
          children: []
          pos: 12773
          length: 836
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: _deserializeAndSet
              children: []
              pos: 13670
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 13689
                length: 12
              pos: 13615
              length: 1082
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: JsonParser p2 = _tokens[index].asParser(p);
                children: []
                pos: 13983
                length: 43
              - type: local_variable_declaration
                fields:
                  text: JsonToken t = p2.nextToken();
                children: []
                pos: 14035
                length: 29
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: t
                            children: []
                            pos: 14157
                            length: 1
                          right:
                            type: field_access
                            fields:
                              text: JsonToken.VALUE_NULL
                            children: []
                            pos: 14162
                            length: 20
                        children: []
                        pos: 14157
                        length: 25
                    children: []
                    pos: 14156
                    length: 27
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: _properties[index].getProperty().set(bean, null);
                    children: []
                    pos: 14198
                    length: 49
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 14260
                    length: 7
                  pos: 14184
                  length: 93
                pos: 14153
                length: 124
              - type: local_variable_declaration
                fields:
                  text: TokenBuffer merged = new TokenBuffer(p, ctxt);
                children: []
                pos: 14286
                length: 46
              - type: expression_statement
                fields:
                  text: merged.writeStartArray();
                children: []
                pos: 14341
                length: 25
              - type: expression_statement
                fields:
                  text: merged.writeString(typeId);
                children: []
                pos: 14375
                length: 27
              - type: expression_statement
                fields:
                  text: merged.copyCurrentStructure(p2);
                children: []
                pos: 14412
                length: 32
              - type: expression_statement
                fields:
                  text: merged.writeEndArray();
                children: []
                pos: 14453
                length: 23
              - type: local_variable_declaration
                fields:
                  text: JsonParser mp = merged.asParser(p);
                children: []
                pos: 14556
                length: 35
              - type: expression_statement
                fields:
                  text: mp.nextToken();
                children: []
                pos: 14600
                length: 15
              - type: expression_statement
                fields:
                  text: _properties[index].getProperty().deserializeAndSet(mp, ctxt,
                    bean);
                children: []
                pos: 14624
                length: 67
              pos: 13806
              length: 891
          children: []
          pos: 13615
          length: 1082
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: Builder
              children: []
              pos: 14893
              length: 7
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final JavaType _beanType;
                children: []
                pos: 14915
                length: 33
              - type: field_declaration
                fields:
                  text: private final List<ExtTypedProperty> _properties = new ArrayList<>();
                children: []
                pos: 14958
                length: 69
              - type: field_declaration
                fields:
                  text: private final Map<String, Object> _nameToPropertyIndex = new
                    HashMap<>();
                children: []
                pos: 15036
                length: 73
              - type: constructor_declaration
                fields:
                  text: |-
                    protected Builder(JavaType t) {
                                _beanType = t;
                            }
                children: []
                pos: 15119
                length: 68
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: addExternal
                    children: []
                    pos: 15209
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: SettableBeanProperty property
                      children: []
                      pos: 15221
                      length: 29
                    pos: 15197
                    length: 347
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: Integer index = _properties.size();
                      children: []
                      pos: 15302
                      length: 35
                    - type: expression_statement
                      fields:
                        text: _properties.add(new ExtTypedProperty(property, typeDeser));
                      children: []
                      pos: 15350
                      length: 59
                    - type: expression_statement
                      fields:
                        text: _addPropertyIndex(property.getName(), index);
                      children: []
                      pos: 15422
                      length: 45
                    - type: expression_statement
                      fields:
                        text: _addPropertyIndex(typeDeser.getPropertyName(), index);
                      children: []
                      pos: 15480
                      length: 54
                    pos: 15288
                    length: 256
                children: []
                pos: 15197
                length: 347
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: _addPropertyIndex
                    children: []
                    pos: 15567
                    length: 17
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: String name
                      children: []
                      pos: 15585
                      length: 11
                    pos: 15554
                    length: 602
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: Object ob = _nameToPropertyIndex.get(name);
                      children: []
                      pos: 15627
                      length: 43
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: equals
                              fields:
                                left:
                                  type: identifier
                                  fields:
                                    text: ob
                                  children: []
                                  pos: 15687
                                  length: 2
                                right:
                                  type: null_literal
                                  fields: {}
                                  children: []
                                  pos: 15693
                                  length: 4
                              children: []
                              pos: 15687
                              length: 10
                          children: []
                          pos: 15686
                          length: 12
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: _nameToPropertyIndex.put(name, index);
                          children: []
                          pos: 15717
                          length: 38
                        pos: 15699
                        length: 70
                      pos: 15683
                      length: 463
                    pos: 15613
                    length: 543
                children: []
                pos: 15554
                length: 602
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: build
                    children: []
                    pos: 16504
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: BeanPropertyMap otherProps
                      children: []
                      pos: 16510
                      length: 26
                    pos: 16477
                    length: 822
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: final int len = _properties.size();
                      children: []
                      pos: 16648
                      length: 35
                    - type: local_variable_declaration
                      fields:
                        text: ExtTypedProperty[] extProps = new ExtTypedProperty[len];
                      children: []
                      pos: 16696
                      length: 56
                    - type: for_statement
                      fields:
                        text: |-
                          for (int i = 0; i < len; ++i) {
                                          ExtTypedProperty extProp = _properties.get(i);
                                          String typePropId = extProp.getTypePropertyName();
                                          SettableBeanProperty typeProp = otherProps.find(typePropId);
                                          if (typeProp != null) {
                                              extProp.linkTypeProperty(typeProp);
                                          }
                                          extProps[i] = extProp;
                                      }
                      children: []
                      pos: 16765
                      length: 405
                    - type: return_statement
                      fields:
                        text: |-
                          return new ExternalTypeHandler(_beanType, extProps, _nameToPropertyIndex,
                                              null, null);
                      children: []
                      pos: 17183
                      length: 106
                    pos: 16538
                    length: 761
                children: []
                pos: 16477
                length: 822
              pos: 14873
              length: 2432
          children: []
          pos: 14873
          length: 2432
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: ExtTypedProperty
              children: []
              pos: 17338
              length: 16
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final SettableBeanProperty _property;
                children: []
                pos: 17369
                length: 45
              - type: field_declaration
                fields:
                  text: private final TypeDeserializer _typeDeserializer;
                children: []
                pos: 17423
                length: 49
              - type: field_declaration
                fields:
                  text: private final String _typePropertyName;
                children: []
                pos: 17481
                length: 39
              - type: field_declaration
                fields:
                  text: private SettableBeanProperty _typeProperty;
                children: []
                pos: 17576
                length: 43
              - type: constructor_declaration
                fields:
                  text: |-
                    public ExtTypedProperty(SettableBeanProperty property, TypeDeserializer typeDeser)
                            {
                                _property = property;
                                _typeDeserializer = typeDeser;
                                _typePropertyName = typeDeser.getPropertyName();
                            }
                children: []
                pos: 17629
                length: 240
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: linkTypeProperty
                    children: []
                    pos: 17937
                    length: 16
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: SettableBeanProperty p
                      children: []
                      pos: 17954
                      length: 22
                    pos: 17925
                    length: 95
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: _typeProperty = p;
                      children: []
                      pos: 17992
                      length: 18
                    pos: 17978
                    length: 42
                children: []
                pos: 17925
                length: 95
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: hasTypePropertyName
                    children: []
                    pos: 18045
                    length: 19
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: String n
                      children: []
                      pos: 18065
                      length: 8
                    pos: 18030
                    length: 104
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return n.equals(_typePropertyName);
                      children: []
                      pos: 18089
                      length: 35
                    pos: 18075
                    length: 59
                children: []
                pos: 18030
                length: 104
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: hasDefaultType
                    children: []
                    pos: 18159
                    length: 14
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 18144
                    length: 106
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _typeDeserializer.getDefaultImpl() != null;
                      children: []
                      pos: 18190
                      length: 50
                    pos: 18176
                    length: 74
                children: []
                pos: 18144
                length: 106
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getDefaultTypeId
                    children: []
                    pos: 18528
                    length: 16
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 18514
                    length: 293
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: Class<?> defaultType = _typeDeserializer.getDefaultImpl();
                      children: []
                      pos: 18561
                      length: 58
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: equals
                              fields:
                                left:
                                  type: identifier
                                  fields:
                                    text: defaultType
                                  children: []
                                  pos: 18636
                                  length: 11
                                right:
                                  type: null_literal
                                  fields: {}
                                  children: []
                                  pos: 18651
                                  length: 4
                              children: []
                              pos: 18636
                              length: 19
                          children: []
                          pos: 18635
                          length: 21
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: return_statement
                          fields:
                            text: return null;
                          children: []
                          pos: 18675
                          length: 12
                        pos: 18657
                        length: 44
                      pos: 18632
                      length: 69
                    - type: return_statement
                      fields:
                        text: return _typeDeserializer.getTypeIdResolver().idFromValueAndType(null,
                          defaultType);
                      children: []
                      pos: 18714
                      length: 83
                    pos: 18547
                    length: 260
                children: []
                pos: 18514
                length: 293
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getTypePropertyName
                    children: []
                    pos: 18831
                    length: 19
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 18817
                    length: 65
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _typePropertyName;
                      children: []
                      pos: 18855
                      length: 25
                    pos: 18853
                    length: 29
                children: []
                pos: 18817
                length: 65
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getProperty
                    children: []
                    pos: 18920
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 18892
                    length: 83
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _property;
                      children: []
                      pos: 18948
                      length: 17
                    pos: 18934
                    length: 41
                children: []
                pos: 18892
                length: 83
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getTypeProperty
                    children: []
                    pos: 19059
                    length: 15
                  parameters:
                    type: method_parameters
                    fields: {}
                    children: []
                    pos: 19031
                    length: 91
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: return_statement
                      fields:
                        text: return _typeProperty;
                      children: []
                      pos: 19091
                      length: 21
                    pos: 19077
                    length: 45
                children: []
                pos: 19031
                length: 91
              pos: 17311
              length: 1817
          children: []
          pos: 17311
          length: 1817
        pos: 731
        length: 18399
    children: []
    pos: 731
    length: 18399
  pos: 0
  length: 19131
text_diff: |
  --- before
  +++ after
  @@ -295,16 +295,7 @@
                   if ((typeProp != null) && (typeProp.getCreatorIndex() >= 0)) {
                       // 31-May-2018, tatu: [databind#1328] if id is NOT plain `String`, need to
                       //    apply deserializer... fun fun.
  -                    final Object v;
  -                    if (typeProp.getType().hasRawClass(String.class)) {
  -                        v = typeId;
  -                    } else {
  -                        TokenBuffer tb = new TokenBuffer(p, ctxt);
  -                        tb.writeString(typeId);
  -                        v = typeProp.getValueDeserializer().deserialize(tb.asParserOnFirstToken(), ctxt);
  -                        tb.close();
  -                    }
  -                    buffer.assignParameter(typeProp, v);
  +                    buffer.assignParameter(typeProp, typeId);
                   }
               }
           }
tree_diff: |+
  New cluster:
  UPDATE from for (int i = 0; i < len; ++i) {
              String typeId = _typeIds[i];
              final ExtTypedProperty extProp = _properties[i];
              if (typeId == null) {
                  // let's allow missing both type and property (may already have been set, too)
                  if (_tokens[i] == null) {
                      continue;
                  }
                  // but not just one
                  // 26-Oct-2012, tatu: As per [databind#94], must allow use of 'defaultImpl'
                  if (!extProp.hasDefaultType()) {
                      ctxt.reportInputMismatch(_beanType,
                              "Missing external type id property '%s'",
                              extProp.getTypePropertyName());
                  } else {
                      typeId = extProp.getDefaultTypeId();
                  }
              } else if (_tokens[i] == null) {
                  SettableBeanProperty prop = extProp.getProperty();
                  ctxt.reportInputMismatch(_beanType,
                          "Missing property '%s' for external type id '%s'",
                          prop.getName(), _properties[i].getTypePropertyName());
              }
              values[i] = _deserialize(p, ctxt, i, typeId);

              final SettableBeanProperty prop = extProp.getProperty();
              // also: if it's creator prop, fill in
              if (prop.getCreatorIndex() >= 0) {
                  buffer.assignParameter(prop, values[i]);

                  // [databind#999] And maybe there's creator property for type id too?
                  SettableBeanProperty typeProp = extProp.getTypeProperty();
                  // for now, should only be needed for creator properties, too
                  if ((typeProp != null) && (typeProp.getCreatorIndex() >= 0)) {
                      // 31-May-2018, tatu: [databind#1328] if id is NOT plain `String`, need to
                      //    apply deserializer... fun fun.
                      final Object v;
                      if (typeProp.getType().hasRawClass(String.class)) {
                          v = typeId;
                      } else {
                          TokenBuffer tb = new TokenBuffer(p, ctxt);
                          tb.writeString(typeId);
                          v = typeProp.getValueDeserializer().deserialize(tb.asParserOnFirstToken(), ctxt);
                          tb.close();
                      }
                      buffer.assignParameter(typeProp, v);
                  }
              }
          } to for (int i = 0; i < len; ++i) {
              String typeId = _typeIds[i];
              final ExtTypedProperty extProp = _properties[i];
              if (typeId == null) {
                  // let's allow missing both type and property (may already have been set, too)
                  if (_tokens[i] == null) {
                      continue;
                  }
                  // but not just one
                  // 26-Oct-2012, tatu: As per [databind#94], must allow use of 'defaultImpl'
                  if (!extProp.hasDefaultType()) {
                      ctxt.reportInputMismatch(_beanType,
                              "Missing external type id property '%s'",
                              extProp.getTypePropertyName());
                  } else {
                      typeId = extProp.getDefaultTypeId();
                  }
              } else if (_tokens[i] == null) {
                  SettableBeanProperty prop = extProp.getProperty();
                  ctxt.reportInputMismatch(_beanType,
                          "Missing property '%s' for external type id '%s'",
                          prop.getName(), _properties[i].getTypePropertyName());
              }
              values[i] = _deserialize(p, ctxt, i, typeId);

              final SettableBeanProperty prop = extProp.getProperty();
              // also: if it's creator prop, fill in
              if (prop.getCreatorIndex() >= 0) {
                  buffer.assignParameter(prop, values[i]);

                  // [databind#999] And maybe there's creator property for type id too?
                  SettableBeanProperty typeProp = extProp.getTypeProperty();
                  // for now, should only be needed for creator properties, too
                  if ((typeProp != null) && (typeProp.getCreatorIndex() >= 0)) {
                      // 31-May-2018, tatu: [databind#1328] if id is NOT plain `String`, need to
                      //    apply deserializer... fun fun.
                      buffer.assignParameter(typeProp, typeId);
                  }
              }
          }
  ------------
  ===
  update-node
  ---
  for_statement: for (int i = 0; i < len; ++i) {
              String typeId = _typeIds[i];
              final ExtTypedProperty extProp = _properties[i];
              if (typeId == null) {
                  // let's allow missing both type and property (may already have been set, too)
                  if (_tokens[i] == null) {
                      continue;
                  }
                  // but not just one
                  // 26-Oct-2012, tatu: As per [databind#94], must allow use of 'defaultImpl'
                  if (!extProp.hasDefaultType()) {
                      ctxt.reportInputMismatch(_beanType,
                              "Missing external type id property '%s'",
                              extProp.getTypePropertyName());
                  } else {
                      typeId = extProp.getDefaultTypeId();
                  }
              } else if (_tokens[i] == null) {
                  SettableBeanProperty prop = extProp.getProperty();
                  ctxt.reportInputMismatch(_beanType,
                          "Missing property '%s' for external type id '%s'",
                          prop.getName(), _properties[i].getTypePropertyName());
              }
              values[i] = _deserialize(p, ctxt, i, typeId);

              final SettableBeanProperty prop = extProp.getProperty();
              // also: if it's creator prop, fill in
              if (prop.getCreatorIndex() >= 0) {
                  buffer.assignParameter(prop, values[i]);

                  // [databind#999] And maybe there's creator property for type id too?
                  SettableBeanProperty typeProp = extProp.getTypeProperty();
                  // for now, should only be needed for creator properties, too
                  if ((typeProp != null) && (typeProp.getCreatorIndex() >= 0)) {
                      // 31-May-2018, tatu: [databind#1328] if id is NOT plain `String`, need to
                      //    apply deserializer... fun fun.
                      final Object v;
                      if (typeProp.getType().hasRawClass(String.class)) {
                          v = typeId;
                      } else {
                          TokenBuffer tb = new TokenBuffer(p, ctxt);
                          tb.writeString(typeId);
                          v = typeProp.getValueDeserializer().deserialize(tb.asParserOnFirstToken(), ctxt);
                          tb.close();
                      }
                      buffer.assignParameter(typeProp, v);
                  }
              }
          } [10413,12865]
  replace for (int i = 0; i < len; ++i) {
              String typeId = _typeIds[i];
              final ExtTypedProperty extProp = _properties[i];
              if (typeId == null) {
                  // let's allow missing both type and property (may already have been set, too)
                  if (_tokens[i] == null) {
                      continue;
                  }
                  // but not just one
                  // 26-Oct-2012, tatu: As per [databind#94], must allow use of 'defaultImpl'
                  if (!extProp.hasDefaultType()) {
                      ctxt.reportInputMismatch(_beanType,
                              "Missing external type id property '%s'",
                              extProp.getTypePropertyName());
                  } else {
                      typeId = extProp.getDefaultTypeId();
                  }
              } else if (_tokens[i] == null) {
                  SettableBeanProperty prop = extProp.getProperty();
                  ctxt.reportInputMismatch(_beanType,
                          "Missing property '%s' for external type id '%s'",
                          prop.getName(), _properties[i].getTypePropertyName());
              }
              values[i] = _deserialize(p, ctxt, i, typeId);

              final SettableBeanProperty prop = extProp.getProperty();
              // also: if it's creator prop, fill in
              if (prop.getCreatorIndex() >= 0) {
                  buffer.assignParameter(prop, values[i]);

                  // [databind#999] And maybe there's creator property for type id too?
                  SettableBeanProperty typeProp = extProp.getTypeProperty();
                  // for now, should only be needed for creator properties, too
                  if ((typeProp != null) && (typeProp.getCreatorIndex() >= 0)) {
                      // 31-May-2018, tatu: [databind#1328] if id is NOT plain `String`, need to
                      //    apply deserializer... fun fun.
                      final Object v;
                      if (typeProp.getType().hasRawClass(String.class)) {
                          v = typeId;
                      } else {
                          TokenBuffer tb = new TokenBuffer(p, ctxt);
                          tb.writeString(typeId);
                          v = typeProp.getValueDeserializer().deserialize(tb.asParserOnFirstToken(), ctxt);
                          tb.close();
                      }
                      buffer.assignParameter(typeProp, v);
                  }
              }
          } by for (int i = 0; i < len; ++i) {
              String typeId = _typeIds[i];
              final ExtTypedProperty extProp = _properties[i];
              if (typeId == null) {
                  // let's allow missing both type and property (may already have been set, too)
                  if (_tokens[i] == null) {
                      continue;
                  }
                  // but not just one
                  // 26-Oct-2012, tatu: As per [databind#94], must allow use of 'defaultImpl'
                  if (!extProp.hasDefaultType()) {
                      ctxt.reportInputMismatch(_beanType,
                              "Missing external type id property '%s'",
                              extProp.getTypePropertyName());
                  } else {
                      typeId = extProp.getDefaultTypeId();
                  }
              } else if (_tokens[i] == null) {
                  SettableBeanProperty prop = extProp.getProperty();
                  ctxt.reportInputMismatch(_beanType,
                          "Missing property '%s' for external type id '%s'",
                          prop.getName(), _properties[i].getTypePropertyName());
              }
              values[i] = _deserialize(p, ctxt, i, typeId);

              final SettableBeanProperty prop = extProp.getProperty();
              // also: if it's creator prop, fill in
              if (prop.getCreatorIndex() >= 0) {
                  buffer.assignParameter(prop, values[i]);

                  // [databind#999] And maybe there's creator property for type id too?
                  SettableBeanProperty typeProp = extProp.getTypeProperty();
                  // for now, should only be needed for creator properties, too
                  if ((typeProp != null) && (typeProp.getCreatorIndex() >= 0)) {
                      // 31-May-2018, tatu: [databind#1328] if id is NOT plain `String`, need to
                      //    apply deserializer... fun fun.
                      buffer.assignParameter(typeProp, typeId);
                  }
              }
          }

...
