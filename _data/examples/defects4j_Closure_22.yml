---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: CheckSideEffects
        children: []
        pos: 1344
        length: 16
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: |-
              static final DiagnosticType USELESS_CODE_ERROR = DiagnosticType.warning(
                    "JSC_USELESS_CODE",
                    "Suspicious code. {0}");
          children: []
          pos: 1435
          length: 129
        - type: field_declaration
          fields:
            text: static final String PROTECTOR_FN = "JSCOMPILER_PRESERVE";
          children: []
          pos: 1568
          length: 57
        - type: field_declaration
          fields:
            text: private final CheckLevel level;
          children: []
          pos: 1629
          length: 31
        - type: field_declaration
          fields:
            text: private final List<Node> problemNodes = Lists.newArrayList();
          children: []
          pos: 1664
          length: 61
        - type: field_declaration
          fields:
            text: private final AbstractCompiler compiler;
          children: []
          pos: 1729
          length: 40
        - type: field_declaration
          fields:
            text: private final boolean protectSideEffectFreeCode;
          children: []
          pos: 1773
          length: 48
        - type: constructor_declaration
          fields:
            text: |-
              CheckSideEffects(AbstractCompiler compiler, CheckLevel level,
                    boolean protectSideEffectFreeCode) {
                  this.compiler = compiler;
                  this.level = level;
                  this.protectSideEffectFreeCode = protectSideEffectFreeCode;
                }
          children: []
          pos: 1825
          length: 226
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: process
              children: []
              pos: 2079
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node externs
                children: []
                pos: 2087
                length: 12
              pos: 2055
              length: 453
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: NodeTraversal.traverse(compiler, root, this);
                children: []
                pos: 2118
                length: 45
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: protectSideEffectFreeCode
                        children: []
                        pos: 2442
                        length: 25
                    children: []
                    pos: 2441
                    length: 27
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: protectSideEffects();
                    children: []
                    pos: 2477
                    length: 21
                  pos: 2469
                  length: 35
                pos: 2438
                length: 66
              pos: 2112
              length: 396
          children: []
          pos: 2055
          length: 453
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: hotSwapScript
              children: []
              pos: 2536
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node scriptRoot
                children: []
                pos: 2550
                length: 15
              pos: 2512
              length: 135
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: NodeTraversal.traverse(compiler, scriptRoot, this);
                children: []
                pos: 2592
                length: 51
              pos: 2586
              length: 61
          children: []
          pos: 2512
          length: 135
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: visit
              children: []
              pos: 2675
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: NodeTraversal t
                children: []
                pos: 2681
                length: 15
              pos: 2651
              length: 1776
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isEmpty()
                            children: []
                            pos: 2978
                            length: 11
                          right:
                            type: method_invocation
                            fields:
                              text: n.isComma()
                            children: []
                            pos: 3001
                            length: 11
                        children: []
                        pos: 2978
                        length: 34
                    children: []
                    pos: 2977
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3022
                    length: 7
                  pos: 3014
                  length: 21
                pos: 2974
                length: 61
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: parent
                            children: []
                            pos: 3045
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3055
                            length: 4
                        children: []
                        pos: 3045
                        length: 14
                    children: []
                    pos: 3044
                    length: 16
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3069
                    length: 7
                  pos: 3061
                  length: 21
                pos: 3041
                length: 41
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isExprResult()
                            children: []
                            pos: 3305
                            length: 16
                          right:
                            type: method_invocation
                            fields:
                              text: n.isBlock()
                            children: []
                            pos: 3325
                            length: 11
                        children: []
                        pos: 3305
                        length: 31
                    children: []
                    pos: 3304
                    length: 33
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3346
                    length: 7
                  pos: 3338
                  length: 21
                pos: 3301
                length: 58
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: and
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isQualifiedName()
                            children: []
                            pos: 3512
                            length: 19
                          right:
                            type: not_equals
                            fields:
                              left:
                                type: method_invocation
                                fields:
                                  text: n.getJSDocInfo()
                                children: []
                                pos: 3535
                                length: 16
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 3555
                                length: 4
                            children: []
                            pos: 3535
                            length: 24
                        children: []
                        pos: 3512
                        length: 47
                    children: []
                    pos: 3511
                    length: 49
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3569
                    length: 7
                  pos: 3561
                  length: 21
                pos: 3508
                length: 74
              - type: local_variable_declaration
                fields:
                  text: boolean isResultUsed = NodeUtil.isExpressionResultUsed(n);
                children: []
                pos: 3588
                length: 58
              - type: local_variable_declaration
                fields:
                  text: boolean isSimpleOp = NodeUtil.isSimpleOperatorType(n.getType());
                children: []
                pos: 3651
                length: 64
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: and
                        fields:
                          left:
                            type: unary_expression
                            fields:
                              text: "!isResultUsed"
                            children: []
                            pos: 3724
                            length: 13
                          right:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: or
                                fields:
                                  left:
                                    type: identifier
                                    fields:
                                      text: isSimpleOp
                                    children: []
                                    pos: 3750
                                    length: 10
                                  right:
                                    type: unary_expression
                                    fields:
                                      text: "!NodeUtil.mayHaveSideEffects(n, t.getCompiler())"
                                    children: []
                                    pos: 3764
                                    length: 48
                                children: []
                                pos: 3750
                                length: 62
                            children: []
                            pos: 3749
                            length: 64
                        children: []
                        pos: 3724
                        length: 89
                    children: []
                    pos: 3723
                    length: 91
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String msg = "This code lacks side-effects. Is there a
                        bug?";
                    children: []
                    pos: 3823
                    length: 61
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: n.isString()
                            children: []
                            pos: 3895
                            length: 12
                        children: []
                        pos: 3894
                        length: 14
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: msg = "Is there a missing '+' on the previous line?";
                        children: []
                        pos: 3919
                        length: 53
                      pos: 3909
                      length: 71
                    pos: 3891
                    length: 243
                  - type: expression_statement
                    fields:
                      text: |-
                        t.getCompiler().report(
                                  t.makeError(n, level, USELESS_CODE_ERROR, msg));
                    children: []
                    pos: 4142
                    length: 82
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: unary_expression
                            fields:
                              text: "!NodeUtil.isStatement(n)"
                            children: []
                            pos: 4353
                            length: 24
                        children: []
                        pos: 4352
                        length: 26
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: problemNodes.add(n);
                        children: []
                        pos: 4389
                        length: 20
                      pos: 4379
                      length: 38
                    pos: 4349
                    length: 68
                  pos: 3815
                  length: 608
                pos: 3720
                length: 703
              pos: 2719
              length: 1708
          children: []
          pos: 2651
          length: 1776
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: protectSideEffects
              children: []
              pos: 4627
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 4614
              length: 490
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!problemNodes.isEmpty()"
                        children: []
                        pos: 4658
                        length: 23
                    children: []
                    pos: 4657
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: addExtern();
                    children: []
                    pos: 4691
                    length: 12
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Node n : problemNodes) {
                                Node name = IR.name(PROTECTOR_FN).srcref(n);
                                name.putBooleanProp(Node.IS_CONSTANT_NAME, true);
                                Node replacement = IR.call(name).srcref(n);
                                replacement.putBooleanProp(Node.FREE_CALL, true);
                                n.getParent().replaceChild(n, replacement);
                                replacement.addChildToBack(n);
                              }
                    children: []
                    pos: 4710
                    length: 349
                  - type: expression_statement
                    fields:
                      text: compiler.reportCodeChange();
                    children: []
                    pos: 5066
                    length: 28
                  pos: 4683
                  length: 417
                pos: 4654
                length: 446
              pos: 4648
              length: 456
          children: []
          pos: 4614
          length: 490
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: addExtern
              children: []
              pos: 5121
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5108
              length: 517
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Node name = IR.name(PROTECTOR_FN);
                children: []
                pos: 5139
                length: 34
              - type: expression_statement
                fields:
                  text: name.putBooleanProp(Node.IS_CONSTANT_NAME, true);
                children: []
                pos: 5178
                length: 49
              - type: local_variable_declaration
                fields:
                  text: Node var = IR.var(name);
                children: []
                pos: 5232
                length: 24
              - type: local_variable_declaration
                fields:
                  text: JSDocInfoBuilder builder = new JSDocInfoBuilder(false);
                children: []
                pos: 5342
                length: 55
              - type: expression_statement
                fields:
                  text: builder.recordNoAlias();
                children: []
                pos: 5402
                length: 24
              - type: expression_statement
                fields:
                  text: var.setJSDocInfo(builder.build(var));
                children: []
                pos: 5431
                length: 37
              - type: local_variable_declaration
                fields:
                  text: CompilerInput input = compiler.getSynthesizedExternsInput();
                children: []
                pos: 5473
                length: 60
              - type: expression_statement
                fields:
                  text: input.getAstRoot(compiler).addChildrenToBack(var);
                children: []
                pos: 5538
                length: 50
              - type: expression_statement
                fields:
                  text: compiler.reportCodeChange();
                children: []
                pos: 5593
                length: 28
              pos: 5133
              length: 492
          children: []
          pos: 5108
          length: 517
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: StripProtection
              children: []
              pos: 5694
              length: 15
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final AbstractCompiler compiler;
                children: []
                pos: 5775
                length: 40
              - type: constructor_declaration
                fields:
                  text: |-
                    StripProtection(AbstractCompiler compiler) {
                          this.compiler = compiler;
                        }
                children: []
                pos: 5821
                length: 82
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: process
                    children: []
                    pos: 5935
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node externs
                      children: []
                      pos: 5943
                      length: 12
                    pos: 5909
                    length: 118
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: NodeTraversal.traverse(compiler, root, this);
                      children: []
                      pos: 5976
                      length: 45
                    pos: 5968
                    length: 59
                children: []
                pos: 5909
                length: 118
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visit
                    children: []
                    pos: 6059
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 6065
                      length: 15
                    pos: 6033
                    length: 465
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: n.isCall()
                              children: []
                              pos: 6115
                              length: 10
                          children: []
                          pos: 6114
                          length: 12
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: local_variable_declaration
                          fields:
                            text: Node target = n.getFirstChild();
                          children: []
                          pos: 6137
                          length: 32
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: and
                                  fields:
                                    left:
                                      type: method_invocation
                                      fields:
                                        text: target.isName()
                                      children: []
                                      pos: 6303
                                      length: 15
                                    right:
                                      type: method_invocation
                                      fields:
                                        text: target.getString().equals(PROTECTOR_FN)
                                      children: []
                                      pos: 6322
                                      length: 39
                                  children: []
                                  pos: 6303
                                  length: 58
                              children: []
                              pos: 6302
                              length: 60
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: local_variable_declaration
                              fields:
                                text: Node expr = n.getLastChild();
                              children: []
                              pos: 6375
                              length: 29
                            - type: expression_statement
                              fields:
                                text: n.detachChildren();
                              children: []
                              pos: 6415
                              length: 19
                            - type: expression_statement
                              fields:
                                text: parent.replaceChild(n, expr);
                              children: []
                              pos: 6445
                              length: 29
                            pos: 6363
                            length: 121
                          pos: 6299
                          length: 185
                        pos: 6127
                        length: 365
                      pos: 6111
                      length: 381
                    pos: 6103
                    length: 395
                children: []
                pos: 6033
                length: 465
              pos: 5681
              length: 821
          children: []
          pos: 5681
          length: 821
        pos: 1332
        length: 5172
    children: []
    pos: 1332
    length: 5172
  pos: 0
  length: 6505
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: CheckSideEffects
        children: []
        pos: 1344
        length: 16
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: |-
              static final DiagnosticType USELESS_CODE_ERROR = DiagnosticType.warning(
                    "JSC_USELESS_CODE",
                    "Suspicious code. {0}");
          children: []
          pos: 1435
          length: 129
        - type: field_declaration
          fields:
            text: static final String PROTECTOR_FN = "JSCOMPILER_PRESERVE";
          children: []
          pos: 1568
          length: 57
        - type: field_declaration
          fields:
            text: private final CheckLevel level;
          children: []
          pos: 1629
          length: 31
        - type: field_declaration
          fields:
            text: private final List<Node> problemNodes = Lists.newArrayList();
          children: []
          pos: 1664
          length: 61
        - type: field_declaration
          fields:
            text: private final AbstractCompiler compiler;
          children: []
          pos: 1729
          length: 40
        - type: field_declaration
          fields:
            text: private final boolean protectSideEffectFreeCode;
          children: []
          pos: 1773
          length: 48
        - type: constructor_declaration
          fields:
            text: |-
              CheckSideEffects(AbstractCompiler compiler, CheckLevel level,
                    boolean protectSideEffectFreeCode) {
                  this.compiler = compiler;
                  this.level = level;
                  this.protectSideEffectFreeCode = protectSideEffectFreeCode;
                }
          children: []
          pos: 1825
          length: 226
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: process
              children: []
              pos: 2079
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node externs
                children: []
                pos: 2087
                length: 12
              pos: 2055
              length: 453
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: NodeTraversal.traverse(compiler, root, this);
                children: []
                pos: 2118
                length: 45
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: protectSideEffectFreeCode
                        children: []
                        pos: 2442
                        length: 25
                    children: []
                    pos: 2441
                    length: 27
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: protectSideEffects();
                    children: []
                    pos: 2477
                    length: 21
                  pos: 2469
                  length: 35
                pos: 2438
                length: 66
              pos: 2112
              length: 396
          children: []
          pos: 2055
          length: 453
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: hotSwapScript
              children: []
              pos: 2536
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node scriptRoot
                children: []
                pos: 2550
                length: 15
              pos: 2512
              length: 135
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: NodeTraversal.traverse(compiler, scriptRoot, this);
                children: []
                pos: 2592
                length: 51
              pos: 2586
              length: 61
          children: []
          pos: 2512
          length: 135
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: visit
              children: []
              pos: 2675
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: NodeTraversal t
                children: []
                pos: 2681
                length: 15
              pos: 2651
              length: 2741
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isEmpty()
                            children: []
                            pos: 2978
                            length: 11
                          right:
                            type: method_invocation
                            fields:
                              text: n.isComma()
                            children: []
                            pos: 3001
                            length: 11
                        children: []
                        pos: 2978
                        length: 34
                    children: []
                    pos: 2977
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3022
                    length: 7
                  pos: 3014
                  length: 21
                pos: 2974
                length: 61
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: parent
                            children: []
                            pos: 3045
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3055
                            length: 4
                        children: []
                        pos: 3045
                        length: 14
                    children: []
                    pos: 3044
                    length: 16
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3069
                    length: 7
                  pos: 3061
                  length: 21
                pos: 3041
                length: 41
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: parent.getType()
                            children: []
                            pos: 3305
                            length: 16
                          right:
                            type: field_access
                            fields:
                              text: Token.COMMA
                            children: []
                            pos: 3325
                            length: 11
                        children: []
                        pos: 3305
                        length: 31
                    children: []
                    pos: 3304
                    length: 33
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: Node gramps = parent.getParent();
                    children: []
                    pos: 3346
                    length: 33
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: and
                            fields:
                              left:
                                type: method_invocation
                                fields:
                                  text: gramps.isCall()
                                children: []
                                pos: 3390
                                length: 15
                              right:
                                type: equals
                                fields:
                                  left:
                                    type: identifier
                                    fields:
                                      text: parent
                                    children: []
                                    pos: 3409
                                    length: 6
                                  right:
                                    type: method_invocation
                                    fields:
                                      text: gramps.getFirstChild()
                                    children: []
                                    pos: 3419
                                    length: 22
                                children: []
                                pos: 3409
                                length: 32
                            children: []
                            pos: 3390
                            length: 51
                        children: []
                        pos: 3389
                        length: 53
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: if_statement
                        fields:
                          condition:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: and
                                fields:
                                  left:
                                    type: and
                                    fields:
                                      left:
                                        type: and
                                        fields:
                                          left:
                                            type: equals
                                            fields:
                                              left:
                                                type: identifier
                                                fields:
                                                  text: "n"
                                                children: []
                                                pos: 3457
                                                length: 1
                                              right:
                                                type: method_invocation
                                                fields:
                                                  text: parent.getFirstChild()
                                                children: []
                                                pos: 3462
                                                length: 22
                                            children: []
                                            pos: 3457
                                            length: 27
                                          right:
                                            type: equals
                                            fields:
                                              left:
                                                type: method_invocation
                                                fields:
                                                  text: parent.getChildCount()
                                                children: []
                                                pos: 3488
                                                length: 22
                                              right:
                                                type: decimal_integer_literal
                                                fields:
                                                  text: '2'
                                                children: []
                                                pos: 3514
                                                length: 1
                                            children: []
                                            pos: 3488
                                            length: 27
                                        children: []
                                        pos: 3457
                                        length: 58
                                      right:
                                        type: method_invocation
                                        fields:
                                          text: n.getNext().isName()
                                        children: []
                                        pos: 3519
                                        length: 20
                                    children: []
                                    pos: 3457
                                    length: 82
                                  right:
                                    type: method_invocation
                                    fields:
                                      text: '"eval".equals(n.getNext().getString())'
                                    children: []
                                    pos: 3543
                                    length: 38
                                children: []
                                pos: 3457
                                length: 124
                            children: []
                            pos: 3456
                            length: 126
                        children:
                        - type: block
                          fields: {}
                          children:
                          - type: return_statement
                            fields:
                              text: return;
                            children: []
                            pos: 3591
                            length: 7
                          pos: 3583
                          length: 25
                        pos: 3453
                        length: 155
                      pos: 3443
                      length: 171
                    pos: 3386
                    length: 228
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: "n"
                                children: []
                                pos: 3769
                                length: 1
                              right:
                                type: method_invocation
                                fields:
                                  text: parent.getLastChild()
                                children: []
                                pos: 3774
                                length: 21
                            children: []
                            pos: 3769
                            length: 26
                        children: []
                        pos: 3768
                        length: 28
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: enhanced_for_statement
                        fields:
                          text: |-
                            for (Node an : parent.getAncestors()) {
                                      int ancestorType = an.getType();
                                      if (ancestorType == Token.COMMA)
                                        continue;
                                      if (ancestorType != Token.EXPR_RESULT && ancestorType != Token.BLOCK)
                                        return;
                                      else
                                        break;
                                    }
                        children: []
                        pos: 3807
                        length: 291
                      pos: 3797
                      length: 309
                    pos: 3765
                    length: 341
                  pos: 3338
                  length: 774
                pos: 3301
                length: 1108
              - type: local_variable_declaration
                fields:
                  text: boolean isResultUsed = NodeUtil.isExpressionResultUsed(n);
                children: []
                pos: 4415
                length: 58
              - type: local_variable_declaration
                fields:
                  text: boolean isSimpleOp = NodeUtil.isSimpleOperatorType(n.getType());
                children: []
                pos: 4478
                length: 64
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: and
                        fields:
                          left:
                            type: unary_expression
                            fields:
                              text: "!isResultUsed"
                            children: []
                            pos: 4551
                            length: 13
                          right:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: or
                                fields:
                                  left:
                                    type: identifier
                                    fields:
                                      text: isSimpleOp
                                    children: []
                                    pos: 4577
                                    length: 10
                                  right:
                                    type: unary_expression
                                    fields:
                                      text: "!NodeUtil.mayHaveSideEffects(n, t.getCompiler())"
                                    children: []
                                    pos: 4591
                                    length: 48
                                children: []
                                pos: 4577
                                length: 62
                            children: []
                            pos: 4576
                            length: 64
                        children: []
                        pos: 4551
                        length: 89
                    children: []
                    pos: 4550
                    length: 91
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: and
                            fields:
                              left:
                                type: method_invocation
                                fields:
                                  text: n.isQualifiedName()
                                children: []
                                pos: 4654
                                length: 19
                              right:
                                type: not_equals
                                fields:
                                  left:
                                    type: method_invocation
                                    fields:
                                      text: n.getJSDocInfo()
                                    children: []
                                    pos: 4677
                                    length: 16
                                  right:
                                    type: null_literal
                                    fields: {}
                                    children: []
                                    pos: 4697
                                    length: 4
                                children: []
                                pos: 4677
                                length: 24
                            children: []
                            pos: 4654
                            length: 47
                        children: []
                        pos: 4653
                        length: 49
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: return_statement
                        fields:
                          text: return;
                        children: []
                        pos: 4713
                        length: 7
                      pos: 4703
                      length: 25
                    pos: 4650
                    length: 131
                  - type: local_variable_declaration
                    fields:
                      text: String msg = "This code lacks side-effects. Is there a
                        bug?";
                    children: []
                    pos: 4788
                    length: 61
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: n.isString()
                            children: []
                            pos: 4860
                            length: 12
                        children: []
                        pos: 4859
                        length: 14
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: msg = "Is there a missing '+' on the previous line?";
                        children: []
                        pos: 4884
                        length: 53
                      pos: 4874
                      length: 71
                    pos: 4856
                    length: 243
                  - type: expression_statement
                    fields:
                      text: |-
                        t.getCompiler().report(
                                  t.makeError(n, level, USELESS_CODE_ERROR, msg));
                    children: []
                    pos: 5107
                    length: 82
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: unary_expression
                            fields:
                              text: "!NodeUtil.isStatement(n)"
                            children: []
                            pos: 5318
                            length: 24
                        children: []
                        pos: 5317
                        length: 26
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: problemNodes.add(n);
                        children: []
                        pos: 5354
                        length: 20
                      pos: 5344
                      length: 38
                    pos: 5314
                    length: 68
                  pos: 4642
                  length: 746
                pos: 4547
                length: 841
              pos: 2719
              length: 2673
          children: []
          pos: 2651
          length: 2741
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: protectSideEffects
              children: []
              pos: 5592
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5579
              length: 490
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!problemNodes.isEmpty()"
                        children: []
                        pos: 5623
                        length: 23
                    children: []
                    pos: 5622
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: addExtern();
                    children: []
                    pos: 5656
                    length: 12
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Node n : problemNodes) {
                                Node name = IR.name(PROTECTOR_FN).srcref(n);
                                name.putBooleanProp(Node.IS_CONSTANT_NAME, true);
                                Node replacement = IR.call(name).srcref(n);
                                replacement.putBooleanProp(Node.FREE_CALL, true);
                                n.getParent().replaceChild(n, replacement);
                                replacement.addChildToBack(n);
                              }
                    children: []
                    pos: 5675
                    length: 349
                  - type: expression_statement
                    fields:
                      text: compiler.reportCodeChange();
                    children: []
                    pos: 6031
                    length: 28
                  pos: 5648
                  length: 417
                pos: 5619
                length: 446
              pos: 5613
              length: 456
          children: []
          pos: 5579
          length: 490
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: addExtern
              children: []
              pos: 6086
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 6073
              length: 517
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Node name = IR.name(PROTECTOR_FN);
                children: []
                pos: 6104
                length: 34
              - type: expression_statement
                fields:
                  text: name.putBooleanProp(Node.IS_CONSTANT_NAME, true);
                children: []
                pos: 6143
                length: 49
              - type: local_variable_declaration
                fields:
                  text: Node var = IR.var(name);
                children: []
                pos: 6197
                length: 24
              - type: local_variable_declaration
                fields:
                  text: JSDocInfoBuilder builder = new JSDocInfoBuilder(false);
                children: []
                pos: 6307
                length: 55
              - type: expression_statement
                fields:
                  text: builder.recordNoAlias();
                children: []
                pos: 6367
                length: 24
              - type: expression_statement
                fields:
                  text: var.setJSDocInfo(builder.build(var));
                children: []
                pos: 6396
                length: 37
              - type: local_variable_declaration
                fields:
                  text: CompilerInput input = compiler.getSynthesizedExternsInput();
                children: []
                pos: 6438
                length: 60
              - type: expression_statement
                fields:
                  text: input.getAstRoot(compiler).addChildrenToBack(var);
                children: []
                pos: 6503
                length: 50
              - type: expression_statement
                fields:
                  text: compiler.reportCodeChange();
                children: []
                pos: 6558
                length: 28
              pos: 6098
              length: 492
          children: []
          pos: 6073
          length: 517
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: StripProtection
              children: []
              pos: 6659
              length: 15
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final AbstractCompiler compiler;
                children: []
                pos: 6740
                length: 40
              - type: constructor_declaration
                fields:
                  text: |-
                    StripProtection(AbstractCompiler compiler) {
                          this.compiler = compiler;
                        }
                children: []
                pos: 6786
                length: 82
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: process
                    children: []
                    pos: 6900
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node externs
                      children: []
                      pos: 6908
                      length: 12
                    pos: 6874
                    length: 118
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: NodeTraversal.traverse(compiler, root, this);
                      children: []
                      pos: 6941
                      length: 45
                    pos: 6933
                    length: 59
                children: []
                pos: 6874
                length: 118
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visit
                    children: []
                    pos: 7024
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 7030
                      length: 15
                    pos: 6998
                    length: 465
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: n.isCall()
                              children: []
                              pos: 7080
                              length: 10
                          children: []
                          pos: 7079
                          length: 12
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: local_variable_declaration
                          fields:
                            text: Node target = n.getFirstChild();
                          children: []
                          pos: 7102
                          length: 32
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: and
                                  fields:
                                    left:
                                      type: method_invocation
                                      fields:
                                        text: target.isName()
                                      children: []
                                      pos: 7268
                                      length: 15
                                    right:
                                      type: method_invocation
                                      fields:
                                        text: target.getString().equals(PROTECTOR_FN)
                                      children: []
                                      pos: 7287
                                      length: 39
                                  children: []
                                  pos: 7268
                                  length: 58
                              children: []
                              pos: 7267
                              length: 60
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: local_variable_declaration
                              fields:
                                text: Node expr = n.getLastChild();
                              children: []
                              pos: 7340
                              length: 29
                            - type: expression_statement
                              fields:
                                text: n.detachChildren();
                              children: []
                              pos: 7380
                              length: 19
                            - type: expression_statement
                              fields:
                                text: parent.replaceChild(n, expr);
                              children: []
                              pos: 7410
                              length: 29
                            pos: 7328
                            length: 121
                          pos: 7264
                          length: 185
                        pos: 7092
                        length: 365
                      pos: 7076
                      length: 381
                    pos: 7068
                    length: 395
                children: []
                pos: 6998
                length: 465
              pos: 6646
              length: 821
          children: []
          pos: 6646
          length: 821
        pos: 1332
        length: 6137
    children: []
    pos: 1332
    length: 6137
  pos: 0
  length: 7470
text_diff: "--- before\n+++ after\n@@ -98,20 +98,44 @@\n     // Do not try to remove
  a block or an expr result. We already handle\n     // these cases when we visit
  the child, and the peephole passes will\n     // fix up the tree in more clever
  ways when these are removed.\n-    if (n.isExprResult() || n.isBlock()) {\n+    if
  (parent.getType() == Token.COMMA) {\n+      Node gramps = parent.getParent();\n+
  \     if (gramps.isCall() && parent == gramps.getFirstChild()) {\n+        if (n
  == parent.getFirstChild() && parent.getChildCount() == 2 && n.getNext().isName()
  && \"eval\".equals(n.getNext().getString())) {\n       return;\n+        }\n     }\n
  \n     // This no-op statement was there so that JSDoc information could\n     //
  be attached to the name. This check should not complain about it.\n-    if (n.isQualifiedName()
  && n.getJSDocInfo() != null) {\n+      if (n == parent.getLastChild()) {\n+        for
  (Node an : parent.getAncestors()) {\n+          int ancestorType = an.getType();\n+
  \         if (ancestorType == Token.COMMA)\n+            continue;\n+          if
  (ancestorType != Token.EXPR_RESULT && ancestorType != Token.BLOCK)\n+            return;\n+
  \         else\n+            break;\n+        }\n+      }\n+    } else if (parent.getType()
  != Token.EXPR_RESULT && parent.getType() != Token.BLOCK) {\n+      if (parent.getType()
  == Token.FOR && parent.getChildCount() == 4 && (n == parent.getFirstChild() ||\n+
  \          n == parent.getFirstChild().getNext().getNext())) {\n+      } else {\n
  \      return;\n+      }\n     }\n \n     boolean isResultUsed = NodeUtil.isExpressionResultUsed(n);\n
  \    boolean isSimpleOp = NodeUtil.isSimpleOperatorType(n.getType());\n     if (!isResultUsed
  &&\n         (isSimpleOp || !NodeUtil.mayHaveSideEffects(n, t.getCompiler()))) {\n+
  \     if (n.isQualifiedName() && n.getJSDocInfo() != null) {\n+        return;\n+
  \     } else if (n.isExprResult()) {\n+        return;\n+      }\n       String
  msg = \"This code lacks side-effects. Is there a bug?\";\n       if (n.isString())
  {\n         msg = \"Is there a missing '+' on the previous line?\";\n"
tree_diff: |+
  New cluster:
  ===
  insert-node
  ---
  block [3338,4112]
  to
  if_statement [3301,3359]
  at 1
  ------------
  ===
  insert-node
  ---
  block [3443,3614]
  to
  if_statement [3386,3614]
  at 1
  ===
  insert-node
  ---
  local_variable_declaration: Node gramps = parent.getParent(); [3346,3379]
  to
  block [3338,4112]
  at 0
  ===
  insert-node
  ---
  if_statement [3453,3608]
  to
  block [3443,3614]
  at 0
  ===
  insert-node
  ---
  if_statement [3386,3614]
  to
  block [3338,4112]
  at 1
  ===
  insert-node
  ---
  block [3338,4112]
  to
  if_statement [3301,3359]
  at 1

  New cluster:
  Unknown cluster type
  ------------
  ===
  insert-tree
  ---
  equals [3305,3336]
      method_invocation: parent.getType() [3305,3321]
      field_access: Token.COMMA [3325,3336]
  to
  parenthesized_expression [3304,3337]
  at 0

  New cluster:
  Unknown cluster type
  ------------
  ===
  insert-tree
  ---
  if_statement [3765,4106]
      parenthesized_expression [3768,3796]
          equals [3769,3795]
              identifier: n [3769,3770]
              method_invocation: parent.getLastChild() [3774,3795]
      block [3797,4106]
          enhanced_for_statement: for (Node an : parent.getAncestors()) {
            int ancestorType = an.getType();
            if (ancestorType == Token.COMMA)
              continue;
            if (ancestorType != Token.EXPR_RESULT && ancestorType != Token.BLOCK)
              return;
            else
              break;
          } [3807,4098]
  to
  block [3338,4112]
  at 2

  New cluster:
  MOVE from block [3815,4423]
  ------------
  ===
  move-tree
  ---
  if_statement [3508,3582]
      parenthesized_expression [3511,3560]
          and [3512,3559]
              method_invocation: n.isQualifiedName() [3512,3531]
              not_equals [3535,3559]
                  method_invocation: n.getJSDocInfo() [3535,3551]
                  null_literal [3555,3559]
      block [3561,3582]
          return_statement: return; [3569,3576]
  to
  block [3815,4423]
  at 0

  New cluster:
  Unknown cluster type
  ------------
  ===
  insert-tree
  ---
  parenthesized_expression [3389,3442]
      and [3390,3441]
          method_invocation: gramps.isCall() [3390,3405]
          equals [3409,3441]
              identifier: parent [3409,3415]
              method_invocation: gramps.getFirstChild() [3419,3441]
  to
  if_statement [3386,3614]
  at 0

  New cluster:
  Unknown cluster type
  ------------
  ===
  insert-tree
  ---
  parenthesized_expression [3456,3582]
      and [3457,3581]
          and [3457,3539]
              and [3457,3515]
                  equals [3457,3484]
                      identifier: n [3457,3458]
                      method_invocation: parent.getFirstChild() [3462,3484]
                  equals [3488,3515]
                      method_invocation: parent.getChildCount() [3488,3510]
                      decimal_integer_literal: 2 [3514,3515]
              method_invocation: n.getNext().isName() [3519,3539]
          method_invocation: "eval".equals(n.getNext().getString()) [3543,3581]
  to
  if_statement [3453,3608]
  at 0

  New cluster:
  MOVE from if_statement [3453,3608]
  ------------
  ===
  move-tree
  ---
  block [3338,3359]
      return_statement: return; [3346,3353]
  to
  if_statement [3453,3608]
  at 1

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  or [3305,3336]
      method_invocation: n.isExprResult() [3305,3321]
      method_invocation: n.isBlock() [3325,3336]

...
