---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: CollectionDeserializer
        children: []
        pos: 1165
        length: 22
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private static final long serialVersionUID = -1L;
          children: []
          pos: 1290
          length: 49
        - type: field_declaration
          fields:
            text: protected final JavaType _collectionType;
          children: []
          pos: 1383
          length: 41
        - type: field_declaration
          fields:
            text: protected final JsonDeserializer<Object> _valueDeserializer;
          children: []
          pos: 1477
          length: 60
        - type: field_declaration
          fields:
            text: protected final TypeDeserializer _valueTypeDeserializer;
          children: []
          pos: 1678
          length: 56
        - type: field_declaration
          fields:
            text: protected final ValueInstantiator _valueInstantiator;
          children: []
          pos: 1783
          length: 53
        - type: field_declaration
          fields:
            text: protected final JsonDeserializer<Object> _delegateDeserializer;
          children: []
          pos: 1975
          length: 63
        - type: field_declaration
          fields:
            text: protected final Boolean _unwrapSingle;
          children: []
          pos: 2313
          length: 38
        - type: constructor_declaration
          fields:
            text: |-
              public CollectionDeserializer(JavaType collectionType,
                          JsonDeserializer<Object> valueDeser,
                          TypeDeserializer valueTypeDeser, ValueInstantiator valueInstantiator)
                  {
                      this(collectionType, valueDeser, valueTypeDeser, valueInstantiator, null, null);
                  }
          children: []
          pos: 2730
          length: 286
        - type: constructor_declaration
          fields:
            text: |-
              protected CollectionDeserializer(JavaType collectionType,
                          JsonDeserializer<Object> valueDeser, TypeDeserializer valueTypeDeser,
                          ValueInstantiator valueInstantiator,
                          JsonDeserializer<Object> delegateDeser,
                          Boolean unwrapSingle)
                  {
                      super(collectionType);
                      _collectionType = collectionType;
                      _valueDeserializer = valueDeser;
                      _valueTypeDeserializer = valueTypeDeser;
                      _valueInstantiator = valueInstantiator;
                      _delegateDeserializer = delegateDeser;
                      _unwrapSingle = unwrapSingle;
                  }
          children: []
          pos: 3102
          length: 582
        - type: constructor_declaration
          fields:
            text: |-
              protected CollectionDeserializer(CollectionDeserializer src)
                  {
                      super(src._collectionType);
                      _collectionType = src._collectionType;
                      _valueDeserializer = src._valueDeserializer;
                      _valueTypeDeserializer = src._valueTypeDeserializer;
                      _valueInstantiator = src._valueInstantiator;
                      _delegateDeserializer = src._delegateDeserializer;
                      _unwrapSingle = src._unwrapSingle;
                  }
          children: []
          pos: 3845
          length: 424
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: withResolved
              children: []
              pos: 4452
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonDeserializer<?> dd
                children: []
                pos: 4465
                length: 22
              pos: 4384
              length: 597
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: and
                        fields:
                          left:
                            type: and
                            fields:
                              left:
                                type: and
                                fields:
                                  left:
                                    type: parenthesized_expression
                                    fields:
                                      expression:
                                        type: equals
                                        fields:
                                          left:
                                            type: identifier
                                            fields:
                                              text: dd
                                            children: []
                                            pos: 4600
                                            length: 2
                                          right:
                                            type: identifier
                                            fields:
                                              text: _delegateDeserializer
                                            children: []
                                            pos: 4606
                                            length: 21
                                        children: []
                                        pos: 4600
                                        length: 27
                                    children: []
                                    pos: 4599
                                    length: 29
                                  right:
                                    type: parenthesized_expression
                                    fields:
                                      expression:
                                        type: equals
                                        fields:
                                          left:
                                            type: identifier
                                            fields:
                                              text: vd
                                            children: []
                                            pos: 4633
                                            length: 2
                                          right:
                                            type: identifier
                                            fields:
                                              text: _valueDeserializer
                                            children: []
                                            pos: 4639
                                            length: 18
                                        children: []
                                        pos: 4633
                                        length: 24
                                    children: []
                                    pos: 4632
                                    length: 26
                                children: []
                                pos: 4599
                                length: 59
                              right:
                                type: parenthesized_expression
                                fields:
                                  expression:
                                    type: equals
                                    fields:
                                      left:
                                        type: identifier
                                        fields:
                                          text: vtd
                                        children: []
                                        pos: 4663
                                        length: 3
                                      right:
                                        type: identifier
                                        fields:
                                          text: _valueTypeDeserializer
                                        children: []
                                        pos: 4670
                                        length: 22
                                    children: []
                                    pos: 4663
                                    length: 29
                                children: []
                                pos: 4662
                                length: 31
                            children: []
                            pos: 4599
                            length: 94
                          right:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: equals
                                fields:
                                  left:
                                    type: identifier
                                    fields:
                                      text: _unwrapSingle
                                    children: []
                                    pos: 4714
                                    length: 13
                                  right:
                                    type: identifier
                                    fields:
                                      text: unwrapSingle
                                    children: []
                                    pos: 4731
                                    length: 12
                                children: []
                                pos: 4714
                                length: 29
                            children: []
                            pos: 4713
                            length: 31
                        children: []
                        pos: 4599
                        length: 145
                    children: []
                    pos: 4598
                    length: 147
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return this;
                    children: []
                    pos: 4760
                    length: 12
                  pos: 4746
                  length: 36
                pos: 4595
                length: 187
              - type: return_statement
                fields:
                  text: |-
                    return new CollectionDeserializer(_collectionType,
                                    (JsonDeserializer<Object>) vd, vtd,
                                    _valueInstantiator, (JsonDeserializer<Object>) dd, unwrapSingle);
                children: []
                pos: 4791
                length: 184
              pos: 4585
              length: 396
          children: []
          pos: 4384
          length: 597
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: withResolved
              children: []
              pos: 5171
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonDeserializer<?> dd
                children: []
                pos: 5184
                length: 22
              pos: 5067
              length: 267
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return withResolved(dd, vd, vtd, _unwrapSingle);
                children: []
                pos: 5280
                length: 48
              pos: 5270
              length: 64
          children: []
          pos: 5067
          length: 267
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: isCachable
              children: []
              pos: 5435
              length: 10
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5393
              length: 299
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: |-
                    return (_valueDeserializer == null)
                                    && (_valueTypeDeserializer == null)
                                    && (_delegateDeserializer == null)
                                    ;
                children: []
                pos: 5530
                length: 156
              pos: 5448
              length: 244
          children: []
          pos: 5393
          length: 299
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: createContextual
              children: []
              pos: 6101
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: DeserializationContext ctxt
                children: []
                pos: 6118
                length: 27
              pos: 6057
              length: 2972
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: JsonDeserializer<Object> delegateDeser = null;
                children: []
                pos: 6290
                length: 46
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _valueInstantiator
                            children: []
                            pos: 6349
                            length: 18
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 6371
                            length: 4
                        children: []
                        pos: 6349
                        length: 26
                    children: []
                    pos: 6348
                    length: 28
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: _valueInstantiator.canCreateUsingDelegate()
                            children: []
                            pos: 6395
                            length: 43
                        children: []
                        pos: 6394
                        length: 45
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: local_variable_declaration
                        fields:
                          text: JavaType delegateType = _valueInstantiator.getDelegateType(ctxt.getConfig());
                        children: []
                        pos: 6458
                        length: 77
                      - type: if_statement
                        fields:
                          condition:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: equals
                                fields:
                                  left:
                                    type: identifier
                                    fields:
                                      text: delegateType
                                    children: []
                                    pos: 6556
                                    length: 12
                                  right:
                                    type: null_literal
                                    fields: {}
                                    children: []
                                    pos: 6572
                                    length: 4
                                children: []
                                pos: 6556
                                length: 20
                            children: []
                            pos: 6555
                            length: 22
                        children:
                        - type: block
                          fields: {}
                          children:
                          - type: throw_statement
                            fields:
                              text: |-
                                throw new IllegalArgumentException("Invalid delegate-creator definition for "+_collectionType
                                                            +": value instantiator ("+_valueInstantiator.getClass().getName()
                                                            +") returned true for 'canCreateUsingDelegate()', but null for 'getDelegateType()'");
                            children: []
                            pos: 6600
                            length: 301
                          pos: 6578
                          length: 341
                        pos: 6552
                        length: 367
                      - type: expression_statement
                        fields:
                          text: delegateDeser = findDeserializer(ctxt, delegateType,
                            property);
                        children: []
                        pos: 6936
                        length: 63
                      pos: 6440
                      length: 573
                    pos: 6391
                    length: 1276
                  pos: 6377
                  length: 1300
                pos: 6345
                length: 1332
              - type: local_variable_declaration
                fields:
                  text: |-
                    Boolean unwrapSingle = findFormatFeature(ctxt, property, Collection.class,
                                    JsonFormat.Feature.ACCEPT_SINGLE_VALUE_AS_ARRAY);
                children: []
                pos: 7950
                length: 140
              - type: local_variable_declaration
                fields:
                  text: JsonDeserializer<?> valueDeser = _valueDeserializer;
                children: []
                pos: 8159
                length: 52
              - type: expression_statement
                fields:
                  text: valueDeser = findConvertingContentDeserializer(ctxt, property,
                    valueDeser);
                children: []
                pos: 8269
                length: 75
              - type: local_variable_declaration
                fields:
                  text: final JavaType vt = _collectionType.getContentType();
                children: []
                pos: 8353
                length: 53
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: valueDeser
                            children: []
                            pos: 8419
                            length: 10
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 8433
                            length: 4
                        children: []
                        pos: 8419
                        length: 18
                    children: []
                    pos: 8418
                    length: 20
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: valueDeser = ctxt.findContextualValueDeserializer(vt,
                        property);
                    children: []
                    pos: 8453
                    length: 64
                  pos: 8439
                  length: 88
                pos: 8415
                length: 277
              - type: local_variable_declaration
                fields:
                  text: TypeDeserializer valueTypeDeser = _valueTypeDeserializer;
                children: []
                pos: 8765
                length: 57
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: valueTypeDeser
                            children: []
                            pos: 8835
                            length: 14
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 8853
                            length: 4
                        children: []
                        pos: 8835
                        length: 22
                    children: []
                    pos: 8834
                    length: 24
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: valueTypeDeser = valueTypeDeser.forProperty(property);
                    children: []
                    pos: 8873
                    length: 54
                  pos: 8859
                  length: 78
                pos: 8831
                length: 106
              - type: return_statement
                fields:
                  text: return withResolved(delegateDeser, valueDeser, valueTypeDeser,
                    unwrapSingle);
                children: []
                pos: 8946
                length: 77
              pos: 6214
              length: 2815
          children: []
          pos: 6057
          length: 2972
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getContentType
              children: []
              pos: 9246
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 9216
              length: 103
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _collectionType.getContentType();
                children: []
                pos: 9273
                length: 40
              pos: 9263
              length: 56
          children: []
          pos: 9216
          length: 103
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getContentDeserializer
              children: []
              pos: 9371
              length: 22
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 9325
              length: 113
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _valueDeserializer;
                children: []
                pos: 9406
                length: 26
              pos: 9396
              length: 42
          children: []
          pos: 9325
          length: 113
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: deserialize
              children: []
              pos: 9699
              length: 11
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 9711
                length: 12
              pos: 9624
              length: 933
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _delegateDeserializer
                            children: []
                            pos: 9799
                            length: 21
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 9824
                            length: 4
                        children: []
                        pos: 9799
                        length: 29
                    children: []
                    pos: 9798
                    length: 31
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: |-
                        return (Collection<Object>) _valueInstantiator.createUsingDelegate(ctxt,
                                            _delegateDeserializer.deserialize(p, ctxt));
                    children: []
                    pos: 9844
                    length: 137
                  pos: 9830
                  length: 161
                pos: 9795
                length: 196
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: p.hasToken(JsonToken.VALUE_STRING)
                        children: []
                        pos: 10220
                        length: 34
                    children: []
                    pos: 10219
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String str = p.getText();
                    children: []
                    pos: 10270
                    length: 25
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: equals
                            fields:
                              left:
                                type: method_invocation
                                fields:
                                  text: str.length()
                                children: []
                                pos: 10312
                                length: 12
                              right:
                                type: decimal_integer_literal
                                fields:
                                  text: '0'
                                children: []
                                pos: 10328
                                length: 1
                            children: []
                            pos: 10312
                            length: 17
                        children: []
                        pos: 10311
                        length: 19
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: return_statement
                        fields:
                          text: return (Collection<Object>) _valueInstantiator.createFromString(ctxt,
                            str);
                        children: []
                        pos: 10349
                        length: 75
                      pos: 10331
                      length: 107
                    pos: 10308
                    length: 130
                  pos: 10256
                  length: 192
                pos: 10216
                length: 232
              - type: return_statement
                fields:
                  text: return deserialize(p, ctxt, (Collection<Object>) _valueInstantiator.createUsingDefault(ctxt));
                children: []
                pos: 10457
                length: 94
              pos: 9785
              length: 772
          children: []
          pos: 9624
          length: 933
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: deserialize
              children: []
              pos: 10603
              length: 11
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 10615
                length: 12
              pos: 10563
              length: 2301
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!p.isExpectedStartArrayToken()"
                        children: []
                        pos: 10799
                        length: 30
                    children: []
                    pos: 10798
                    length: 32
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return handleNonArray(p, ctxt, result);
                    children: []
                    pos: 10845
                    length: 39
                  pos: 10831
                  length: 63
                pos: 10795
                length: 99
              - type: expression_statement
                fields:
                  text: p.setCurrentValue(result);
                children: []
                pos: 10991
                length: 26
              - type: local_variable_declaration
                fields:
                  text: JsonDeserializer<Object> valueDes = _valueDeserializer;
                children: []
                pos: 11027
                length: 55
              - type: local_variable_declaration
                fields:
                  text: final TypeDeserializer typeDeser = _valueTypeDeserializer;
                children: []
                pos: 11091
                length: 58
              - type: local_variable_declaration
                fields:
                  text: |-
                    CollectionReferringAccumulator referringAccumulator =
                                (valueDes.getObjectIdReader() == null) ? null :
                                    new CollectionReferringAccumulator(_collectionType.getContentType().getRawClass(), result);
                children: []
                pos: 11158
                length: 221
              - type: local_variable_declaration
                fields:
                  text: JsonToken t;
                children: []
                pos: 11389
                length: 12
              - type: while_statement
                fields:
                  text: |-
                    while ((t = p.nextToken()) != JsonToken.END_ARRAY) {
                                try {
                                    Object value;
                                    if (t == JsonToken.VALUE_NULL) {
                                        value = valueDes.getNullValue(ctxt);
                                    } else if (typeDeser == null) {
                                        value = valueDes.deserialize(p, ctxt);
                                    } else {
                                        value = valueDes.deserializeWithType(p, ctxt, typeDeser);
                                    }
                                    if (referringAccumulator != null) {
                                        referringAccumulator.add(value);
                                    } else {
                                        result.add(value);
                                    }
                                } catch (UnresolvedForwardReference reference) {
                                    if (referringAccumulator == null) {
                                        throw JsonMappingException
                                                .from(p, "Unresolved forward reference but no identity info", reference);
                                    }
                                    Referring ref = referringAccumulator.handleUnresolvedReference(reference);
                                    reference.getRoid().appendReferring(ref);
                                } catch (Exception e) {
                                    boolean wrap = (ctxt == null) || ctxt.isEnabled(DeserializationFeature.WRAP_EXCEPTIONS);
                                    if (!wrap && e instanceof RuntimeException) {
                                        throw (RuntimeException)e;
                                    }
                                    throw JsonMappingException.wrapWithPath(e, result, result.size());
                                }
                            }
                children: []
                pos: 11410
                length: 1425
              - type: return_statement
                fields:
                  text: return result;
                children: []
                pos: 12844
                length: 14
              pos: 10728
              length: 2136
          children: []
          pos: 10563
          length: 2301
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: deserializeWithType
              children: []
              pos: 12898
              length: 19
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser jp
                children: []
                pos: 12918
                length: 13
              pos: 12870
              length: 327
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return typeDeserializer.deserializeTypedFromArray(jp, ctxt);
                children: []
                pos: 13131
                length: 60
              pos: 13040
              length: 157
          children: []
          pos: 12870
          length: 327
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: handleNonArray
              children: []
              pos: 13449
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 13464
                length: 12
              pos: 13414
              length: 1316
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: |-
                    boolean canWrap = (_unwrapSingle == Boolean.TRUE) ||
                                    ((_unwrapSingle == null) &&
                                            ctxt.isEnabled(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY));
                children: []
                pos: 13634
                length: 190
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!canWrap"
                        children: []
                        pos: 13837
                        length: 8
                    children: []
                    pos: 13836
                    length: 10
                children:
                - type: block
                  fields: {}
                  children:
                  - type: throw_statement
                    fields:
                      text: throw ctxt.mappingException(_collectionType.getRawClass());
                    children: []
                    pos: 13861
                    length: 59
                  pos: 13847
                  length: 83
                pos: 13833
                length: 97
              - type: local_variable_declaration
                fields:
                  text: JsonDeserializer<Object> valueDes = _valueDeserializer;
                children: []
                pos: 13939
                length: 55
              - type: local_variable_declaration
                fields:
                  text: final TypeDeserializer typeDeser = _valueTypeDeserializer;
                children: []
                pos: 14003
                length: 58
              - type: local_variable_declaration
                fields:
                  text: JsonToken t = p.getCurrentToken();
                children: []
                pos: 14070
                length: 34
              - type: local_variable_declaration
                fields:
                  text: Object value;
                children: []
                pos: 14114
                length: 13
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: equals
                              fields:
                                left:
                                  type: identifier
                                  fields:
                                    text: t
                                  children: []
                                  pos: 14159
                                  length: 1
                                right:
                                  type: field_access
                                  fields:
                                    text: JsonToken.VALUE_NULL
                                  children: []
                                  pos: 14164
                                  length: 20
                              children: []
                              pos: 14159
                              length: 25
                          children: []
                          pos: 14158
                          length: 27
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: value = valueDes.getNullValue(ctxt);
                          children: []
                          pos: 14204
                          length: 36
                        pos: 14186
                        length: 68
                      pos: 14155
                      length: 293
                    pos: 14141
                    length: 317
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (Exception e) {
                                      // note: pass Object.class, not Object[].class, as we need element type for error info
                                      throw JsonMappingException.wrapWithPath(e, Object.class, result.size());
                                  }
                      children: []
                      pos: 14459
                      length: 215
                    pos: 14137
                    length: 537
                children: []
                pos: 14137
                length: 537
              - type: expression_statement
                fields:
                  text: result.add(value);
                children: []
                pos: 14683
                length: 18
              - type: return_statement
                fields:
                  text: return result;
                children: []
                pos: 14710
                length: 14
              pos: 13577
              length: 1153
          children: []
          pos: 13414
          length: 1316
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: CollectionReferringAccumulator
              children: []
              pos: 14762
              length: 30
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final Class<?> _elementType;
                children: []
                pos: 14803
                length: 36
              - type: field_declaration
                fields:
                  text: private final Collection<Object> _result;
                children: []
                pos: 14848
                length: 41
              - type: field_declaration
                fields:
                  text: private List<CollectionReferring> _accumulator = new ArrayList<CollectionReferring>();
                children: []
                pos: 14994
                length: 86
              - type: constructor_declaration
                fields:
                  text: |-
                    public CollectionReferringAccumulator(Class<?> elementType, Collection<Object> result) {
                                _elementType = elementType;
                                _result = result;
                            }
                children: []
                pos: 15090
                length: 168
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: add
                    children: []
                    pos: 15280
                    length: 3
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Object value
                      children: []
                      pos: 15284
                      length: 12
                    pos: 15268
                    length: 284
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: _accumulator.isEmpty()
                              children: []
                              pos: 15324
                              length: 22
                          children: []
                          pos: 15323
                          length: 24
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: _result.add(value);
                          children: []
                          pos: 15366
                          length: 19
                        pos: 15348
                        length: 51
                      pos: 15320
                      length: 222
                    pos: 15306
                    length: 246
                children: []
                pos: 15268
                length: 284
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: handleUnresolvedReference
                    children: []
                    pos: 15579
                    length: 25
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: UnresolvedForwardReference reference
                      children: []
                      pos: 15605
                      length: 36
                    pos: 15562
                    length: 250
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: CollectionReferring id = new CollectionReferring(this,
                          reference, _elementType);
                      children: []
                      pos: 15665
                      length: 80
                    - type: expression_statement
                      fields:
                        text: _accumulator.add(id);
                      children: []
                      pos: 15758
                      length: 21
                    - type: return_statement
                      fields:
                        text: return id;
                      children: []
                      pos: 15792
                      length: 10
                    pos: 15651
                    length: 161
                children: []
                pos: 15562
                length: 250
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: resolveForwardReference
                    children: []
                    pos: 15834
                    length: 23
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Object id
                      children: []
                      pos: 15858
                      length: 9
                    pos: 15822
                    length: 1014
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: Iterator<CollectionReferring> iterator = _accumulator.iterator();
                      children: []
                      pos: 15924
                      length: 65
                    - type: local_variable_declaration
                      fields:
                        text: Collection<Object> previous = _result;
                      children: []
                      pos: 16253
                      length: 38
                    - type: while_statement
                      fields:
                        text: |-
                          while (iterator.hasNext()) {
                                          CollectionReferring ref = iterator.next();
                                          if (ref.hasId(id)) {
                                              iterator.remove();
                                              previous.add(value);
                                              previous.addAll(ref.next);
                                              return;
                                          }
                                          previous = ref.next;
                                      }
                      children: []
                      pos: 16304
                      length: 348
                    - type: throw_statement
                      fields:
                        text: |-
                          throw new IllegalArgumentException("Trying to resolve a forward reference with id [" + id
                                              + "] that wasn't previously seen as unresolved.");
                      children: []
                      pos: 16666
                      length: 160
                    pos: 15910
                    length: 926
                children: []
                pos: 15822
                length: 1014
              pos: 14736
              length: 2106
          children: []
          pos: 14736
          length: 2106
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: CollectionReferring
              children: []
              pos: 17055
              length: 19
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final CollectionReferringAccumulator _parent;
                children: []
                pos: 17103
                length: 53
              - type: field_declaration
                fields:
                  text: public final List<Object> next = new ArrayList<Object>();
                children: []
                pos: 17165
                length: 57
              - type: constructor_declaration
                fields:
                  text: |-
                    CollectionReferring(CollectionReferringAccumulator parent,
                                    UnresolvedForwardReference reference, Class<?> contentType)
                            {
                                super(reference, contentType);
                                _parent = parent;
                            }
                children: []
                pos: 17240
                length: 227
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: handleResolvedForwardReference
                    children: []
                    pos: 17515
                    length: 30
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Object id
                      children: []
                      pos: 17546
                      length: 9
                    pos: 17485
                    length: 172
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: _parent.resolveForwardReference(id, value);
                      children: []
                      pos: 17604
                      length: 43
                    pos: 17590
                    length: 67
                children: []
                pos: 17485
                length: 172
              pos: 17028
              length: 635
          children: []
          pos: 17028
          length: 635
        pos: 1136
        length: 16529
    children: []
    pos: 1136
    length: 16529
  pos: 0
  length: 17666
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: CollectionDeserializer
        children: []
        pos: 1165
        length: 22
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: private static final long serialVersionUID = -1L;
          children: []
          pos: 1290
          length: 49
        - type: field_declaration
          fields:
            text: protected final JavaType _collectionType;
          children: []
          pos: 1383
          length: 41
        - type: field_declaration
          fields:
            text: protected final JsonDeserializer<Object> _valueDeserializer;
          children: []
          pos: 1477
          length: 60
        - type: field_declaration
          fields:
            text: protected final TypeDeserializer _valueTypeDeserializer;
          children: []
          pos: 1678
          length: 56
        - type: field_declaration
          fields:
            text: protected final ValueInstantiator _valueInstantiator;
          children: []
          pos: 1783
          length: 53
        - type: field_declaration
          fields:
            text: protected final JsonDeserializer<Object> _delegateDeserializer;
          children: []
          pos: 1975
          length: 63
        - type: field_declaration
          fields:
            text: protected final Boolean _unwrapSingle;
          children: []
          pos: 2313
          length: 38
        - type: constructor_declaration
          fields:
            text: |-
              public CollectionDeserializer(JavaType collectionType,
                          JsonDeserializer<Object> valueDeser,
                          TypeDeserializer valueTypeDeser, ValueInstantiator valueInstantiator)
                  {
                      this(collectionType, valueDeser, valueTypeDeser, valueInstantiator, null, null);
                  }
          children: []
          pos: 2730
          length: 286
        - type: constructor_declaration
          fields:
            text: |-
              protected CollectionDeserializer(JavaType collectionType,
                          JsonDeserializer<Object> valueDeser, TypeDeserializer valueTypeDeser,
                          ValueInstantiator valueInstantiator,
                          JsonDeserializer<Object> delegateDeser,
                          Boolean unwrapSingle)
                  {
                      super(collectionType);
                      _collectionType = collectionType;
                      _valueDeserializer = valueDeser;
                      _valueTypeDeserializer = valueTypeDeser;
                      _valueInstantiator = valueInstantiator;
                      _delegateDeserializer = delegateDeser;
                      _unwrapSingle = unwrapSingle;
                  }
          children: []
          pos: 3102
          length: 582
        - type: constructor_declaration
          fields:
            text: |-
              protected CollectionDeserializer(CollectionDeserializer src)
                  {
                      super(src._collectionType);
                      _collectionType = src._collectionType;
                      _valueDeserializer = src._valueDeserializer;
                      _valueTypeDeserializer = src._valueTypeDeserializer;
                      _valueInstantiator = src._valueInstantiator;
                      _delegateDeserializer = src._delegateDeserializer;
                      _unwrapSingle = src._unwrapSingle;
                  }
          children: []
          pos: 3845
          length: 424
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: withResolved
              children: []
              pos: 4452
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonDeserializer<?> dd
                children: []
                pos: 4465
                length: 22
              pos: 4384
              length: 597
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: and
                        fields:
                          left:
                            type: and
                            fields:
                              left:
                                type: and
                                fields:
                                  left:
                                    type: parenthesized_expression
                                    fields:
                                      expression:
                                        type: equals
                                        fields:
                                          left:
                                            type: identifier
                                            fields:
                                              text: dd
                                            children: []
                                            pos: 4600
                                            length: 2
                                          right:
                                            type: identifier
                                            fields:
                                              text: _delegateDeserializer
                                            children: []
                                            pos: 4606
                                            length: 21
                                        children: []
                                        pos: 4600
                                        length: 27
                                    children: []
                                    pos: 4599
                                    length: 29
                                  right:
                                    type: parenthesized_expression
                                    fields:
                                      expression:
                                        type: equals
                                        fields:
                                          left:
                                            type: identifier
                                            fields:
                                              text: vd
                                            children: []
                                            pos: 4633
                                            length: 2
                                          right:
                                            type: identifier
                                            fields:
                                              text: _valueDeserializer
                                            children: []
                                            pos: 4639
                                            length: 18
                                        children: []
                                        pos: 4633
                                        length: 24
                                    children: []
                                    pos: 4632
                                    length: 26
                                children: []
                                pos: 4599
                                length: 59
                              right:
                                type: parenthesized_expression
                                fields:
                                  expression:
                                    type: equals
                                    fields:
                                      left:
                                        type: identifier
                                        fields:
                                          text: vtd
                                        children: []
                                        pos: 4663
                                        length: 3
                                      right:
                                        type: identifier
                                        fields:
                                          text: _valueTypeDeserializer
                                        children: []
                                        pos: 4670
                                        length: 22
                                    children: []
                                    pos: 4663
                                    length: 29
                                children: []
                                pos: 4662
                                length: 31
                            children: []
                            pos: 4599
                            length: 94
                          right:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: equals
                                fields:
                                  left:
                                    type: identifier
                                    fields:
                                      text: _unwrapSingle
                                    children: []
                                    pos: 4714
                                    length: 13
                                  right:
                                    type: identifier
                                    fields:
                                      text: unwrapSingle
                                    children: []
                                    pos: 4731
                                    length: 12
                                children: []
                                pos: 4714
                                length: 29
                            children: []
                            pos: 4713
                            length: 31
                        children: []
                        pos: 4599
                        length: 145
                    children: []
                    pos: 4598
                    length: 147
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return this;
                    children: []
                    pos: 4760
                    length: 12
                  pos: 4746
                  length: 36
                pos: 4595
                length: 187
              - type: return_statement
                fields:
                  text: |-
                    return new CollectionDeserializer(_collectionType,
                                    (JsonDeserializer<Object>) vd, vtd,
                                    _valueInstantiator, (JsonDeserializer<Object>) dd, unwrapSingle);
                children: []
                pos: 4791
                length: 184
              pos: 4585
              length: 396
          children: []
          pos: 4384
          length: 597
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: withResolved
              children: []
              pos: 5171
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonDeserializer<?> dd
                children: []
                pos: 5184
                length: 22
              pos: 5067
              length: 267
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return withResolved(dd, vd, vtd, _unwrapSingle);
                children: []
                pos: 5280
                length: 48
              pos: 5270
              length: 64
          children: []
          pos: 5067
          length: 267
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: isCachable
              children: []
              pos: 5435
              length: 10
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5393
              length: 299
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: |-
                    return (_valueDeserializer == null)
                                    && (_valueTypeDeserializer == null)
                                    && (_delegateDeserializer == null)
                                    ;
                children: []
                pos: 5530
                length: 156
              pos: 5448
              length: 244
          children: []
          pos: 5393
          length: 299
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: createContextual
              children: []
              pos: 6101
              length: 16
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: DeserializationContext ctxt
                children: []
                pos: 6118
                length: 27
              pos: 6057
              length: 2318
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: JsonDeserializer<Object> delegateDeser = null;
                children: []
                pos: 6290
                length: 46
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _valueInstantiator
                            children: []
                            pos: 6349
                            length: 18
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 6371
                            length: 4
                        children: []
                        pos: 6349
                        length: 26
                    children: []
                    pos: 6348
                    length: 28
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: _valueInstantiator.canCreateUsingDelegate()
                            children: []
                            pos: 6395
                            length: 43
                        children: []
                        pos: 6394
                        length: 45
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: local_variable_declaration
                        fields:
                          text: JavaType delegateType = _valueInstantiator.getDelegateType(ctxt.getConfig());
                        children: []
                        pos: 6458
                        length: 77
                      - type: if_statement
                        fields:
                          condition:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: equals
                                fields:
                                  left:
                                    type: identifier
                                    fields:
                                      text: delegateType
                                    children: []
                                    pos: 6556
                                    length: 12
                                  right:
                                    type: null_literal
                                    fields: {}
                                    children: []
                                    pos: 6572
                                    length: 4
                                children: []
                                pos: 6556
                                length: 20
                            children: []
                            pos: 6555
                            length: 22
                        children:
                        - type: block
                          fields: {}
                          children:
                          - type: throw_statement
                            fields:
                              text: |-
                                throw new IllegalArgumentException("Invalid delegate-creator definition for "+_collectionType
                                                            +": value instantiator ("+_valueInstantiator.getClass().getName()
                                                            +") returned true for 'canCreateUsingDelegate()', but null for 'getDelegateType()'");
                            children: []
                            pos: 6600
                            length: 301
                          pos: 6578
                          length: 341
                        pos: 6552
                        length: 367
                      - type: expression_statement
                        fields:
                          text: delegateDeser = findDeserializer(ctxt, delegateType,
                            property);
                        children: []
                        pos: 6936
                        length: 63
                      pos: 6440
                      length: 573
                    pos: 6391
                    length: 622
                  pos: 6377
                  length: 646
                pos: 6345
                length: 678
              - type: local_variable_declaration
                fields:
                  text: |-
                    Boolean unwrapSingle = findFormatFeature(ctxt, property, Collection.class,
                                    JsonFormat.Feature.ACCEPT_SINGLE_VALUE_AS_ARRAY);
                children: []
                pos: 7296
                length: 140
              - type: local_variable_declaration
                fields:
                  text: JsonDeserializer<?> valueDeser = _valueDeserializer;
                children: []
                pos: 7505
                length: 52
              - type: expression_statement
                fields:
                  text: valueDeser = findConvertingContentDeserializer(ctxt, property,
                    valueDeser);
                children: []
                pos: 7615
                length: 75
              - type: local_variable_declaration
                fields:
                  text: final JavaType vt = _collectionType.getContentType();
                children: []
                pos: 7699
                length: 53
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: valueDeser
                            children: []
                            pos: 7765
                            length: 10
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 7779
                            length: 4
                        children: []
                        pos: 7765
                        length: 18
                    children: []
                    pos: 7764
                    length: 20
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: valueDeser = ctxt.findContextualValueDeserializer(vt,
                        property);
                    children: []
                    pos: 7799
                    length: 64
                  pos: 7785
                  length: 88
                pos: 7761
                length: 277
              - type: local_variable_declaration
                fields:
                  text: TypeDeserializer valueTypeDeser = _valueTypeDeserializer;
                children: []
                pos: 8111
                length: 57
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: valueTypeDeser
                            children: []
                            pos: 8181
                            length: 14
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 8199
                            length: 4
                        children: []
                        pos: 8181
                        length: 22
                    children: []
                    pos: 8180
                    length: 24
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: valueTypeDeser = valueTypeDeser.forProperty(property);
                    children: []
                    pos: 8219
                    length: 54
                  pos: 8205
                  length: 78
                pos: 8177
                length: 106
              - type: return_statement
                fields:
                  text: return withResolved(delegateDeser, valueDeser, valueTypeDeser,
                    unwrapSingle);
                children: []
                pos: 8292
                length: 77
              pos: 6214
              length: 2161
          children: []
          pos: 6057
          length: 2318
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getContentType
              children: []
              pos: 8592
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 8562
              length: 103
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _collectionType.getContentType();
                children: []
                pos: 8619
                length: 40
              pos: 8609
              length: 56
          children: []
          pos: 8562
          length: 103
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getContentDeserializer
              children: []
              pos: 8717
              length: 22
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 8671
              length: 113
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return _valueDeserializer;
                children: []
                pos: 8752
                length: 26
              pos: 8742
              length: 42
          children: []
          pos: 8671
          length: 113
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: deserialize
              children: []
              pos: 9045
              length: 11
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 9057
                length: 12
              pos: 8970
              length: 933
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: not_equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: _delegateDeserializer
                            children: []
                            pos: 9145
                            length: 21
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 9170
                            length: 4
                        children: []
                        pos: 9145
                        length: 29
                    children: []
                    pos: 9144
                    length: 31
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: |-
                        return (Collection<Object>) _valueInstantiator.createUsingDelegate(ctxt,
                                            _delegateDeserializer.deserialize(p, ctxt));
                    children: []
                    pos: 9190
                    length: 137
                  pos: 9176
                  length: 161
                pos: 9141
                length: 196
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: p.hasToken(JsonToken.VALUE_STRING)
                        children: []
                        pos: 9566
                        length: 34
                    children: []
                    pos: 9565
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String str = p.getText();
                    children: []
                    pos: 9616
                    length: 25
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: equals
                            fields:
                              left:
                                type: method_invocation
                                fields:
                                  text: str.length()
                                children: []
                                pos: 9658
                                length: 12
                              right:
                                type: decimal_integer_literal
                                fields:
                                  text: '0'
                                children: []
                                pos: 9674
                                length: 1
                            children: []
                            pos: 9658
                            length: 17
                        children: []
                        pos: 9657
                        length: 19
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: return_statement
                        fields:
                          text: return (Collection<Object>) _valueInstantiator.createFromString(ctxt,
                            str);
                        children: []
                        pos: 9695
                        length: 75
                      pos: 9677
                      length: 107
                    pos: 9654
                    length: 130
                  pos: 9602
                  length: 192
                pos: 9562
                length: 232
              - type: return_statement
                fields:
                  text: return deserialize(p, ctxt, (Collection<Object>) _valueInstantiator.createUsingDefault(ctxt));
                children: []
                pos: 9803
                length: 94
              pos: 9131
              length: 772
          children: []
          pos: 8970
          length: 933
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: deserialize
              children: []
              pos: 9949
              length: 11
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 9961
                length: 12
              pos: 9909
              length: 2301
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!p.isExpectedStartArrayToken()"
                        children: []
                        pos: 10145
                        length: 30
                    children: []
                    pos: 10144
                    length: 32
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return handleNonArray(p, ctxt, result);
                    children: []
                    pos: 10191
                    length: 39
                  pos: 10177
                  length: 63
                pos: 10141
                length: 99
              - type: expression_statement
                fields:
                  text: p.setCurrentValue(result);
                children: []
                pos: 10337
                length: 26
              - type: local_variable_declaration
                fields:
                  text: JsonDeserializer<Object> valueDes = _valueDeserializer;
                children: []
                pos: 10373
                length: 55
              - type: local_variable_declaration
                fields:
                  text: final TypeDeserializer typeDeser = _valueTypeDeserializer;
                children: []
                pos: 10437
                length: 58
              - type: local_variable_declaration
                fields:
                  text: |-
                    CollectionReferringAccumulator referringAccumulator =
                                (valueDes.getObjectIdReader() == null) ? null :
                                    new CollectionReferringAccumulator(_collectionType.getContentType().getRawClass(), result);
                children: []
                pos: 10504
                length: 221
              - type: local_variable_declaration
                fields:
                  text: JsonToken t;
                children: []
                pos: 10735
                length: 12
              - type: while_statement
                fields:
                  text: |-
                    while ((t = p.nextToken()) != JsonToken.END_ARRAY) {
                                try {
                                    Object value;
                                    if (t == JsonToken.VALUE_NULL) {
                                        value = valueDes.getNullValue(ctxt);
                                    } else if (typeDeser == null) {
                                        value = valueDes.deserialize(p, ctxt);
                                    } else {
                                        value = valueDes.deserializeWithType(p, ctxt, typeDeser);
                                    }
                                    if (referringAccumulator != null) {
                                        referringAccumulator.add(value);
                                    } else {
                                        result.add(value);
                                    }
                                } catch (UnresolvedForwardReference reference) {
                                    if (referringAccumulator == null) {
                                        throw JsonMappingException
                                                .from(p, "Unresolved forward reference but no identity info", reference);
                                    }
                                    Referring ref = referringAccumulator.handleUnresolvedReference(reference);
                                    reference.getRoid().appendReferring(ref);
                                } catch (Exception e) {
                                    boolean wrap = (ctxt == null) || ctxt.isEnabled(DeserializationFeature.WRAP_EXCEPTIONS);
                                    if (!wrap && e instanceof RuntimeException) {
                                        throw (RuntimeException)e;
                                    }
                                    throw JsonMappingException.wrapWithPath(e, result, result.size());
                                }
                            }
                children: []
                pos: 10756
                length: 1425
              - type: return_statement
                fields:
                  text: return result;
                children: []
                pos: 12190
                length: 14
              pos: 10074
              length: 2136
          children: []
          pos: 9909
          length: 2301
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: deserializeWithType
              children: []
              pos: 12244
              length: 19
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser jp
                children: []
                pos: 12264
                length: 13
              pos: 12216
              length: 327
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return typeDeserializer.deserializeTypedFromArray(jp, ctxt);
                children: []
                pos: 12477
                length: 60
              pos: 12386
              length: 157
          children: []
          pos: 12216
          length: 327
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: handleNonArray
              children: []
              pos: 12795
              length: 14
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: JsonParser p
                children: []
                pos: 12810
                length: 12
              pos: 12760
              length: 1316
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: |-
                    boolean canWrap = (_unwrapSingle == Boolean.TRUE) ||
                                    ((_unwrapSingle == null) &&
                                            ctxt.isEnabled(DeserializationFeature.ACCEPT_SINGLE_VALUE_AS_ARRAY));
                children: []
                pos: 12980
                length: 190
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!canWrap"
                        children: []
                        pos: 13183
                        length: 8
                    children: []
                    pos: 13182
                    length: 10
                children:
                - type: block
                  fields: {}
                  children:
                  - type: throw_statement
                    fields:
                      text: throw ctxt.mappingException(_collectionType.getRawClass());
                    children: []
                    pos: 13207
                    length: 59
                  pos: 13193
                  length: 83
                pos: 13179
                length: 97
              - type: local_variable_declaration
                fields:
                  text: JsonDeserializer<Object> valueDes = _valueDeserializer;
                children: []
                pos: 13285
                length: 55
              - type: local_variable_declaration
                fields:
                  text: final TypeDeserializer typeDeser = _valueTypeDeserializer;
                children: []
                pos: 13349
                length: 58
              - type: local_variable_declaration
                fields:
                  text: JsonToken t = p.getCurrentToken();
                children: []
                pos: 13416
                length: 34
              - type: local_variable_declaration
                fields:
                  text: Object value;
                children: []
                pos: 13460
                length: 13
              - type: try_statement
                fields:
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: equals
                              fields:
                                left:
                                  type: identifier
                                  fields:
                                    text: t
                                  children: []
                                  pos: 13505
                                  length: 1
                                right:
                                  type: field_access
                                  fields:
                                    text: JsonToken.VALUE_NULL
                                  children: []
                                  pos: 13510
                                  length: 20
                              children: []
                              pos: 13505
                              length: 25
                          children: []
                          pos: 13504
                          length: 27
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: value = valueDes.getNullValue(ctxt);
                          children: []
                          pos: 13550
                          length: 36
                        pos: 13532
                        length: 68
                      pos: 13501
                      length: 293
                    pos: 13487
                    length: 317
                  excepts:
                    type: excepts
                    fields: {}
                    children:
                    - type: catch_clause
                      fields:
                        text: |-
                          catch (Exception e) {
                                      // note: pass Object.class, not Object[].class, as we need element type for error info
                                      throw JsonMappingException.wrapWithPath(e, Object.class, result.size());
                                  }
                      children: []
                      pos: 13805
                      length: 215
                    pos: 13483
                    length: 537
                children: []
                pos: 13483
                length: 537
              - type: expression_statement
                fields:
                  text: result.add(value);
                children: []
                pos: 14029
                length: 18
              - type: return_statement
                fields:
                  text: return result;
                children: []
                pos: 14056
                length: 14
              pos: 12923
              length: 1153
          children: []
          pos: 12760
          length: 1316
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: CollectionReferringAccumulator
              children: []
              pos: 14108
              length: 30
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final Class<?> _elementType;
                children: []
                pos: 14149
                length: 36
              - type: field_declaration
                fields:
                  text: private final Collection<Object> _result;
                children: []
                pos: 14194
                length: 41
              - type: field_declaration
                fields:
                  text: private List<CollectionReferring> _accumulator = new ArrayList<CollectionReferring>();
                children: []
                pos: 14340
                length: 86
              - type: constructor_declaration
                fields:
                  text: |-
                    public CollectionReferringAccumulator(Class<?> elementType, Collection<Object> result) {
                                _elementType = elementType;
                                _result = result;
                            }
                children: []
                pos: 14436
                length: 168
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: add
                    children: []
                    pos: 14626
                    length: 3
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Object value
                      children: []
                      pos: 14630
                      length: 12
                    pos: 14614
                    length: 284
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: _accumulator.isEmpty()
                              children: []
                              pos: 14670
                              length: 22
                          children: []
                          pos: 14669
                          length: 24
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: _result.add(value);
                          children: []
                          pos: 14712
                          length: 19
                        pos: 14694
                        length: 51
                      pos: 14666
                      length: 222
                    pos: 14652
                    length: 246
                children: []
                pos: 14614
                length: 284
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: handleUnresolvedReference
                    children: []
                    pos: 14925
                    length: 25
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: UnresolvedForwardReference reference
                      children: []
                      pos: 14951
                      length: 36
                    pos: 14908
                    length: 250
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: CollectionReferring id = new CollectionReferring(this,
                          reference, _elementType);
                      children: []
                      pos: 15011
                      length: 80
                    - type: expression_statement
                      fields:
                        text: _accumulator.add(id);
                      children: []
                      pos: 15104
                      length: 21
                    - type: return_statement
                      fields:
                        text: return id;
                      children: []
                      pos: 15138
                      length: 10
                    pos: 14997
                    length: 161
                children: []
                pos: 14908
                length: 250
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: resolveForwardReference
                    children: []
                    pos: 15180
                    length: 23
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Object id
                      children: []
                      pos: 15204
                      length: 9
                    pos: 15168
                    length: 1014
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: Iterator<CollectionReferring> iterator = _accumulator.iterator();
                      children: []
                      pos: 15270
                      length: 65
                    - type: local_variable_declaration
                      fields:
                        text: Collection<Object> previous = _result;
                      children: []
                      pos: 15599
                      length: 38
                    - type: while_statement
                      fields:
                        text: |-
                          while (iterator.hasNext()) {
                                          CollectionReferring ref = iterator.next();
                                          if (ref.hasId(id)) {
                                              iterator.remove();
                                              previous.add(value);
                                              previous.addAll(ref.next);
                                              return;
                                          }
                                          previous = ref.next;
                                      }
                      children: []
                      pos: 15650
                      length: 348
                    - type: throw_statement
                      fields:
                        text: |-
                          throw new IllegalArgumentException("Trying to resolve a forward reference with id [" + id
                                              + "] that wasn't previously seen as unresolved.");
                      children: []
                      pos: 16012
                      length: 160
                    pos: 15256
                    length: 926
                children: []
                pos: 15168
                length: 1014
              pos: 14082
              length: 2106
          children: []
          pos: 14082
          length: 2106
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: CollectionReferring
              children: []
              pos: 16401
              length: 19
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final CollectionReferringAccumulator _parent;
                children: []
                pos: 16449
                length: 53
              - type: field_declaration
                fields:
                  text: public final List<Object> next = new ArrayList<Object>();
                children: []
                pos: 16511
                length: 57
              - type: constructor_declaration
                fields:
                  text: |-
                    CollectionReferring(CollectionReferringAccumulator parent,
                                    UnresolvedForwardReference reference, Class<?> contentType)
                            {
                                super(reference, contentType);
                                _parent = parent;
                            }
                children: []
                pos: 16586
                length: 227
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: handleResolvedForwardReference
                    children: []
                    pos: 16861
                    length: 30
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Object id
                      children: []
                      pos: 16892
                      length: 9
                    pos: 16831
                    length: 172
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: _parent.resolveForwardReference(id, value);
                      children: []
                      pos: 16950
                      length: 43
                    pos: 16936
                    length: 67
                children: []
                pos: 16831
                length: 172
              pos: 16374
              length: 635
          children: []
          pos: 16374
          length: 635
        pos: 1136
        length: 15875
    children: []
    pos: 1136
    length: 15875
  pos: 0
  length: 17012
text_diff: |
  --- before
  +++ after
  @@ -181,14 +181,6 @@
                               +") returned true for 'canCreateUsingDelegate()', but null for 'getDelegateType()'");
                   }
                   delegateDeser = findDeserializer(ctxt, delegateType, property);
  -            } else if (_valueInstantiator.canCreateUsingArrayDelegate()) {
  -                JavaType delegateType = _valueInstantiator.getArrayDelegateType(ctxt.getConfig());
  -                if (delegateType == null) {
  -                    throw new IllegalArgumentException("Invalid array-delegate-creator definition for "+_collectionType
  -                            +": value instantiator ("+_valueInstantiator.getClass().getName()
  -                            +") returned true for 'canCreateUsingArrayDelegate()', but null for 'getArrayDelegateType()'");
  -                }
  -                delegateDeser = findDeserializer(ctxt, delegateType, property);
               }
           }
           // [databind#1043]: allow per-property allow-wrapping of single overrides:
tree_diff: ''
