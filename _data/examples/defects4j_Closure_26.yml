---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: ProcessCommonJSModules
        children: []
        pos: 1453
        length: 22
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: public static final String DEFAULT_FILENAME_PREFIX = "." + File.separator;
          children: []
          pos: 1505
          length: 74
        - type: field_declaration
          fields:
            text: private static final String MODULE_NAME_SEPARATOR = "\\$";
          children: []
          pos: 1583
          length: 58
        - type: field_declaration
          fields:
            text: private static final String MODULE_NAME_PREFIX = "module$";
          children: []
          pos: 1644
          length: 59
        - type: field_declaration
          fields:
            text: private final AbstractCompiler compiler;
          children: []
          pos: 1707
          length: 40
        - type: field_declaration
          fields:
            text: private final String filenamePrefix;
          children: []
          pos: 1750
          length: 36
        - type: field_declaration
          fields:
            text: private final boolean reportDependencies;
          children: []
          pos: 1789
          length: 41
        - type: field_declaration
          fields:
            text: private JSModule module;
          children: []
          pos: 1833
          length: 24
        - type: constructor_declaration
          fields:
            text: |-
              ProcessCommonJSModules(AbstractCompiler compiler, String filenamePrefix) {
                  this(compiler, filenamePrefix, true);
                }
          children: []
          pos: 1861
          length: 120
        - type: constructor_declaration
          fields:
            text: |-
              ProcessCommonJSModules(AbstractCompiler compiler, String filenamePrefix,
                    boolean reportDependencies) {
                  this.compiler = compiler;
                  this.filenamePrefix = filenamePrefix.endsWith(File.separator) ?
                      filenamePrefix : filenamePrefix + File.separator;
                  this.reportDependencies = reportDependencies;
                }
          children: []
          pos: 1985
          length: 318
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: process
              children: []
              pos: 2331
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node externs
                children: []
                pos: 2339
                length: 12
              pos: 2307
              length: 153
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: |-
                    NodeTraversal
                            .traverse(compiler, root, new ProcessCommonJsModulesCallback());
                children: []
                pos: 2370
                length: 86
              pos: 2364
              length: 96
          children: []
          pos: 2307
          length: 153
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: guessCJSModuleName
              children: []
              pos: 2471
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String filename
                children: []
                pos: 2490
                length: 15
              pos: 2464
              length: 104
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return toModuleName(normalizeSourceName(filename));
                children: []
                pos: 2513
                length: 51
              pos: 2507
              length: 61
          children: []
          pos: 2464
          length: 104
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getModule
              children: []
              pos: 2687
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 2678
              length: 45
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return module;
                children: []
                pos: 2705
                length: 14
              pos: 2699
              length: 24
          children: []
          pos: 2678
          length: 45
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: toModuleName
              children: []
              pos: 2984
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String filename
                children: []
                pos: 2997
                length: 15
              pos: 2963
              length: 298
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: |-
                    return MODULE_NAME_PREFIX +
                            filename.replaceAll("^\\." + Pattern.quote(File.separator), "")
                                .replaceAll(Pattern.quote(File.separator), MODULE_NAME_SEPARATOR)
                                .replaceAll("\\.js$", "").replaceAll("-", "_");
                children: []
                pos: 3020
                length: 237
              pos: 3014
              length: 247
          children: []
          pos: 2963
          length: 298
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: toModuleName
              children: []
              pos: 3421
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String requiredFilename
                children: []
                pos: 3434
                length: 23
              pos: 3400
              length: 609
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: requiredFilename = requiredFilename.replaceAll("\\.js$", "");
                children: []
                pos: 3495
                length: 61
              - type: expression_statement
                fields:
                  text: currentFilename = currentFilename.replaceAll("\\.js$", "");
                children: []
                pos: 3561
                length: 59
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: requiredFilename.startsWith("." + File.separator)
                            children: []
                            pos: 3630
                            length: 49
                          right:
                            type: method_invocation
                            fields:
                              text: requiredFilename.startsWith(".." + File.separator)
                            children: []
                            pos: 3691
                            length: 50
                        children: []
                        pos: 3630
                        length: 111
                    children: []
                    pos: 3629
                    length: 113
                children:
                - type: block
                  fields: {}
                  children:
                  - type: try_statement
                    fields:
                      body:
                        type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: |-
                              requiredFilename = (new URI(currentFilename)).resolve(new URI(requiredFilename))
                                          .toString();
                          children: []
                          pos: 3765
                          length: 105
                        pos: 3755
                        length: 123
                      excepts:
                        type: excepts
                        fields: {}
                        children:
                        - type: catch_clause
                          fields:
                            text: |-
                              catch (URISyntaxException e) {
                                      throw new RuntimeException(e);
                                    }
                          children: []
                          pos: 3879
                          length: 77
                        pos: 3751
                        length: 205
                    children: []
                    pos: 3751
                    length: 205
                  pos: 3743
                  length: 219
                pos: 3626
                length: 336
              - type: return_statement
                fields:
                  text: return toModuleName(requiredFilename);
                children: []
                pos: 3967
                length: 38
              pos: 3489
              length: 520
          children: []
          pos: 3400
          length: 609
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: normalizeSourceName
              children: []
              pos: 4028
              length: 19
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String filename
                children: []
                pos: 4048
                length: 15
              pos: 4013
              length: 195
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: filename.indexOf(filenamePrefix)
                            children: []
                            pos: 4075
                            length: 32
                          right:
                            type: decimal_integer_literal
                            fields:
                              text: '0'
                            children: []
                            pos: 4111
                            length: 1
                        children: []
                        pos: 4075
                        length: 37
                    children: []
                    pos: 4074
                    length: 39
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: filename = filename.substring(filenamePrefix.length());
                    children: []
                    pos: 4122
                    length: 55
                  pos: 4114
                  length: 69
                pos: 4071
                length: 112
              - type: return_statement
                fields:
                  text: return filename;
                children: []
                pos: 4188
                length: 16
              pos: 4065
              length: 143
          children: []
          pos: 4013
          length: 195
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: ProcessCommonJsModulesCallback
              children: []
              pos: 4314
              length: 30
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private int scriptNodeCount = 0;
                children: []
                pos: 4392
                length: 32
              - type: field_declaration
                fields:
                  text: private Set<String> modulesWithExports = Sets.newHashSet();
                children: []
                pos: 4429
                length: 59
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visit
                    children: []
                    pos: 4520
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 4526
                      length: 15
                    pos: 4494
                    length: 503
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: and
                              fields:
                                left:
                                  type: and
                                  fields:
                                    left:
                                      type: and
                                      fields:
                                        left:
                                          type: method_invocation
                                          fields:
                                            text: n.isCall()
                                          children: []
                                          pos: 4576
                                          length: 10
                                        right:
                                          type: equals
                                          fields:
                                            left:
                                              type: method_invocation
                                              fields:
                                                text: n.getChildCount()
                                              children: []
                                              pos: 4590
                                              length: 17
                                            right:
                                              type: decimal_integer_literal
                                              fields:
                                                text: '2'
                                              children: []
                                              pos: 4611
                                              length: 1
                                          children: []
                                          pos: 4590
                                          length: 22
                                      children: []
                                      pos: 4576
                                      length: 36
                                    right:
                                      type: method_invocation
                                      fields:
                                        text: '"require".equals(n.getFirstChild().getQualifiedName())'
                                      children: []
                                      pos: 4626
                                      length: 54
                                  children: []
                                  pos: 4576
                                  length: 104
                                right:
                                  type: method_invocation
                                  fields:
                                    text: n.getChildAtIndex(1).isString()
                                  children: []
                                  pos: 4694
                                  length: 31
                              children: []
                              pos: 4576
                              length: 149
                          children: []
                          pos: 4575
                          length: 151
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: visitRequireCall(t, n, parent);
                          children: []
                          pos: 4737
                          length: 31
                        pos: 4727
                        length: 49
                      pos: 4572
                      length: 204
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: n.isScript()
                              children: []
                              pos: 4788
                              length: 12
                          children: []
                          pos: 4787
                          length: 14
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: scriptNodeCount++;
                          children: []
                          pos: 4812
                          length: 18
                        - type: expression_statement
                          fields:
                            text: visitScript(t, n);
                          children: []
                          pos: 4839
                          length: 18
                        pos: 4802
                        length: 63
                      pos: 4784
                      length: 81
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: and
                              fields:
                                left:
                                  type: method_invocation
                                  fields:
                                    text: n.isGetProp()
                                  children: []
                                  pos: 4877
                                  length: 13
                                right:
                                  type: method_invocation
                                  fields:
                                    text: '"module.exports".equals(n.getQualifiedName())'
                                  children: []
                                  pos: 4904
                                  length: 45
                              children: []
                              pos: 4877
                              length: 72
                          children: []
                          pos: 4876
                          length: 74
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: visitModuleExports(n);
                          children: []
                          pos: 4961
                          length: 22
                        pos: 4951
                        length: 40
                      pos: 4873
                      length: 118
                    pos: 4564
                    length: 433
                children: []
                pos: 4494
                length: 503
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visitRequireCall
                    children: []
                    pos: 5171
                    length: 16
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 5188
                      length: 15
                    pos: 5158
                    length: 711
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: |-
                          String moduleName = toModuleName(require.getChildAtIndex(1).getString(),
                                    normalizeSourceName(t.getSourceName()));
                      children: []
                      pos: 5240
                      length: 123
                    - type: local_variable_declaration
                      fields:
                        text: Node moduleRef = IR.name(moduleName).srcref(require);
                      children: []
                      pos: 5370
                      length: 53
                    - type: expression_statement
                      fields:
                        text: parent.replaceChild(require, moduleRef);
                      children: []
                      pos: 5430
                      length: 40
                    - type: local_variable_declaration
                      fields:
                        text: Node script = getCurrentScriptNode(parent);
                      children: []
                      pos: 5477
                      length: 43
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: identifier
                              fields:
                                text: reportDependencies
                              children: []
                              pos: 5531
                              length: 18
                          children: []
                          pos: 5530
                          length: 20
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: t.getInput().addRequire(moduleName);
                          children: []
                          pos: 5561
                          length: 36
                        pos: 5551
                        length: 54
                      pos: 5527
                      length: 78
                    - type: expression_statement
                      fields:
                        text: |-
                          script.addChildToFront(IR.exprResult(
                                    IR.call(IR.getprop(IR.name("goog"), IR.string("require")),
                                        IR.string(moduleName))).copyInformationFromForTree(require));
                      children: []
                      pos: 5646
                      length: 182
                    - type: expression_statement
                      fields:
                        text: compiler.reportCodeChange();
                      children: []
                      pos: 5835
                      length: 28
                    pos: 5232
                    length: 637
                children: []
                pos: 5158
                length: 711
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visitScript
                    children: []
                    pos: 6009
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 6021
                      length: 15
                    pos: 5996
                    length: 1113
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: |-
                          Preconditions.checkArgument(scriptNodeCount == 1,
                                    "ProcessCommonJSModules supports only one invocation per " +
                                    "CompilerInput / script node");
                      children: []
                      pos: 6059
                      length: 162
                    - type: local_variable_declaration
                      fields:
                        text: |-
                          String moduleName = guessCJSModuleName(normalizeSourceName(script
                                    .getSourceFileName()));
                      children: []
                      pos: 6228
                      length: 99
                    - type: expression_statement
                      fields:
                        text: |-
                          script.addChildToFront(IR.var(IR.name(moduleName), IR.objectlit())
                                    .copyInformationFromForTree(script));
                      children: []
                      pos: 6334
                      length: 114
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: identifier
                              fields:
                                text: reportDependencies
                              children: []
                              pos: 6459
                              length: 18
                          children: []
                          pos: 6458
                          length: 20
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: local_variable_declaration
                          fields:
                            text: CompilerInput ci = t.getInput();
                          children: []
                          pos: 6489
                          length: 32
                        - type: expression_statement
                          fields:
                            text: ci.addProvide(moduleName);
                          children: []
                          pos: 6530
                          length: 26
                        - type: local_variable_declaration
                          fields:
                            text: JSModule m = new JSModule(moduleName);
                          children: []
                          pos: 6565
                          length: 38
                        - type: expression_statement
                          fields:
                            text: m.addAndOverrideModule(ci);
                          children: []
                          pos: 6612
                          length: 27
                        - type: expression_statement
                          fields:
                            text: module = m;
                          children: []
                          pos: 6648
                          length: 11
                        pos: 6479
                        length: 188
                      pos: 6455
                      length: 212
                    - type: expression_statement
                      fields:
                        text: |-
                          script.addChildToFront(IR.exprResult(
                                    IR.call(IR.getprop(IR.name("goog"), IR.string("provide")),
                                        IR.string(moduleName))).copyInformationFromForTree(script));
                      children: []
                      pos: 6674
                      length: 181
                    - type: expression_statement
                      fields:
                        text: emitOptionalModuleExportsOverride(script, moduleName);
                      children: []
                      pos: 6863
                      length: 54
                    - type: expression_statement
                      fields:
                        text: |-
                          NodeTraversal.traverse(compiler, script, new SuffixVarsCallback(
                                    moduleName));
                      children: []
                      pos: 6979
                      length: 88
                    - type: expression_statement
                      fields:
                        text: compiler.reportCodeChange();
                      children: []
                      pos: 7075
                      length: 28
                    pos: 6051
                    length: 1058
                children: []
                pos: 5996
                length: 1113
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: emitOptionalModuleExportsOverride
                    children: []
                    pos: 7276
                    length: 33
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node script
                      children: []
                      pos: 7310
                      length: 11
                    pos: 7263
                    length: 504
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: unary_expression
                              fields:
                                text: "!modulesWithExports.contains(moduleName)"
                              children: []
                              pos: 7362
                              length: 40
                          children: []
                          pos: 7361
                          length: 42
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: return_statement
                          fields:
                            text: return;
                          children: []
                          pos: 7414
                          length: 7
                        pos: 7404
                        length: 25
                      pos: 7358
                      length: 71
                    - type: local_variable_declaration
                      fields:
                        text: |-
                          Node moduleExportsProp = IR.getprop(IR.name(moduleName),
                                    IR.string("module$exports"));
                      children: []
                      pos: 7437
                      length: 96
                    - type: expression_statement
                      fields:
                        text: |-
                          script.addChildToBack(IR.ifNode(
                                    moduleExportsProp,
                                    IR.block(IR.exprResult(IR.assign(IR.name(moduleName),
                                        moduleExportsProp.cloneTree())))).copyInformationFromForTree(
                                    script));
                      children: []
                      pos: 7540
                      length: 221
                    pos: 7350
                    length: 417
                children: []
                pos: 7263
                length: 504
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visitModuleExports
                    children: []
                    pos: 7862
                    length: 18
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node prop
                      children: []
                      pos: 7881
                      length: 9
                    pos: 7849
                    length: 448
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: String moduleName = guessCJSModuleName(prop.getSourceFileName());
                      children: []
                      pos: 7900
                      length: 65
                    - type: local_variable_declaration
                      fields:
                        text: Node module = prop.getChildAtIndex(0);
                      children: []
                      pos: 7972
                      length: 38
                    - type: expression_statement
                      fields:
                        text: module.putProp(Node.ORIGINALNAME_PROP, "module");
                      children: []
                      pos: 8017
                      length: 49
                    - type: expression_statement
                      fields:
                        text: module.setString(moduleName);
                      children: []
                      pos: 8073
                      length: 29
                    - type: local_variable_declaration
                      fields:
                        text: Node exports = prop.getChildAtIndex(1);
                      children: []
                      pos: 8109
                      length: 39
                    - type: expression_statement
                      fields:
                        text: exports.putProp(Node.ORIGINALNAME_PROP, "exports");
                      children: []
                      pos: 8155
                      length: 51
                    - type: expression_statement
                      fields:
                        text: exports.setString("module$exports");
                      children: []
                      pos: 8213
                      length: 36
                    - type: expression_statement
                      fields:
                        text: modulesWithExports.add(moduleName);
                      children: []
                      pos: 8256
                      length: 35
                    pos: 7892
                    length: 405
                children: []
                pos: 7849
                length: 448
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getCurrentScriptNode
                    children: []
                    pos: 8376
                    length: 20
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node n
                      children: []
                      pos: 8397
                      length: 6
                    pos: 8363
                    length: 163
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: while_statement
                      fields:
                        text: |-
                          while (true) {
                                  if (n.isScript()) {
                                    return n;
                                  }
                                  n = n.getParent();
                                }
                      children: []
                      pos: 8413
                      length: 107
                    pos: 8405
                    length: 121
                children: []
                pos: 8363
                length: 163
              pos: 4300
              length: 4230
          children: []
          pos: 4300
          length: 4230
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: SuffixVarsCallback
              children: []
              pos: 8638
              length: 18
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private static final String EXPORTS = "exports";
                children: []
                pos: 8698
                length: 48
              - type: field_declaration
                fields:
                  text: private final String suffix;
                children: []
                pos: 8752
                length: 28
              - type: constructor_declaration
                fields:
                  text: |-
                    SuffixVarsCallback(String suffix) {
                          this.suffix = suffix;
                        }
                children: []
                pos: 8786
                length: 69
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visit
                    children: []
                    pos: 8887
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 8893
                      length: 15
                    pos: 8861
                    length: 569
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: n.isName()
                              children: []
                              pos: 8943
                              length: 10
                          children: []
                          pos: 8942
                          length: 12
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: local_variable_declaration
                          fields:
                            text: String name = n.getString();
                          children: []
                          pos: 8965
                          length: 28
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: method_invocation
                                  fields:
                                    text: suffix.equals(name)
                                  children: []
                                  pos: 9006
                                  length: 19
                              children: []
                              pos: 9005
                              length: 21
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: return_statement
                              fields:
                                text: return;
                              children: []
                              pos: 9039
                              length: 7
                            pos: 9027
                            length: 29
                          pos: 9002
                          length: 54
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: method_invocation
                                  fields:
                                    text: EXPORTS.equals(name)
                                  children: []
                                  pos: 9069
                                  length: 20
                              children: []
                              pos: 9068
                              length: 22
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: expression_statement
                              fields:
                                text: n.setString(suffix);
                              children: []
                              pos: 9103
                              length: 20
                            - type: expression_statement
                              fields:
                                text: n.putProp(Node.ORIGINALNAME_PROP, EXPORTS);
                              children: []
                              pos: 9134
                              length: 43
                            pos: 9091
                            length: 96
                          pos: 9065
                          length: 351
                        pos: 8955
                        length: 469
                      pos: 8939
                      length: 485
                    pos: 8931
                    length: 499
                children: []
                pos: 8861
                length: 569
              pos: 8624
              length: 810
          children: []
          pos: 8624
          length: 810
        pos: 1440
        length: 7996
    children: []
    pos: 1440
    length: 7996
  pos: 0
  length: 9437
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: ProcessCommonJSModules
        children: []
        pos: 1453
        length: 22
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: public static final String DEFAULT_FILENAME_PREFIX = "." + File.separator;
          children: []
          pos: 1505
          length: 74
        - type: field_declaration
          fields:
            text: private static final String MODULE_NAME_SEPARATOR = "\\$";
          children: []
          pos: 1583
          length: 58
        - type: field_declaration
          fields:
            text: private static final String MODULE_NAME_PREFIX = "module$";
          children: []
          pos: 1644
          length: 59
        - type: field_declaration
          fields:
            text: private final AbstractCompiler compiler;
          children: []
          pos: 1707
          length: 40
        - type: field_declaration
          fields:
            text: private final String filenamePrefix;
          children: []
          pos: 1750
          length: 36
        - type: field_declaration
          fields:
            text: private final boolean reportDependencies;
          children: []
          pos: 1789
          length: 41
        - type: field_declaration
          fields:
            text: private JSModule module;
          children: []
          pos: 1833
          length: 24
        - type: constructor_declaration
          fields:
            text: |-
              ProcessCommonJSModules(AbstractCompiler compiler, String filenamePrefix) {
                  this(compiler, filenamePrefix, true);
                }
          children: []
          pos: 1861
          length: 120
        - type: constructor_declaration
          fields:
            text: |-
              ProcessCommonJSModules(AbstractCompiler compiler, String filenamePrefix,
                    boolean reportDependencies) {
                  this.compiler = compiler;
                  this.filenamePrefix = filenamePrefix.endsWith(File.separator) ?
                      filenamePrefix : filenamePrefix + File.separator;
                  this.reportDependencies = reportDependencies;
                }
          children: []
          pos: 1985
          length: 318
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: process
              children: []
              pos: 2331
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node externs
                children: []
                pos: 2339
                length: 12
              pos: 2307
              length: 153
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: |-
                    NodeTraversal
                            .traverse(compiler, root, new ProcessCommonJsModulesCallback());
                children: []
                pos: 2370
                length: 86
              pos: 2364
              length: 96
          children: []
          pos: 2307
          length: 153
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: guessCJSModuleName
              children: []
              pos: 2471
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String filename
                children: []
                pos: 2490
                length: 15
              pos: 2464
              length: 104
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return toModuleName(normalizeSourceName(filename));
                children: []
                pos: 2513
                length: 51
              pos: 2507
              length: 61
          children: []
          pos: 2464
          length: 104
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: getModule
              children: []
              pos: 2687
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 2678
              length: 45
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: return module;
                children: []
                pos: 2705
                length: 14
              pos: 2699
              length: 24
          children: []
          pos: 2678
          length: 45
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: toModuleName
              children: []
              pos: 2984
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String filename
                children: []
                pos: 2997
                length: 15
              pos: 2963
              length: 298
            body:
              type: block
              fields: {}
              children:
              - type: return_statement
                fields:
                  text: |-
                    return MODULE_NAME_PREFIX +
                            filename.replaceAll("^\\." + Pattern.quote(File.separator), "")
                                .replaceAll(Pattern.quote(File.separator), MODULE_NAME_SEPARATOR)
                                .replaceAll("\\.js$", "").replaceAll("-", "_");
                children: []
                pos: 3020
                length: 237
              pos: 3014
              length: 247
          children: []
          pos: 2963
          length: 298
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: toModuleName
              children: []
              pos: 3421
              length: 12
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String requiredFilename
                children: []
                pos: 3434
                length: 23
              pos: 3400
              length: 609
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: requiredFilename = requiredFilename.replaceAll("\\.js$", "");
                children: []
                pos: 3495
                length: 61
              - type: expression_statement
                fields:
                  text: currentFilename = currentFilename.replaceAll("\\.js$", "");
                children: []
                pos: 3561
                length: 59
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: requiredFilename.startsWith("." + File.separator)
                            children: []
                            pos: 3630
                            length: 49
                          right:
                            type: method_invocation
                            fields:
                              text: requiredFilename.startsWith(".." + File.separator)
                            children: []
                            pos: 3691
                            length: 50
                        children: []
                        pos: 3630
                        length: 111
                    children: []
                    pos: 3629
                    length: 113
                children:
                - type: block
                  fields: {}
                  children:
                  - type: try_statement
                    fields:
                      body:
                        type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: |-
                              requiredFilename = (new URI(currentFilename)).resolve(new URI(requiredFilename))
                                          .toString();
                          children: []
                          pos: 3765
                          length: 105
                        pos: 3755
                        length: 123
                      excepts:
                        type: excepts
                        fields: {}
                        children:
                        - type: catch_clause
                          fields:
                            text: |-
                              catch (URISyntaxException e) {
                                      throw new RuntimeException(e);
                                    }
                          children: []
                          pos: 3879
                          length: 77
                        pos: 3751
                        length: 205
                    children: []
                    pos: 3751
                    length: 205
                  pos: 3743
                  length: 219
                pos: 3626
                length: 336
              - type: return_statement
                fields:
                  text: return toModuleName(requiredFilename);
                children: []
                pos: 3967
                length: 38
              pos: 3489
              length: 520
          children: []
          pos: 3400
          length: 609
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: normalizeSourceName
              children: []
              pos: 4028
              length: 19
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: String filename
                children: []
                pos: 4048
                length: 15
              pos: 4013
              length: 195
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: filename.indexOf(filenamePrefix)
                            children: []
                            pos: 4075
                            length: 32
                          right:
                            type: decimal_integer_literal
                            fields:
                              text: '0'
                            children: []
                            pos: 4111
                            length: 1
                        children: []
                        pos: 4075
                        length: 37
                    children: []
                    pos: 4074
                    length: 39
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: filename = filename.substring(filenamePrefix.length());
                    children: []
                    pos: 4122
                    length: 55
                  pos: 4114
                  length: 69
                pos: 4071
                length: 112
              - type: return_statement
                fields:
                  text: return filename;
                children: []
                pos: 4188
                length: 16
              pos: 4065
              length: 143
          children: []
          pos: 4013
          length: 195
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: ProcessCommonJsModulesCallback
              children: []
              pos: 4314
              length: 30
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private int scriptNodeCount = 0;
                children: []
                pos: 4392
                length: 32
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visit
                    children: []
                    pos: 4456
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 4462
                      length: 15
                    pos: 4430
                    length: 503
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: and
                              fields:
                                left:
                                  type: and
                                  fields:
                                    left:
                                      type: and
                                      fields:
                                        left:
                                          type: method_invocation
                                          fields:
                                            text: n.isCall()
                                          children: []
                                          pos: 4512
                                          length: 10
                                        right:
                                          type: equals
                                          fields:
                                            left:
                                              type: method_invocation
                                              fields:
                                                text: n.getChildCount()
                                              children: []
                                              pos: 4526
                                              length: 17
                                            right:
                                              type: decimal_integer_literal
                                              fields:
                                                text: '2'
                                              children: []
                                              pos: 4547
                                              length: 1
                                          children: []
                                          pos: 4526
                                          length: 22
                                      children: []
                                      pos: 4512
                                      length: 36
                                    right:
                                      type: method_invocation
                                      fields:
                                        text: '"require".equals(n.getFirstChild().getQualifiedName())'
                                      children: []
                                      pos: 4562
                                      length: 54
                                  children: []
                                  pos: 4512
                                  length: 104
                                right:
                                  type: method_invocation
                                  fields:
                                    text: n.getChildAtIndex(1).isString()
                                  children: []
                                  pos: 4630
                                  length: 31
                              children: []
                              pos: 4512
                              length: 149
                          children: []
                          pos: 4511
                          length: 151
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: visitRequireCall(t, n, parent);
                          children: []
                          pos: 4673
                          length: 31
                        pos: 4663
                        length: 49
                      pos: 4508
                      length: 204
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: n.isScript()
                              children: []
                              pos: 4724
                              length: 12
                          children: []
                          pos: 4723
                          length: 14
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: scriptNodeCount++;
                          children: []
                          pos: 4748
                          length: 18
                        - type: expression_statement
                          fields:
                            text: visitScript(t, n);
                          children: []
                          pos: 4775
                          length: 18
                        pos: 4738
                        length: 63
                      pos: 4720
                      length: 81
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: and
                              fields:
                                left:
                                  type: method_invocation
                                  fields:
                                    text: n.isGetProp()
                                  children: []
                                  pos: 4813
                                  length: 13
                                right:
                                  type: method_invocation
                                  fields:
                                    text: '"module.exports".equals(n.getQualifiedName())'
                                  children: []
                                  pos: 4840
                                  length: 45
                              children: []
                              pos: 4813
                              length: 72
                          children: []
                          pos: 4812
                          length: 74
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: visitModuleExports(n);
                          children: []
                          pos: 4897
                          length: 22
                        pos: 4887
                        length: 40
                      pos: 4809
                      length: 118
                    pos: 4500
                    length: 433
                children: []
                pos: 4430
                length: 503
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visitRequireCall
                    children: []
                    pos: 5107
                    length: 16
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 5124
                      length: 15
                    pos: 5094
                    length: 711
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: |-
                          String moduleName = toModuleName(require.getChildAtIndex(1).getString(),
                                    normalizeSourceName(t.getSourceName()));
                      children: []
                      pos: 5176
                      length: 123
                    - type: local_variable_declaration
                      fields:
                        text: Node moduleRef = IR.name(moduleName).srcref(require);
                      children: []
                      pos: 5306
                      length: 53
                    - type: expression_statement
                      fields:
                        text: parent.replaceChild(require, moduleRef);
                      children: []
                      pos: 5366
                      length: 40
                    - type: local_variable_declaration
                      fields:
                        text: Node script = getCurrentScriptNode(parent);
                      children: []
                      pos: 5413
                      length: 43
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: identifier
                              fields:
                                text: reportDependencies
                              children: []
                              pos: 5467
                              length: 18
                          children: []
                          pos: 5466
                          length: 20
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: expression_statement
                          fields:
                            text: t.getInput().addRequire(moduleName);
                          children: []
                          pos: 5497
                          length: 36
                        pos: 5487
                        length: 54
                      pos: 5463
                      length: 78
                    - type: expression_statement
                      fields:
                        text: |-
                          script.addChildToFront(IR.exprResult(
                                    IR.call(IR.getprop(IR.name("goog"), IR.string("require")),
                                        IR.string(moduleName))).copyInformationFromForTree(require));
                      children: []
                      pos: 5582
                      length: 182
                    - type: expression_statement
                      fields:
                        text: compiler.reportCodeChange();
                      children: []
                      pos: 5771
                      length: 28
                    pos: 5168
                    length: 637
                children: []
                pos: 5094
                length: 711
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visitScript
                    children: []
                    pos: 5945
                    length: 11
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 5957
                      length: 15
                    pos: 5932
                    length: 1113
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: |-
                          Preconditions.checkArgument(scriptNodeCount == 1,
                                    "ProcessCommonJSModules supports only one invocation per " +
                                    "CompilerInput / script node");
                      children: []
                      pos: 5995
                      length: 162
                    - type: local_variable_declaration
                      fields:
                        text: |-
                          String moduleName = guessCJSModuleName(normalizeSourceName(script
                                    .getSourceFileName()));
                      children: []
                      pos: 6164
                      length: 99
                    - type: expression_statement
                      fields:
                        text: |-
                          script.addChildToFront(IR.var(IR.name(moduleName), IR.objectlit())
                                    .copyInformationFromForTree(script));
                      children: []
                      pos: 6270
                      length: 114
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: identifier
                              fields:
                                text: reportDependencies
                              children: []
                              pos: 6395
                              length: 18
                          children: []
                          pos: 6394
                          length: 20
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: local_variable_declaration
                          fields:
                            text: CompilerInput ci = t.getInput();
                          children: []
                          pos: 6425
                          length: 32
                        - type: expression_statement
                          fields:
                            text: ci.addProvide(moduleName);
                          children: []
                          pos: 6466
                          length: 26
                        - type: local_variable_declaration
                          fields:
                            text: JSModule m = new JSModule(moduleName);
                          children: []
                          pos: 6501
                          length: 38
                        - type: expression_statement
                          fields:
                            text: m.addAndOverrideModule(ci);
                          children: []
                          pos: 6548
                          length: 27
                        - type: expression_statement
                          fields:
                            text: module = m;
                          children: []
                          pos: 6584
                          length: 11
                        pos: 6415
                        length: 188
                      pos: 6391
                      length: 212
                    - type: expression_statement
                      fields:
                        text: |-
                          script.addChildToFront(IR.exprResult(
                                    IR.call(IR.getprop(IR.name("goog"), IR.string("provide")),
                                        IR.string(moduleName))).copyInformationFromForTree(script));
                      children: []
                      pos: 6610
                      length: 181
                    - type: expression_statement
                      fields:
                        text: emitOptionalModuleExportsOverride(script, moduleName);
                      children: []
                      pos: 6799
                      length: 54
                    - type: expression_statement
                      fields:
                        text: |-
                          NodeTraversal.traverse(compiler, script, new SuffixVarsCallback(
                                    moduleName));
                      children: []
                      pos: 6915
                      length: 88
                    - type: expression_statement
                      fields:
                        text: compiler.reportCodeChange();
                      children: []
                      pos: 7011
                      length: 28
                    pos: 5987
                    length: 1058
                children: []
                pos: 5932
                length: 1113
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: emitOptionalModuleExportsOverride
                    children: []
                    pos: 7212
                    length: 33
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node script
                      children: []
                      pos: 7246
                      length: 11
                    pos: 7199
                    length: 426
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: |-
                          Node moduleExportsProp = IR.getprop(IR.name(moduleName),
                                    IR.string("module$exports"));
                      children: []
                      pos: 7295
                      length: 96
                    - type: expression_statement
                      fields:
                        text: |-
                          script.addChildToBack(IR.ifNode(
                                    moduleExportsProp,
                                    IR.block(IR.exprResult(IR.assign(IR.name(moduleName),
                                        moduleExportsProp.cloneTree())))).copyInformationFromForTree(
                                    script));
                      children: []
                      pos: 7398
                      length: 221
                    pos: 7286
                    length: 339
                children: []
                pos: 7199
                length: 426
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visitModuleExports
                    children: []
                    pos: 7720
                    length: 18
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node prop
                      children: []
                      pos: 7739
                      length: 9
                    pos: 7707
                    length: 406
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: local_variable_declaration
                      fields:
                        text: String moduleName = guessCJSModuleName(prop.getSourceFileName());
                      children: []
                      pos: 7758
                      length: 65
                    - type: local_variable_declaration
                      fields:
                        text: Node module = prop.getChildAtIndex(0);
                      children: []
                      pos: 7830
                      length: 38
                    - type: expression_statement
                      fields:
                        text: module.putProp(Node.ORIGINALNAME_PROP, "module");
                      children: []
                      pos: 7875
                      length: 49
                    - type: expression_statement
                      fields:
                        text: module.setString(moduleName);
                      children: []
                      pos: 7931
                      length: 29
                    - type: local_variable_declaration
                      fields:
                        text: Node exports = prop.getChildAtIndex(1);
                      children: []
                      pos: 7967
                      length: 39
                    - type: expression_statement
                      fields:
                        text: exports.putProp(Node.ORIGINALNAME_PROP, "exports");
                      children: []
                      pos: 8013
                      length: 51
                    - type: expression_statement
                      fields:
                        text: exports.setString("module$exports");
                      children: []
                      pos: 8071
                      length: 36
                    pos: 7750
                    length: 363
                children: []
                pos: 7707
                length: 406
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: getCurrentScriptNode
                    children: []
                    pos: 8192
                    length: 20
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node n
                      children: []
                      pos: 8213
                      length: 6
                    pos: 8179
                    length: 163
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: while_statement
                      fields:
                        text: |-
                          while (true) {
                                  if (n.isScript()) {
                                    return n;
                                  }
                                  n = n.getParent();
                                }
                      children: []
                      pos: 8229
                      length: 107
                    pos: 8221
                    length: 121
                children: []
                pos: 8179
                length: 163
              pos: 4300
              length: 4046
          children: []
          pos: 4300
          length: 4046
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: SuffixVarsCallback
              children: []
              pos: 8454
              length: 18
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private static final String EXPORTS = "exports";
                children: []
                pos: 8514
                length: 48
              - type: field_declaration
                fields:
                  text: private final String suffix;
                children: []
                pos: 8568
                length: 28
              - type: constructor_declaration
                fields:
                  text: |-
                    SuffixVarsCallback(String suffix) {
                          this.suffix = suffix;
                        }
                children: []
                pos: 8602
                length: 69
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visit
                    children: []
                    pos: 8703
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 8709
                      length: 15
                    pos: 8677
                    length: 569
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: n.isName()
                              children: []
                              pos: 8759
                              length: 10
                          children: []
                          pos: 8758
                          length: 12
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: local_variable_declaration
                          fields:
                            text: String name = n.getString();
                          children: []
                          pos: 8781
                          length: 28
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: method_invocation
                                  fields:
                                    text: suffix.equals(name)
                                  children: []
                                  pos: 8822
                                  length: 19
                              children: []
                              pos: 8821
                              length: 21
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: return_statement
                              fields:
                                text: return;
                              children: []
                              pos: 8855
                              length: 7
                            pos: 8843
                            length: 29
                          pos: 8818
                          length: 54
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: method_invocation
                                  fields:
                                    text: EXPORTS.equals(name)
                                  children: []
                                  pos: 8885
                                  length: 20
                              children: []
                              pos: 8884
                              length: 22
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: expression_statement
                              fields:
                                text: n.setString(suffix);
                              children: []
                              pos: 8919
                              length: 20
                            - type: expression_statement
                              fields:
                                text: n.putProp(Node.ORIGINALNAME_PROP, EXPORTS);
                              children: []
                              pos: 8950
                              length: 43
                            pos: 8907
                            length: 96
                          pos: 8881
                          length: 351
                        pos: 8771
                        length: 469
                      pos: 8755
                      length: 485
                    pos: 8747
                    length: 499
                children: []
                pos: 8677
                length: 569
              pos: 8440
              length: 810
          children: []
          pos: 8440
          length: 810
        pos: 1440
        length: 7812
    children: []
    pos: 1440
    length: 7812
  pos: 0
  length: 9253
text_diff: "--- before\n+++ after\n@@ -125,7 +125,6 @@\n       AbstractPostOrderCallback
  {\n \n     private int scriptNodeCount = 0;\n-    private Set<String> modulesWithExports
  = Sets.newHashSet();\n \n     @Override\n     public void visit(NodeTraversal t,
  Node n, Node parent) {\n@@ -205,9 +204,6 @@\n      */\n     private void emitOptionalModuleExportsOverride(Node
  script,\n         String moduleName) {\n-      if (!modulesWithExports.contains(moduleName))
  {\n-        return;\n-      }\n \n       Node moduleExportsProp = IR.getprop(IR.name(moduleName),\n
  \          IR.string(\"module$exports\"));\n@@ -229,7 +225,6 @@\n       Node exports
  = prop.getChildAtIndex(1);\n       exports.putProp(Node.ORIGINALNAME_PROP, \"exports\");\n
  \      exports.setString(\"module$exports\");\n-      modulesWithExports.add(moduleName);\n
  \    }\n \n     /**\n"
tree_diff: |+
  New cluster:
  ===
  insert-node
  ---
  method_declaration [7199,7625]
  to
  class_body [4300,8530]
  at 5
  ------------
  ===
  insert-node
  ---
  method_declaration [7199,7625]
  to
  class_body [4300,8530]
  at 5
  ===
  insert-node
  ---
  identifier: emitOptionalModuleExportsOverride [7212,7245]
  to
  method_declaration [7199,7625]
  at 0

  New cluster:
  ===
  insert-node
  ---
  method_declaration [7707,8113]
  to
  class_body [4300,8530]
  at 6
  ------------
  ===
  insert-node
  ---
  method_declaration [7707,8113]
  to
  class_body [4300,8530]
  at 6
  ===
  insert-node
  ---
  identifier: visitModuleExports [7720,7738]
  to
  method_declaration [7707,8113]
  at 0

  New cluster:
  MOVE from method_declaration [7199,7625]
  ------------
  ===
  move-tree
  ---
  method_parameters [7263,7767]
      formal_parameter: Node script [7310,7321]
  to
  method_declaration [7199,7625]
  at 1

  New cluster:
  Unknown cluster type
  ------------
  ===
  insert-tree
  ---
  block [7286,7625]
      local_variable_declaration: Node moduleExportsProp = IR.getprop(IR.name(moduleName),
            IR.string("module$exports")); [7295,7391]
      expression_statement: script.addChildToBack(IR.ifNode(
            moduleExportsProp,
            IR.block(IR.exprResult(IR.assign(IR.name(moduleName),
                moduleExportsProp.cloneTree())))).copyInformationFromForTree(
            script)); [7398,7619]
  to
  method_declaration [7199,7625]
  at 2

  New cluster:
  MOVE from method_declaration [7707,8113]
  ------------
  ===
  move-tree
  ---
  method_parameters [7849,8297]
      formal_parameter: Node prop [7881,7890]
  to
  method_declaration [7707,8113]
  at 1

  New cluster:
  Unknown cluster type
  ------------
  ===
  insert-tree
  ---
  block [7750,8113]
      local_variable_declaration: String moduleName = guessCJSModuleName(prop.getSourceFileName()); [7758,7823]
      local_variable_declaration: Node module = prop.getChildAtIndex(0); [7830,7868]
      expression_statement: module.putProp(Node.ORIGINALNAME_PROP, "module"); [7875,7924]
      expression_statement: module.setString(moduleName); [7931,7960]
      local_variable_declaration: Node exports = prop.getChildAtIndex(1); [7967,8006]
      expression_statement: exports.putProp(Node.ORIGINALNAME_PROP, "exports"); [8013,8064]
      expression_statement: exports.setString("module$exports"); [8071,8107]
  to
  method_declaration [7707,8113]
  at 2

  New cluster:
  ===
  delete-node
  ---
  field_declaration: private Set<String> modulesWithExports = Sets.newHashSet(); [4429,4488]
  ===
  ------------
  ===
  delete-node
  ---
  field_declaration: private Set<String> modulesWithExports = Sets.newHashSet(); [4429,4488]
  ===

  New cluster:
  ===
  delete-node
  ---
  method_declaration [7263,7767]
  ===
  ------------
  ===
  delete-node
  ---
  identifier: emitOptionalModuleExportsOverride [7276,7309]
  ===
  ===
  delete-node
  ---
  method_declaration [7263,7767]
  ===

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  block [7350,7767]
      if_statement [7358,7429]
          parenthesized_expression [7361,7403]
              unary_expression: !modulesWithExports.contains(moduleName) [7362,7402]
          block [7404,7429]
              return_statement: return; [7414,7421]
      local_variable_declaration: Node moduleExportsProp = IR.getprop(IR.name(moduleName),
            IR.string("module$exports")); [7437,7533]
      expression_statement: script.addChildToBack(IR.ifNode(
            moduleExportsProp,
            IR.block(IR.exprResult(IR.assign(IR.name(moduleName),
                moduleExportsProp.cloneTree())))).copyInformationFromForTree(
            script)); [7540,7761]

  New cluster:
  ===
  delete-node
  ---
  method_declaration [7849,8297]
  ===
  ------------
  ===
  delete-node
  ---
  method_declaration [7849,8297]
  ===
  ===
  delete-node
  ---
  identifier: visitModuleExports [7862,7880]
  ===

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  block [7892,8297]
      local_variable_declaration: String moduleName = guessCJSModuleName(prop.getSourceFileName()); [7900,7965]
      local_variable_declaration: Node module = prop.getChildAtIndex(0); [7972,8010]
      expression_statement: module.putProp(Node.ORIGINALNAME_PROP, "module"); [8017,8066]
      expression_statement: module.setString(moduleName); [8073,8102]
      local_variable_declaration: Node exports = prop.getChildAtIndex(1); [8109,8148]
      expression_statement: exports.putProp(Node.ORIGINALNAME_PROP, "exports"); [8155,8206]
      expression_statement: exports.setString("module$exports"); [8213,8249]
      expression_statement: modulesWithExports.add(moduleName); [8256,8291]

...
