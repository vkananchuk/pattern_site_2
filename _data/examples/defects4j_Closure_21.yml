---
language: java
before_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: CheckSideEffects
        children: []
        pos: 1344
        length: 16
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: |-
              static final DiagnosticType USELESS_CODE_ERROR = DiagnosticType.warning(
                    "JSC_USELESS_CODE",
                    "Suspicious code. {0}");
          children: []
          pos: 1435
          length: 129
        - type: field_declaration
          fields:
            text: static final String PROTECTOR_FN = "JSCOMPILER_PRESERVE";
          children: []
          pos: 1568
          length: 57
        - type: field_declaration
          fields:
            text: private final CheckLevel level;
          children: []
          pos: 1629
          length: 31
        - type: field_declaration
          fields:
            text: private final List<Node> problemNodes = Lists.newArrayList();
          children: []
          pos: 1664
          length: 61
        - type: field_declaration
          fields:
            text: private final AbstractCompiler compiler;
          children: []
          pos: 1729
          length: 40
        - type: field_declaration
          fields:
            text: private final boolean protectSideEffectFreeCode;
          children: []
          pos: 1773
          length: 48
        - type: constructor_declaration
          fields:
            text: |-
              CheckSideEffects(AbstractCompiler compiler, CheckLevel level,
                    boolean protectSideEffectFreeCode) {
                  this.compiler = compiler;
                  this.level = level;
                  this.protectSideEffectFreeCode = protectSideEffectFreeCode;
                }
          children: []
          pos: 1825
          length: 226
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: process
              children: []
              pos: 2079
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node externs
                children: []
                pos: 2087
                length: 12
              pos: 2055
              length: 453
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: NodeTraversal.traverse(compiler, root, this);
                children: []
                pos: 2118
                length: 45
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: protectSideEffectFreeCode
                        children: []
                        pos: 2442
                        length: 25
                    children: []
                    pos: 2441
                    length: 27
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: protectSideEffects();
                    children: []
                    pos: 2477
                    length: 21
                  pos: 2469
                  length: 35
                pos: 2438
                length: 66
              pos: 2112
              length: 396
          children: []
          pos: 2055
          length: 453
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: hotSwapScript
              children: []
              pos: 2536
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node scriptRoot
                children: []
                pos: 2550
                length: 15
              pos: 2512
              length: 135
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: NodeTraversal.traverse(compiler, scriptRoot, this);
                children: []
                pos: 2592
                length: 51
              pos: 2586
              length: 61
          children: []
          pos: 2512
          length: 135
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: visit
              children: []
              pos: 2675
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: NodeTraversal t
                children: []
                pos: 2681
                length: 15
              pos: 2651
              length: 1776
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isEmpty()
                            children: []
                            pos: 2978
                            length: 11
                          right:
                            type: method_invocation
                            fields:
                              text: n.isComma()
                            children: []
                            pos: 3001
                            length: 11
                        children: []
                        pos: 2978
                        length: 34
                    children: []
                    pos: 2977
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3022
                    length: 7
                  pos: 3014
                  length: 21
                pos: 2974
                length: 61
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: parent
                            children: []
                            pos: 3045
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3055
                            length: 4
                        children: []
                        pos: 3045
                        length: 14
                    children: []
                    pos: 3044
                    length: 16
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3069
                    length: 7
                  pos: 3061
                  length: 21
                pos: 3041
                length: 41
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isExprResult()
                            children: []
                            pos: 3305
                            length: 16
                          right:
                            type: method_invocation
                            fields:
                              text: n.isBlock()
                            children: []
                            pos: 3325
                            length: 11
                        children: []
                        pos: 3305
                        length: 31
                    children: []
                    pos: 3304
                    length: 33
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3346
                    length: 7
                  pos: 3338
                  length: 21
                pos: 3301
                length: 58
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: and
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isQualifiedName()
                            children: []
                            pos: 3512
                            length: 19
                          right:
                            type: not_equals
                            fields:
                              left:
                                type: method_invocation
                                fields:
                                  text: n.getJSDocInfo()
                                children: []
                                pos: 3535
                                length: 16
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 3555
                                length: 4
                            children: []
                            pos: 3535
                            length: 24
                        children: []
                        pos: 3512
                        length: 47
                    children: []
                    pos: 3511
                    length: 49
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3569
                    length: 7
                  pos: 3561
                  length: 21
                pos: 3508
                length: 74
              - type: local_variable_declaration
                fields:
                  text: boolean isResultUsed = NodeUtil.isExpressionResultUsed(n);
                children: []
                pos: 3588
                length: 58
              - type: local_variable_declaration
                fields:
                  text: boolean isSimpleOp = NodeUtil.isSimpleOperatorType(n.getType());
                children: []
                pos: 3651
                length: 64
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: and
                        fields:
                          left:
                            type: unary_expression
                            fields:
                              text: "!isResultUsed"
                            children: []
                            pos: 3724
                            length: 13
                          right:
                            type: parenthesized_expression
                            fields:
                              expression:
                                type: or
                                fields:
                                  left:
                                    type: identifier
                                    fields:
                                      text: isSimpleOp
                                    children: []
                                    pos: 3750
                                    length: 10
                                  right:
                                    type: unary_expression
                                    fields:
                                      text: "!NodeUtil.mayHaveSideEffects(n, t.getCompiler())"
                                    children: []
                                    pos: 3764
                                    length: 48
                                children: []
                                pos: 3750
                                length: 62
                            children: []
                            pos: 3749
                            length: 64
                        children: []
                        pos: 3724
                        length: 89
                    children: []
                    pos: 3723
                    length: 91
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String msg = "This code lacks side-effects. Is there a
                        bug?";
                    children: []
                    pos: 3823
                    length: 61
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: n.isString()
                            children: []
                            pos: 3895
                            length: 12
                        children: []
                        pos: 3894
                        length: 14
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: msg = "Is there a missing '+' on the previous line?";
                        children: []
                        pos: 3919
                        length: 53
                      pos: 3909
                      length: 71
                    pos: 3891
                    length: 243
                  - type: expression_statement
                    fields:
                      text: |-
                        t.getCompiler().report(
                                  t.makeError(n, level, USELESS_CODE_ERROR, msg));
                    children: []
                    pos: 4142
                    length: 82
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: unary_expression
                            fields:
                              text: "!NodeUtil.isStatement(n)"
                            children: []
                            pos: 4353
                            length: 24
                        children: []
                        pos: 4352
                        length: 26
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: problemNodes.add(n);
                        children: []
                        pos: 4389
                        length: 20
                      pos: 4379
                      length: 38
                    pos: 4349
                    length: 68
                  pos: 3815
                  length: 608
                pos: 3720
                length: 703
              pos: 2719
              length: 1708
          children: []
          pos: 2651
          length: 1776
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: protectSideEffects
              children: []
              pos: 4627
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 4614
              length: 490
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!problemNodes.isEmpty()"
                        children: []
                        pos: 4658
                        length: 23
                    children: []
                    pos: 4657
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: addExtern();
                    children: []
                    pos: 4691
                    length: 12
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Node n : problemNodes) {
                                Node name = IR.name(PROTECTOR_FN).srcref(n);
                                name.putBooleanProp(Node.IS_CONSTANT_NAME, true);
                                Node replacement = IR.call(name).srcref(n);
                                replacement.putBooleanProp(Node.FREE_CALL, true);
                                n.getParent().replaceChild(n, replacement);
                                replacement.addChildToBack(n);
                              }
                    children: []
                    pos: 4710
                    length: 349
                  - type: expression_statement
                    fields:
                      text: compiler.reportCodeChange();
                    children: []
                    pos: 5066
                    length: 28
                  pos: 4683
                  length: 417
                pos: 4654
                length: 446
              pos: 4648
              length: 456
          children: []
          pos: 4614
          length: 490
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: addExtern
              children: []
              pos: 5121
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5108
              length: 517
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Node name = IR.name(PROTECTOR_FN);
                children: []
                pos: 5139
                length: 34
              - type: expression_statement
                fields:
                  text: name.putBooleanProp(Node.IS_CONSTANT_NAME, true);
                children: []
                pos: 5178
                length: 49
              - type: local_variable_declaration
                fields:
                  text: Node var = IR.var(name);
                children: []
                pos: 5232
                length: 24
              - type: local_variable_declaration
                fields:
                  text: JSDocInfoBuilder builder = new JSDocInfoBuilder(false);
                children: []
                pos: 5342
                length: 55
              - type: expression_statement
                fields:
                  text: builder.recordNoAlias();
                children: []
                pos: 5402
                length: 24
              - type: expression_statement
                fields:
                  text: var.setJSDocInfo(builder.build(var));
                children: []
                pos: 5431
                length: 37
              - type: local_variable_declaration
                fields:
                  text: CompilerInput input = compiler.getSynthesizedExternsInput();
                children: []
                pos: 5473
                length: 60
              - type: expression_statement
                fields:
                  text: input.getAstRoot(compiler).addChildrenToBack(var);
                children: []
                pos: 5538
                length: 50
              - type: expression_statement
                fields:
                  text: compiler.reportCodeChange();
                children: []
                pos: 5593
                length: 28
              pos: 5133
              length: 492
          children: []
          pos: 5108
          length: 517
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: StripProtection
              children: []
              pos: 5694
              length: 15
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final AbstractCompiler compiler;
                children: []
                pos: 5775
                length: 40
              - type: constructor_declaration
                fields:
                  text: |-
                    StripProtection(AbstractCompiler compiler) {
                          this.compiler = compiler;
                        }
                children: []
                pos: 5821
                length: 82
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: process
                    children: []
                    pos: 5935
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node externs
                      children: []
                      pos: 5943
                      length: 12
                    pos: 5909
                    length: 118
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: NodeTraversal.traverse(compiler, root, this);
                      children: []
                      pos: 5976
                      length: 45
                    pos: 5968
                    length: 59
                children: []
                pos: 5909
                length: 118
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visit
                    children: []
                    pos: 6059
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 6065
                      length: 15
                    pos: 6033
                    length: 465
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: n.isCall()
                              children: []
                              pos: 6115
                              length: 10
                          children: []
                          pos: 6114
                          length: 12
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: local_variable_declaration
                          fields:
                            text: Node target = n.getFirstChild();
                          children: []
                          pos: 6137
                          length: 32
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: and
                                  fields:
                                    left:
                                      type: method_invocation
                                      fields:
                                        text: target.isName()
                                      children: []
                                      pos: 6303
                                      length: 15
                                    right:
                                      type: method_invocation
                                      fields:
                                        text: target.getString().equals(PROTECTOR_FN)
                                      children: []
                                      pos: 6322
                                      length: 39
                                  children: []
                                  pos: 6303
                                  length: 58
                              children: []
                              pos: 6302
                              length: 60
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: local_variable_declaration
                              fields:
                                text: Node expr = n.getLastChild();
                              children: []
                              pos: 6375
                              length: 29
                            - type: expression_statement
                              fields:
                                text: n.detachChildren();
                              children: []
                              pos: 6415
                              length: 19
                            - type: expression_statement
                              fields:
                                text: parent.replaceChild(n, expr);
                              children: []
                              pos: 6445
                              length: 29
                            pos: 6363
                            length: 121
                          pos: 6299
                          length: 185
                        pos: 6127
                        length: 365
                      pos: 6111
                      length: 381
                    pos: 6103
                    length: 395
                children: []
                pos: 6033
                length: 465
              pos: 5681
              length: 821
          children: []
          pos: 5681
          length: 821
        pos: 1332
        length: 5172
    children: []
    pos: 1332
    length: 5172
  pos: 0
  length: 6505
after_tree:
  type: program
  fields: {}
  children:
  - type: class_declaration
    fields:
      name:
        type: identifier
        fields:
          text: CheckSideEffects
        children: []
        pos: 1344
        length: 16
      body:
        type: class_body
        fields: {}
        children:
        - type: field_declaration
          fields:
            text: |-
              static final DiagnosticType USELESS_CODE_ERROR = DiagnosticType.warning(
                    "JSC_USELESS_CODE",
                    "Suspicious code. {0}");
          children: []
          pos: 1435
          length: 129
        - type: field_declaration
          fields:
            text: static final String PROTECTOR_FN = "JSCOMPILER_PRESERVE";
          children: []
          pos: 1568
          length: 57
        - type: field_declaration
          fields:
            text: private final CheckLevel level;
          children: []
          pos: 1629
          length: 31
        - type: field_declaration
          fields:
            text: private final List<Node> problemNodes = Lists.newArrayList();
          children: []
          pos: 1664
          length: 61
        - type: field_declaration
          fields:
            text: private final AbstractCompiler compiler;
          children: []
          pos: 1729
          length: 40
        - type: field_declaration
          fields:
            text: private final boolean protectSideEffectFreeCode;
          children: []
          pos: 1773
          length: 48
        - type: constructor_declaration
          fields:
            text: |-
              CheckSideEffects(AbstractCompiler compiler, CheckLevel level,
                    boolean protectSideEffectFreeCode) {
                  this.compiler = compiler;
                  this.level = level;
                  this.protectSideEffectFreeCode = protectSideEffectFreeCode;
                }
          children: []
          pos: 1825
          length: 226
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: process
              children: []
              pos: 2079
              length: 7
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node externs
                children: []
                pos: 2087
                length: 12
              pos: 2055
              length: 453
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: NodeTraversal.traverse(compiler, root, this);
                children: []
                pos: 2118
                length: 45
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: identifier
                        fields:
                          text: protectSideEffectFreeCode
                        children: []
                        pos: 2442
                        length: 25
                    children: []
                    pos: 2441
                    length: 27
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: protectSideEffects();
                    children: []
                    pos: 2477
                    length: 21
                  pos: 2469
                  length: 35
                pos: 2438
                length: 66
              pos: 2112
              length: 396
          children: []
          pos: 2055
          length: 453
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: hotSwapScript
              children: []
              pos: 2536
              length: 13
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: Node scriptRoot
                children: []
                pos: 2550
                length: 15
              pos: 2512
              length: 135
            body:
              type: block
              fields: {}
              children:
              - type: expression_statement
                fields:
                  text: NodeTraversal.traverse(compiler, scriptRoot, this);
                children: []
                pos: 2592
                length: 51
              pos: 2586
              length: 61
          children: []
          pos: 2512
          length: 135
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: visit
              children: []
              pos: 2675
              length: 5
            parameters:
              type: method_parameters
              fields: {}
              children:
              - type: formal_parameter
                fields:
                  text: NodeTraversal t
                children: []
                pos: 2681
                length: 15
              pos: 2651
              length: 2433
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: or
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isEmpty()
                            children: []
                            pos: 2978
                            length: 11
                          right:
                            type: method_invocation
                            fields:
                              text: n.isComma()
                            children: []
                            pos: 3001
                            length: 11
                        children: []
                        pos: 2978
                        length: 34
                    children: []
                    pos: 2977
                    length: 36
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3022
                    length: 7
                  pos: 3014
                  length: 21
                pos: 2974
                length: 61
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: identifier
                            fields:
                              text: parent
                            children: []
                            pos: 3045
                            length: 6
                          right:
                            type: null_literal
                            fields: {}
                            children: []
                            pos: 3055
                            length: 4
                        children: []
                        pos: 3045
                        length: 14
                    children: []
                    pos: 3044
                    length: 16
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3069
                    length: 7
                  pos: 3061
                  length: 21
                pos: 3041
                length: 41
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: method_invocation
                        fields:
                          text: n.isExprResult()
                        children: []
                        pos: 3305
                        length: 16
                    children: []
                    pos: 3304
                    length: 18
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3331
                    length: 7
                  pos: 3323
                  length: 21
                pos: 3301
                length: 43
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: and
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: n.isQualifiedName()
                            children: []
                            pos: 3497
                            length: 19
                          right:
                            type: not_equals
                            fields:
                              left:
                                type: method_invocation
                                fields:
                                  text: n.getJSDocInfo()
                                children: []
                                pos: 3520
                                length: 16
                              right:
                                type: null_literal
                                fields: {}
                                children: []
                                pos: 3540
                                length: 4
                            children: []
                            pos: 3520
                            length: 24
                        children: []
                        pos: 3497
                        length: 47
                    children: []
                    pos: 3496
                    length: 49
                children:
                - type: block
                  fields: {}
                  children:
                  - type: return_statement
                    fields:
                      text: return;
                    children: []
                    pos: 3554
                    length: 7
                  pos: 3546
                  length: 21
                pos: 3493
                length: 74
              - type: local_variable_declaration
                fields:
                  text: boolean isResultUsed = NodeUtil.isExpressionResultUsed(n);
                children: []
                pos: 3573
                length: 58
              - type: local_variable_declaration
                fields:
                  text: boolean isSimpleOp = NodeUtil.isSimpleOperatorType(n.getType());
                children: []
                pos: 3636
                length: 64
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: equals
                        fields:
                          left:
                            type: method_invocation
                            fields:
                              text: parent.getType()
                            children: []
                            pos: 3709
                            length: 16
                          right:
                            type: field_access
                            fields:
                              text: Token.COMMA
                            children: []
                            pos: 3729
                            length: 11
                        children: []
                        pos: 3709
                        length: 31
                    children: []
                    pos: 3708
                    length: 33
                children:
                - type: block
                  fields: {}
                  children:
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: identifier
                            fields:
                              text: isResultUsed
                            children: []
                            pos: 3754
                            length: 12
                        children: []
                        pos: 3753
                        length: 14
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: return_statement
                        fields:
                          text: return;
                        children: []
                        pos: 3778
                        length: 7
                      pos: 3768
                      length: 25
                    pos: 3750
                    length: 43
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: equals
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: "n"
                                children: []
                                pos: 3804
                                length: 1
                              right:
                                type: method_invocation
                                fields:
                                  text: parent.getLastChild()
                                children: []
                                pos: 3809
                                length: 21
                            children: []
                            pos: 3804
                            length: 26
                        children: []
                        pos: 3803
                        length: 28
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: enhanced_for_statement
                        fields:
                          text: |-
                            for (Node an : parent.getAncestors()) {
                                      int ancestorType = an.getType();
                                      if (ancestorType == Token.COMMA) continue;
                                      if (ancestorType != Token.EXPR_RESULT && ancestorType != Token.BLOCK) return;
                                      else break;
                                    }
                        children: []
                        pos: 3842
                        length: 255
                      pos: 3832
                      length: 273
                    pos: 3800
                    length: 305
                  pos: 3742
                  length: 369
                pos: 3705
                length: 683
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: or
                            fields:
                              left:
                                type: identifier
                                fields:
                                  text: isSimpleOp
                                children: []
                                pos: 4407
                                length: 10
                              right:
                                type: unary_expression
                                fields:
                                  text: "!NodeUtil.mayHaveSideEffects(n, t.getCompiler())"
                                children: []
                                pos: 4421
                                length: 48
                            children: []
                            pos: 4407
                            length: 62
                        children: []
                        pos: 4406
                        length: 64
                    children: []
                    pos: 4396
                    length: 75
                children:
                - type: block
                  fields: {}
                  children:
                  - type: local_variable_declaration
                    fields:
                      text: String msg = "This code lacks side-effects. Is there a
                        bug?";
                    children: []
                    pos: 4480
                    length: 61
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: method_invocation
                            fields:
                              text: n.isString()
                            children: []
                            pos: 4552
                            length: 12
                        children: []
                        pos: 4551
                        length: 14
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: msg = "Is there a missing '+' on the previous line?";
                        children: []
                        pos: 4576
                        length: 53
                      pos: 4566
                      length: 71
                    pos: 4548
                    length: 243
                  - type: expression_statement
                    fields:
                      text: |-
                        t.getCompiler().report(
                                  t.makeError(n, level, USELESS_CODE_ERROR, msg));
                    children: []
                    pos: 4799
                    length: 82
                  - type: if_statement
                    fields:
                      condition:
                        type: parenthesized_expression
                        fields:
                          expression:
                            type: unary_expression
                            fields:
                              text: "!NodeUtil.isStatement(n)"
                            children: []
                            pos: 5010
                            length: 24
                        children: []
                        pos: 5009
                        length: 26
                    children:
                    - type: block
                      fields: {}
                      children:
                      - type: expression_statement
                        fields:
                          text: problemNodes.add(n);
                        children: []
                        pos: 5046
                        length: 20
                      pos: 5036
                      length: 38
                    pos: 5006
                    length: 68
                  pos: 4472
                  length: 608
                pos: 4393
                length: 687
              pos: 2719
              length: 2365
          children: []
          pos: 2651
          length: 2433
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: protectSideEffects
              children: []
              pos: 5284
              length: 18
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5271
              length: 490
            body:
              type: block
              fields: {}
              children:
              - type: if_statement
                fields:
                  condition:
                    type: parenthesized_expression
                    fields:
                      expression:
                        type: unary_expression
                        fields:
                          text: "!problemNodes.isEmpty()"
                        children: []
                        pos: 5315
                        length: 23
                    children: []
                    pos: 5314
                    length: 25
                children:
                - type: block
                  fields: {}
                  children:
                  - type: expression_statement
                    fields:
                      text: addExtern();
                    children: []
                    pos: 5348
                    length: 12
                  - type: enhanced_for_statement
                    fields:
                      text: |-
                        for (Node n : problemNodes) {
                                Node name = IR.name(PROTECTOR_FN).srcref(n);
                                name.putBooleanProp(Node.IS_CONSTANT_NAME, true);
                                Node replacement = IR.call(name).srcref(n);
                                replacement.putBooleanProp(Node.FREE_CALL, true);
                                n.getParent().replaceChild(n, replacement);
                                replacement.addChildToBack(n);
                              }
                    children: []
                    pos: 5367
                    length: 349
                  - type: expression_statement
                    fields:
                      text: compiler.reportCodeChange();
                    children: []
                    pos: 5723
                    length: 28
                  pos: 5340
                  length: 417
                pos: 5311
                length: 446
              pos: 5305
              length: 456
          children: []
          pos: 5271
          length: 490
        - type: method_declaration
          fields:
            name:
              type: identifier
              fields:
                text: addExtern
              children: []
              pos: 5778
              length: 9
            parameters:
              type: method_parameters
              fields: {}
              children: []
              pos: 5765
              length: 517
            body:
              type: block
              fields: {}
              children:
              - type: local_variable_declaration
                fields:
                  text: Node name = IR.name(PROTECTOR_FN);
                children: []
                pos: 5796
                length: 34
              - type: expression_statement
                fields:
                  text: name.putBooleanProp(Node.IS_CONSTANT_NAME, true);
                children: []
                pos: 5835
                length: 49
              - type: local_variable_declaration
                fields:
                  text: Node var = IR.var(name);
                children: []
                pos: 5889
                length: 24
              - type: local_variable_declaration
                fields:
                  text: JSDocInfoBuilder builder = new JSDocInfoBuilder(false);
                children: []
                pos: 5999
                length: 55
              - type: expression_statement
                fields:
                  text: builder.recordNoAlias();
                children: []
                pos: 6059
                length: 24
              - type: expression_statement
                fields:
                  text: var.setJSDocInfo(builder.build(var));
                children: []
                pos: 6088
                length: 37
              - type: local_variable_declaration
                fields:
                  text: CompilerInput input = compiler.getSynthesizedExternsInput();
                children: []
                pos: 6130
                length: 60
              - type: expression_statement
                fields:
                  text: input.getAstRoot(compiler).addChildrenToBack(var);
                children: []
                pos: 6195
                length: 50
              - type: expression_statement
                fields:
                  text: compiler.reportCodeChange();
                children: []
                pos: 6250
                length: 28
              pos: 5790
              length: 492
          children: []
          pos: 5765
          length: 517
        - type: class_declaration
          fields:
            name:
              type: identifier
              fields:
                text: StripProtection
              children: []
              pos: 6351
              length: 15
            body:
              type: class_body
              fields: {}
              children:
              - type: field_declaration
                fields:
                  text: private final AbstractCompiler compiler;
                children: []
                pos: 6432
                length: 40
              - type: constructor_declaration
                fields:
                  text: |-
                    StripProtection(AbstractCompiler compiler) {
                          this.compiler = compiler;
                        }
                children: []
                pos: 6478
                length: 82
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: process
                    children: []
                    pos: 6592
                    length: 7
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: Node externs
                      children: []
                      pos: 6600
                      length: 12
                    pos: 6566
                    length: 118
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: expression_statement
                      fields:
                        text: NodeTraversal.traverse(compiler, root, this);
                      children: []
                      pos: 6633
                      length: 45
                    pos: 6625
                    length: 59
                children: []
                pos: 6566
                length: 118
              - type: method_declaration
                fields:
                  name:
                    type: identifier
                    fields:
                      text: visit
                    children: []
                    pos: 6716
                    length: 5
                  parameters:
                    type: method_parameters
                    fields: {}
                    children:
                    - type: formal_parameter
                      fields:
                        text: NodeTraversal t
                      children: []
                      pos: 6722
                      length: 15
                    pos: 6690
                    length: 465
                  body:
                    type: block
                    fields: {}
                    children:
                    - type: if_statement
                      fields:
                        condition:
                          type: parenthesized_expression
                          fields:
                            expression:
                              type: method_invocation
                              fields:
                                text: n.isCall()
                              children: []
                              pos: 6772
                              length: 10
                          children: []
                          pos: 6771
                          length: 12
                      children:
                      - type: block
                        fields: {}
                        children:
                        - type: local_variable_declaration
                          fields:
                            text: Node target = n.getFirstChild();
                          children: []
                          pos: 6794
                          length: 32
                        - type: if_statement
                          fields:
                            condition:
                              type: parenthesized_expression
                              fields:
                                expression:
                                  type: and
                                  fields:
                                    left:
                                      type: method_invocation
                                      fields:
                                        text: target.isName()
                                      children: []
                                      pos: 6960
                                      length: 15
                                    right:
                                      type: method_invocation
                                      fields:
                                        text: target.getString().equals(PROTECTOR_FN)
                                      children: []
                                      pos: 6979
                                      length: 39
                                  children: []
                                  pos: 6960
                                  length: 58
                              children: []
                              pos: 6959
                              length: 60
                          children:
                          - type: block
                            fields: {}
                            children:
                            - type: local_variable_declaration
                              fields:
                                text: Node expr = n.getLastChild();
                              children: []
                              pos: 7032
                              length: 29
                            - type: expression_statement
                              fields:
                                text: n.detachChildren();
                              children: []
                              pos: 7072
                              length: 19
                            - type: expression_statement
                              fields:
                                text: parent.replaceChild(n, expr);
                              children: []
                              pos: 7102
                              length: 29
                            pos: 7020
                            length: 121
                          pos: 6956
                          length: 185
                        pos: 6784
                        length: 365
                      pos: 6768
                      length: 381
                    pos: 6760
                    length: 395
                children: []
                pos: 6690
                length: 465
              pos: 6338
              length: 821
          children: []
          pos: 6338
          length: 821
        pos: 1332
        length: 5829
    children: []
    pos: 1332
    length: 5829
  pos: 0
  length: 7162
text_diff: "--- before\n+++ after\n@@ -98,7 +98,7 @@\n     // Do not try to remove
  a block or an expr result. We already handle\n     // these cases when we visit
  the child, and the peephole passes will\n     // fix up the tree in more clever
  ways when these are removed.\n-    if (n.isExprResult() || n.isBlock()) {\n+    if
  (n.isExprResult()) {\n       return;\n     }\n \n@@ -110,7 +110,24 @@\n \n     boolean
  isResultUsed = NodeUtil.isExpressionResultUsed(n);\n     boolean isSimpleOp = NodeUtil.isSimpleOperatorType(n.getType());\n-
  \   if (!isResultUsed &&\n+    if (parent.getType() == Token.COMMA) {\n+      if
  (isResultUsed) {\n+        return;\n+      }\n+      if (n == parent.getLastChild())
  {\n+        for (Node an : parent.getAncestors()) {\n+          int ancestorType
  = an.getType();\n+          if (ancestorType == Token.COMMA) continue;\n+          if
  (ancestorType != Token.EXPR_RESULT && ancestorType != Token.BLOCK) return;\n+          else
  break;\n+        }\n+      }\n+    } else if (parent.getType() != Token.EXPR_RESULT
  && parent.getType() != Token.BLOCK) {\n+      if (! (parent.getType() == Token.FOR
  && parent.getChildCount() == 4 && (n == parent.getFirstChild() || n == parent.getFirstChild().getNext().getNext())))
  {\n+        return;\n+      }\n+    }\n+    if (\n         (isSimpleOp || !NodeUtil.mayHaveSideEffects(n,
  t.getCompiler()))) {\n       String msg = \"This code lacks side-effects. Is there
  a bug?\";\n       if (n.isString()) {\n"
tree_diff: |+
  New cluster:
  Unknown cluster type
  ------------
  ===
  insert-tree
  ---
  if_statement [3705,4388]
      parenthesized_expression [3708,3741]
          equals [3709,3740]
              method_invocation: parent.getType() [3709,3725]
              field_access: Token.COMMA [3729,3740]
      block [3742,4111]
          if_statement [3750,3793]
              parenthesized_expression [3753,3767]
                  identifier: isResultUsed [3754,3766]
              block [3768,3793]
                  return_statement: return; [3778,3785]
          if_statement [3800,4105]
              parenthesized_expression [3803,3831]
                  equals [3804,3830]
                      identifier: n [3804,3805]
                      method_invocation: parent.getLastChild() [3809,3830]
              block [3832,4105]
                  enhanced_for_statement: for (Node an : parent.getAncestors()) {
            int ancestorType = an.getType();
            if (ancestorType == Token.COMMA) continue;
            if (ancestorType != Token.EXPR_RESULT && ancestorType != Token.BLOCK) return;
            else break;
          } [3842,4097]
  to
  block [2719,4427]
  at 6

  New cluster:
  ===
  insert-node
  ---
  method_invocation: n.isExprResult() [3305,3321]
  to
  parenthesized_expression [3304,3337]
  at 0
  ------------
  ===
  insert-node
  ---
  method_invocation: n.isExprResult() [3305,3321]
  to
  parenthesized_expression [3304,3337]
  at 0

  New cluster:
  MOVE from parenthesized_expression [3723,3814]
  ------------
  ===
  move-tree
  ---
  parenthesized_expression [3749,3813]
      or [3750,3812]
          identifier: isSimpleOp [3750,3760]
          unary_expression: !NodeUtil.mayHaveSideEffects(n, t.getCompiler()) [3764,3812]
  to
  parenthesized_expression [3723,3814]
  at 0

  New cluster:
  Unknown cluster type
  ------------
  ===
  delete-tree
  ---
  or [3305,3336]
      method_invocation: n.isExprResult() [3305,3321]
      method_invocation: n.isBlock() [3325,3336]

  New cluster:
  ===
  delete-node
  ---
  and [3724,3813]
  ===
  ------------
  ===
  delete-node
  ---
  unary_expression: !isResultUsed [3724,3737]
  ===
  ===
  delete-node
  ---
  and [3724,3813]
  ===

...
